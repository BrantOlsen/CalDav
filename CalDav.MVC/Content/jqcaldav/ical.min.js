function guid(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,n=e=="x"?t:t&3|8;return n.toString(16)}).toUpperCase()}var iCal=function(e){this.prototype=Array.prototype,this.icsTemplateVevent="BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//jqCalDav\nCALSCALE:GREGORIAN\nBEGIN:VEVENT\nSUMMARY:"+ui["New Event"]+"\nDTEND:19700101\nTRANSP:TRANSPARENT\nDTSTART:19700101\nDTSTAMP:19700101T000000Z\nSEQUENCE:0\nEND:VEVENT\nEND:VCALENDAR",this.icsTemplateVtodo="BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//jqCalDav\nCALSCALE:GREGORIAN\nBEGIN:VTODO\nSUMMARY:"+ui["New Todo"]+"\nDTEND;VA\nTRANSP:TRANSPARENT\nDTSTAMP:19700101T000000Z\nSEQUENCE:0\nDUE;VALUE=DATE:19700101\nSTATUS:NEEDS-ACTION\nEND:VTODO\nEND:VCALENDAR",this.icsTemplateVjournal="BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//jqCalDav\nCALSCALE:GREGORIAN\nBEGIN:VJOURNAL\nSUMMARY:"+ui["New Journal"]+"\nDTSTAMP:19700101T000000Z\nSEQUENCE:0\nEND:VJOURNAL\nEND:VCALENDAR",this.icsTemplateVfreebusy="BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//jqCalDav\nMETHOD:REQUEST\nBEGIN:VFREEBUSY\nDTSTAMP:19700101T000000Z\nDTSTART:19700101T000000Z\nDTEND:19700101T000000Z\nEND:VFREEBUSY\nEND:VCALENDAR",this.components={vcalendar:{required:["version","prodid",["vevent","vtodo","vjournal","vfreebusy"]],optional:["calscale","method","vtimezone"]},vevent:{required:["dtstamp","uid","dtstart"],optional:["dtend","duration","class","created","description","geo","last-modified","location","organizer","priority","sequence","status","summary","transp","url","recurrence-id","attach","attendee","categories","comment","contact","exdate","request-status","related-to","resources","rdate","rrule","request-status"]},vtodo:{required:["dtstamp","uid"],optional:["dtstart","due","class","completed","created","description","geo","last-modified","location","organizer","percent-complete","priority","sequence","status","summary","url","recurrence-id","attach","attendee","categories","comment","contact","exdate","request-status","related-to","resources","rdate","rrule","request-status"]},vjournal:{required:["dtstamp","uid"],optional:["dtstart","class","created","description","last-modified","organizer","sequence","status","summary","url","recurrence-id","attach","attendee","categories","comment","contact","exdate","request-status","related-to","resources","rdate","rrule","request-status"]},vfreebusy:{required:["dtstamp","uid"],optional:["contact","dtstart","dtend","organizer","url","attendee","comment","freebusy","request-status"]},valarm:{required:["action","trigger"],optional:["description","duration","repeat","attach","summary",,"attendee"]},vtimezone:{required:["tzid","dtstart","tzoffsetto","tzoffsetfrom"],optional:["last-modified","tzurl","standard","daylight","tzname","comment","rdate"]},daylight:{required:["dtstart","tzoffsetto","tzoffsetfrom"],optional:["last-modified","tzurl","tzname","comment","rdate","rrule"]},standard:{required:["dtstart","tzoffsetto","tzoffsetfrom"],optional:["last-modified","tzurl","tzname","comment","rdate","rrule"]}},this.fields={version:{max:1,visible:!1,type:"text","default":"2.0"},prodid:{max:1,visible:!1,type:"text","default":"-//jqCalDav"},calscale:{max:1,visible:!1,type:"text","default":"GREGORIAN"},summary:{max:1,visible:!0,type:"text"},dtstart:{max:1,visible:!0,type:"date","default":(new Date).DateString()},dtend:{max:1,visible:!0,type:"date"},duration:{max:1,visible:!0,type:"duration"},rrule:{max:1,visible:!0,type:"recurrence"},"recurrence-id":{max:1,visible:!1,type:"date"},transp:{max:1,visible:!0,type:"text",values:{vevent:["TRANSPARENT","OPAQUE"]},"default":"TRANSPARENT"},due:{max:1,visible:!0,type:"date"},completed:{max:1,visible:!0,type:"date"},status:{max:1,visible:!0,type:"text",values:{vevent:["TENTATIVE","CONFIRMED","CANCELLED"],vtodo:["NEEDS-ACTION","COMPLETED","CANCELLED","IN-PROCESS"],vjournal:["DRAFT","FINAL","CANCELLED"]}},priority:{max:1,visible:!0,type:"integer",range:{vevent:[0,9],vtodo:[0,9]}},"percent-complete":{max:1,visible:!0,type:"integer",range:{vtodo:[0,100]}},location:{max:1,visible:!0,type:"text"},geo:{max:1,visible:!0,type:"latlon"},description:{max:1,visible:!0,type:"text"},"class":{max:1,visible:!0,type:"text",values:{vevent:["PUBLIC","PRIVATE","CONFIDENTIAL"],vtodo:["PUBLIC","PRIVATE","CONFIDENTIAL"],vjournal:["PUBLIC","PRIVATE","CONFIDENTIAL"]}},attach:{max:-1,visible:!0,type:"text"},method:{max:1,visible:!1,type:"text"},tzid:{max:1,visible:!1,type:"text"},tzoffsetfrom:{max:1,visible:!1,type:"utc-offset"},tzoffsetto:{max:1,visible:!1,type:"utc-offset"},tzurl:{max:1,visible:!1,type:"uri"},organizer:{max:1,visible:!0,type:"schedule"},url:{max:1,visible:!0,type:"uri"},uid:{max:1,visible:!1,type:"text"},action:{max:1,visible:!1,type:"text"},repeat:{max:1,visible:!1,type:"integer"},trigger:{max:1,visible:!1,type:"trigger"},created:{max:1,visible:!1,type:"date"},dtstamp:{max:1,visible:!1,type:"date"},"last-modified":{max:1,visible:!1,type:"date"},sequence:{max:1,visible:!1,type:"integer","default":0},rdate:{max:-1,visible:!0,type:"rdate"},freebusy:{max:-1,visible:!1,type:"period"},comment:{max:-1,visible:!0,type:"text"},resources:{max:-1,visible:!0,type:"text"},categories:{max:-1,visible:!0,type:"text"},attendee:{max:-1,visible:!0,type:"schedule"},contact:{max:-1,visible:!0,type:"text"},exdate:{max:-1,visible:!1,type:"date"},tzname:{max:-1,visible:!1,type:"text"},link:{max:-1,visible:!0,type:"uri"},"related-to":{max:-1,visible:!1,type:"text"},"request-status":{max:-1,visible:!1,type:"text"},"x-calendarserver-private-comment":{max:-1,visible:!0,type:"text"},"x-calendarserver-access":{max:1,visible:!0,type:"text",values:{vevent:["PUBLIC","PRIVATE","CONFIDENTIAL","RESTRICTED"],vtodo:["PUBLIC","PRIVATE","CONFIDENTIAL","RESTRICTED"],vjournal:["PUBLIC","PRIVATE","CONFIDENTIAL","RESTRICTED"]}}},this.parseiCal=function(e){var t=/([0-9]{4})([0-9]{2})([0-9]{2})([Tt]([0-2][0-9])([0-6][0-9])([0-9]{2}))?[Zz]?/,n=/(VEVENT|VTODO|VJOURNAL|VFREEBUSY)/,r=e.replace(/\r?\n[\s\t]/mg,"").split("\n"),i=new Array,s=new Object;s.RAW=e,s.propertyIsEnumerable("RAW",!1);var o=s,u=new Array;u.push(o);for(var a=0;a<r.length;a++){var f=r[a].match(/^((?:'[^']*')|(?:[^:]+)):(.*)/m);if(f==null)continue;f=f.slice(1);var l=f[1].replace(/\\(,|;)/g,"$1");f[1]=l.replace(/\\[Nn]/g,"\n"),l0l=f[0].toLowerCase();if(f[0]=="BEGIN"){var c=o;u.push(o);var o=new Object;o.BEGIN=!0,o.propertyIsEnumerable("BEGIN",!1),c[f[1].toLowerCase()]!=undefined&&!n.test(f[1])?(typeof c[f[1].toLowerCase()]!="array"&&(c[f[1].toLowerCase()]=new Array($.extend({},c[f[1].toLowerCase()]))),c[f[1].toLowerCase()].push(o)):c[f[1].toLowerCase()]=o;continue}if(f[0]=="END"){o.UPDATED=!1,n.test(f[1])?(i.push($.extend(!0,{},s)),i[i.length-1].TYPE=f[1].toLowerCase()):f[1].toLowerCase()=="vtimezone"&&(this.tz=new zones(o));var o=u.pop();continue}if(f[0]=="RRULE")o[l0l]=this.newField(l0l,f[1]);else if(f[0].match(/;/)){var l=new Object,h=f[0].split(";");l0l=h[0].toLowerCase();for(var p=1;p<h.length;p++){var d=h[p].split("=");l[d[0].toLowerCase()]=d.slice(1).join()}o[l0l]!=undefined?o[l0l].UPDATE(f[1],l):o[l0l]=this.newField(l0l,f[1],l)}else o[l0l]!=undefined?o[l0l].UPDATE(f[1]):o[l0l]=this.newField(l0l,f[1]);o[l0l].PARENT=o}return i},this.printiCal=function(e){this.parts={VTIMEZONE:[],VEVENT:[],VTODO:[],VJOURNAL:[]},this.depth=0;var t=this.print(this.ics,e);for(var n in this.parts)for(var r in this.parts[n])t+=this.parts[n][r];return t+="END:VCALENDAR\n",debug&&console.log(t),t},this.print=function(e,t){t!=null&&(this.timezones=t);var n=/(VEVENT|VTODO|VJOURNAL)/,r="",i={};for(var s in e){var o="";if(s-0==s){r+=this.print(e[s],!1);continue}if(s==s.toUpperCase())continue;if(e[s]instanceof Object)if(e[s].BEGIN||e[s].SERIALIZE==undefined){e[s].UPDATED&&(e[s].sequence&&e[s].sequence.VALUE++,e[s].dtstamp&&e[s].dtstamp.UPDATE(new Date)),o="BEGIN:"+s.toUpperCase()+"\n";if(s=="vtimezone"||t)o+=this.print(e[s],!0);else if(e[s]instanceof Array)for(var u=0;u<e[s].length;u++)o+=this.print(e[s][u],!1),u+1<e[s].length&&(o+="END:"+s.toUpperCase()+"\n",o+="BEGIN:"+s.toUpperCase()+"\n");else o+=this.print(e[s],!1);var a="END:"+s.toUpperCase()+"\n";s!="vcalendar"?o+=a:this.depth++,n.test(s.toUpperCase())?(this.parts[s.toUpperCase()].push(o),o=""):this.depth>1&&(o="")}else{if(this.fields[s]!=undefined&&this.fields[s].max>0&&i[s]>=this.fields[s].max)continue;i[s]++,o=e[s].SERIALIZE()}else{if(s==s.toUpperCase())continue;if(this.fields[s].max>0&&i[s]>this.fields[s].max)continue;switch(s){case"dtstamp":o="DTSTAMP:"+(new Date).DateString()+"\n";break;case"sequence":o="SEQUENCE:"+e[s].VALUE+1+"\n";break;default:o=s.toUpperCase()+":"+e[s]+"\n"}i[s]++;if(o.length>72)for(var f=72;f<o.length;f+=72)o=o.slice(0,f)+"\n "+o.slice(f)}r+=o}return r},this.toString=this.printiCal,this.pop=function(){return this.ics.pop()},this.push=function(e){return this.ics.push(e)},this.reverse=function(){return this.ics.reverse()},this.shift=function(){return this.ics.shift()},this.splice=function(e){return this.ics.splice(e)},this.unshift=function(e){return this.ics.unshift(e)},this.slice=function(e,t){return this.ics.slice(e,t)},this.pop=function(){return this.ics.pop()},this.UPDATEx=function(){this.dateValues=function(e){if(e.getDate)return{DATE:e,VALUE:e.DateString()};if(String(e).match(/\s/)){var t=Zero().parsePrettyDate(e);return{DATE:t,VALUE:t.DateString()}}return{DATE:Zero().parseDate(e),VALUE:e}},this.SETDATE=function(){if(arguments[1]instanceof Object){var e=arguments[1];arguments[2]!=undefined&&(p=arguments[2])}else arguments.length>1&&(p=arguments[1]);var t=this.dateValues(arguments[0]);if(this.VALUES){this.DATES==undefined&&(this.DATES=new Array,this.VALUES.push(this.VALUE),this.DATES.push(this.DATE),this.PROPS={},e&&(this.PROPS[this.DATE]=e));if(p){var n=this.DATES.indexOf(p)?this.DATES.indexOf(p):this.VALUES.indexOf(p);n<0&&(n=this.VALUES.length),this.VALUES[n]=t.VALUE,this.DATES[n]=t.DATE,this.PROPS[p]&&(this.PROPS[t.DATE]=this.PROPS[p],delete this.PROPS[p])}else e?(typeof e=="object"&&e["TZID"]==undefined&&(t.DATE.zulu=!0),this.PROPS[t.DATE]=e):t.DATE.zulu=!0,this.VALUES.push(t.VALUE),this.DATES.push(t.DATE)}else this.DATE=t.DATE,this.VALUE=t.VALUE,e?(this.PROP=e,typeof e=="object"&&e["TZID"]==undefined&&(this.DATE.zulu=!0)):this.DATE.zulu=!0,this.FIELD=="due"&&this.PROP["value"]!=undefined&&(this.SHORT=!0,this.DATE.zulu=!1,this.DATE.ZeroTime())},this.PERIOD=function(){var e=/^([0-9]{4})([0-9]{2})([0-9]{2})([Tt]([0-2][0-9])([0-6][0-9])([0-9]{2}))?([Zz])?$/,t=/([-+])?P([0-9]+W)?([0-9]+D)?(T([0-9]+H)?([0-9]+M)?([0-9]+S)?)?/;if(arguments[1]instanceof Object){var n=arguments[1];arguments[2]!=undefined&&(p=arguments[2])}else arguments.length>1&&(p=arguments[1]);if(typeof p=="object"&&p.type)var r=p.type;else var r="BUSY";this.DATA==undefined&&(this.DATA={}),this.DATA[r]==undefined&&(this.DATA[r]=[]),this.FB==undefined?(this.FB={},this.FB[r]={}):this.FB[r]==undefined&&(this.FB[r]={});var i=String(arguments[0]).split(",");for(var s=0;s<i.length;s++){var o=i[s].split("/"),u=Zero().parseDate(o[0]),a;if(e.test(o[1])){a=Zero().parseDate(o[1]);if(u>a){debug&&console.log("negative time period found parsing: "+arguments[0]);continue}}else if(t.test(o[1])){var f=parseDuration(o[1]);if(f.negative){debug&&console.log("negative time period found parsing: "+arguments[0]);continue}a=new Date(u.getTime()),a.addDuration(f)}var l=a.getTime()-u.getTime(),c={type:r,start:u,end:a,length:l};if(this.FB[r][u.getTime()]&&this.FB[r][u.getTime()].length==l)continue;this.FB[r][u.getTime()]=c,this.DATA[r].push(c)}},this.SETDURATION=function(e,t){if(e.valid==undefined)var n=e,r=parseDuration(e);else var n=printDuration(e),r=e;if(arguments.length>1)var i=arguments[1];if(this.VALUES)i==undefined&&(i=null),this.PROPS==undefined&&(this.PROPS=new Array,this.PROPS.push(this.PROP!=undefined?this.PROP:null)),this.DURATIONS==undefined&&(this.DURATIONS=new Array,this.DURATIONS.push(this.DURATION!=undefined?this.DURATION:null)),t&&this.VALUES.indexOf(t)?(this.DURATIONS[this.VALUES.indexOf(t)]=r,this.VALUES[this.VALUES.indexOf(t)]=n,this.PROPS[this.VALUES.indexOf(t)]=i):(this.DURATIONS.push(r),this.VALUES.push(n),this.PROPS.push(i));else{if(this.FIELDS&&this.FIELDS.values)for(var s in valueNames)e==valueNames[s]&&(e=s);this.DURATION=r,this.VALUE=n,i!=undefined&&(this.PROP=i)}},this.UTCOFFSET=function(e){e=e.replace(/\\([\\.,;:])/g,"$1");if(arguments[1]instanceof Object){var t=arguments[1];arguments[2]!=undefined?p=arguments[2]:p=t}else if(arguments.length>1)var t=arguments[1];t&&(this.PROP=t),this.VALUE=e},this.TRIGGER=function(e){var t=/^([0-9]{4})([0-9]{2})([0-9]{2})([Tt]([0-2][0-9])([0-6][0-9])([0-9]{2}))?([Zz])?$/;e instanceof Date||t.test(e)?this.SETDATE.apply(this,arguments):this.SETDURATION.apply(this,arguments)},this.SETRECURRENCE=function(e){this.RECURRENCE==undefined&&(this.RECURRENCE=new recurrence),String(e).match(/\s/)?(this.RECURRENCE.parsePrettyRecurrence(e),this.VALUE=this.RECURRENCE.unparseRecurrence()):(this.VALUE=e,this.RECURRENCE.parseRecurrence(e))},this.TEXT=function(e,t){e=e.replace(/\\([\\.,;:])/g,"$1");if(arguments[1]instanceof Object){var n=arguments[1];arguments[2]!=undefined?t=arguments[2]:t=n}else if(arguments.length>1)var n=arguments[1];if(this.VALUES)n==undefined&&(n=null),this.PROPS==undefined&&(this.PROPS=new Array,this.PROPS.push(this.PROP!=undefined?this.PROP:null)),this.VALUES.length==0&&(this.VALUES.push(this.VALUE),this.VALUES.push(e),this.PROPS.push(n)),t&&this.VALUES.indexOf(t)>-1?(this.VALUES[this.VALUES.indexOf(t)]=e,this.PROPS[this.VALUES.indexOf(t)]=n):(this.VALUES.push(e),this.PROPS.push(n));else{if(this.FIELDS&&this.FIELDS.values)for(var r in valueNames)e==valueNames[r]&&(e=r);this.VALUE=e,n!=undefined&&(this.PROP=n)}},this.SCHEDULE=function(e,t){e=e.replace(/\\([\\.,;:])/g,"$1");if(arguments[1]instanceof Object){var n=arguments[1];arguments[2]!=undefined?t=arguments[2]:t=n}else if(arguments.length>1)var n=arguments[1];if(this.VALUES)n==undefined&&(n=null),this.PROPS==undefined&&(this.PROPS=new Array,this.PROPS.push(this.PROP!=undefined?this.PROP:null)),this.VALUES.length==0?(this.VALUES.push(this.VALUE),this.VALUES.push(e),this.PROPS.push(n)):t&&this.VALUES.indexOf(t)>-1?(this.VALUES[this.VALUES.indexOf(t)]=e,this.PROPS[this.VALUES.indexOf(t)]=n):(this.VALUES.push(e),this.PROPS.push(n));else{if(this.FIELDS&&this.FIELDS.values)for(var r in valueNames)e==valueNames[r]&&(e=r);this.VALUE=e,n!=undefined&&(this.PROP=n)}},this.INTEGER=function(e){this.VALUE=Number(e)},this.SEQUENCE=function(){this.VALUE=Number(this.VALUE)+1},this.PRINT={integer:function(){return this.VALUE},number:function(){return this.VALUE},sequence:function(){return this.VALUE},uri:function(){if(arguments.length>0&&this.VALUES&&this.VALUES.length>1)var e=this.VALUES[arguments[0]];else var e=this.VALUE;valueNames[e]&&(e=valueNames[e]);if(e!=undefined)return e.replace(/\\[Nn]/g,"\n")},"utc-offset":function(){var e=this.VALUE;if(e!=undefined)return e},text:function(){if(arguments.length>0&&this.VALUES&&this.VALUES.length>1)var e=this.VALUES[arguments[0]];else var e=this.VALUE;valueNames[e]&&(e=valueNames[e]);if(e!=undefined)return e.replace(/\\[Nn]/g,"\n")},period:function(){if(arguments.length>0&&this.VALUES&&this.VALUES.length>1)var e=this.VALUES[arguments[0]];else var e=this.VALUE;valueNames[e]&&(e=valueNames[e]);if(e!=undefined)return e.replace(/\\[Nn]/g,"\n")},schedule:function(){if(this.FIELD=="organizer"&&this.PROP&&this.PROP.cn&&this.PROP["cn"]!="")return String(this.PROP.cn).replace(/['"<>]/g,"");if(arguments.length>0&&this.VALUES&&this.VALUES.length>1)var e=String(this.VALUES[arguments[0]]);else var e=String(this.VALUE);if(valueNames[e])var e=String(valueNames[e]);if(e!=undefined)return e.replace(/\\[Nn]/g,"\n")},date:function(){if(this.PROPS&&this.PROPS.length>1){if(this.VALUES.indexOf(arguments[0]))var e=this.PROPS[this.VALUES.indexOf(arguments[0])];if(this.VALUES[arguments[0]])var e=this.PROPS[arguments[0]]}else var e=this.PROP;return e==undefined||e["TZID"]==undefined?this.DATE.zulu=!0:this.DATE.zulu=!1,this.FIELD=="due"&&this.PROP["value"]!=undefined?(this.SHORT=!0,this.DATE.prettyDate(!0)):arguments.length>0&&this.DATES.length>1?this.DATES[arguments[0]].prettyDate():this.DATE.prettyDate()},duration:function(){if(arguments.length>0&&this.VALUES&&this.VALUES.length>1)var e=this.VALUES[arguments[0]];else var e=this.VALUE;return e},trigger:function(){return this.DATE?this.PRINT.date.apply(this,arguments):this.PRINT.duration.apply(this,arguments)},recurrence:function(){if(arguments[0]!==!0)var e=!0;else var e=!1;return this.RECURRENCE==undefined?undefined:this.RECURRENCE.toString(e)},props:function(){var e="";if(arguments.length>0&&this.PROPS&&this.PROPS.length>1){if(this.VALUES.indexOf(arguments[0]))var t=this.PROPS[this.VALUES.indexOf(arguments[0])];if(this.VALUES[arguments[0]])var t=this.PROPS[arguments[0]]}else var t=this.PROP;if(typeof t!="object")return"";for(var n in t)n!=n.toUpperCase()&&(e+=";"+n.toUpperCase()+"="+this.ESCAPEPROP(t[n]));return e}},this.ESCAPEPROP=function(e){var t=e;return t=t.replace(/([^\\])([\\,;])/g,"$1\\$2"),/:/.test(t)&&(t='"'+t+'"'),t.replace(/\n/g,"\\n")},this.ESCAPE=function(e){var t=String(e);if(e==undefined)return;return t=t.replace(/([^\\])([\\,;])/g,"$1\\$2"),t.replace(/\n/g,"\\n")},this.SERIALIZE=function(){var e="";if(this.VALUES&&this.VALUES.length>0&&(this.FIELDS==undefined||this.FIELDS.max!=1))for(var t=0;t<this.VALUES.length;t++){line=this.FIELD.toUpperCase()+this.PRINT.props.apply(this,[t])+":";switch(this.type){case"period":break;case"date":this.PROPS[t]!=undefined&&this.PROPS[t]["tzid"]!=undefined?this.DATES[t].zulu=!1:this.DATES[t].zulu=!0,line=line+this.DATES[t].DateString()+"\n";break;case"recurrence":line=line+this.RECURRENCE.unparseRecurrence()+"\n";break;case"schedule":line=line+this.ESCAPE(this.VALUES[t])+"\n";break;case"text":line=line+this.ESCAPE(this.VALUES[t])+"\n";break;default:line=line+this.ESCAPE(this.PRINT[this.type].apply(this,[t]))+"\n"}if(line.length>72)for(var n=72;n<line.length;n+=72)line=line.slice(0,n)+"\n "+line.slice(n);e+=line}else{e=e+this.FIELD.toUpperCase()+this.PRINT.props.apply(this)+":";switch(this.type){case"period":break;case"date":this.FIELD.toLowerCase()=="due"||this.SHORT==1?this.PROP!=undefined&&this.PROP["value"]!=undefined?(this.DATE.zulu=!1,e=e+this.DATE.DayString()+"\n"):(this.DATE.zulu=!0,e=e+this.DATE.DateString()+"\n"):(this.PROP!=undefined&&this.PROP["tzid"]!=undefined||this.PARENT.tzname?this.DATE.zulu=!1:this.DATE.zulu=!0,e=e+this.DATE.DateString()+"\n");break;case"recurrence":e=e+this.RECURRENCE.unparseRecurrence()+"\n";break;case"schedule":e=e+this.ESCAPE(this.VALUE)+"\n";break;case"text":e=e+this.ESCAPE(this.VALUE)+"\n";break;default:e=e+this.ESCAPE(this.PRINT[this.type].apply(this))+"\n"}if(e.length>72)for(var n=72;n<e.length;n+=72)e=e.slice(0,n)+"\n "+e.slice(n)}return e},this.UPDATE=function(){switch(this.type){case"trigger":var e=this.TRIGGER;break;case"date":var e=this.SETDATE;break;case"duration":var e=this.SETDURATION;break;case"recurrence":var e=this.SETRECURRENCE;break;case"utc-offset":var e=this.UTCOFFSET;break;case"schedule":var e=this.SCHEDULE;break;case"period":var e=this.PERIOD;break;case"integer":case"number":var e=this.INTEGER;break;default:var e=this.TEXT}this.FIELDS&&this.VALUES==undefined&&this.FIELDS.max!=1&&this.VALUE?(this.VALUES=new Array,e.apply(this,arguments)):e.apply(this,arguments),this.VALUES?this.length=this.VALUES.length:this.length=1,this.propertyIsEnumerable("length",!1),this.PARENT!=undefined&&(this.PARENT.UPDATED=!0)};if(!this.type&&arguments.length<2)return;return arguments.length==1&&typeof arguments[0]=="boolean"?this.toString(arguments[0]):this[this.type.toUpperCase()](arguments)},this.newField=function(){var e=Array.prototype.slice.call(arguments),t=e.shift(),n=new this.UPDATEx;return t&&this.fields[t.toLowerCase()]?(n.type=this.fields[t.toLowerCase()].type,n.FIELDS=this.fields[t.toLowerCase()],n.propertyIsEnumerable("FIELDS",!1)):n.type="text",n.FIELD=t,n.PRINT[n.type]!=undefined?n.toString=n.PRINT[n.type]:n.toString=n.PRINT.text,n.propertyIsEnumerable("type",!1),n.propertyIsEnumerable("FIELD",!1),e.length>0&&n.UPDATE(e[0],e[1],e[2],e[3]),n},!e||e=="vevent"?e=this.icsTemplateVevent:e=="vtodo"?e=this.icsTemplateVtodo:e=="vjournal"&&(e=this.icsTemplateVjournal),this.ics=this.parseiCal(e),this.length=this.ics.length,this.index={},this.recurrence=[];for(var t in this.ics)this.ics[t].PARENT=this,this.ics[t].INDEX=t,this.ics[t].DELETE=function(){this.PARENT.length--,delete this.PARENT.ics[this.INDEX]},this.ics[t].TYPE=="vevent"&&(this.ics[t].vcalendar.vevent.rrule!=undefined?this.recurrence.push(this.ics[t]):(this.index[this.ics[t].vcalendar.vevent.dtstart.DATE.YM()]==undefined&&(this.index[this.ics[t].vcalendar.vevent.dtstart.DATE.YM()]=[]),this.index[this.ics[t].vcalendar.vevent.dtstart.DATE.YM()].push(this.ics[t])));return this},recurrence=function(e){return this.rrule_expansion={YEARLY:{type:"y",BYMONTH:"expand",BYWEEKNO:"expand",BYYEARDAY:"expand",BYMONTHDAY:"expand",BYDAY:"expand",BYHOUR:"expand",BYMINUTE:"expand",BYSECOND:"expand"},MONTHLY:{type:"m",BYMONTH:"limit",BYMONTHDAY:"expand",BYDAY:"expand",BYHOUR:"expand",BYMINUTE:"expand",BYSECOND:"expand"},WEEKLY:{type:"W",BYMONTH:"limit",BYDAY:"expand",BYHOUR:"expand",BYMINUTE:"expand",BYSECOND:"expand"},DAILY:{type:"d",BYMONTH:"limit",BYMONTHDAY:"limit",BYDAY:"limit",BYHOUR:"expand",BYMINUTE:"expand",BYSECOND:"expand"},HOURLY:{type:"h",BYMONTH:"limit",BYMONTHDAY:"limit",BYDAY:"limit",BYHOUR:"limit",BYMINUTE:"expand",BYSECOND:"expand"},MINUTELY:{type:"M",BYMONTH:"limit",BYMONTHDAY:"limit",BYDAY:"limit",BYHOUR:"limit",BYMINUTE:"limit",BYSECOND:"expand"},SECONDLY:{type:"s",BYMONTH:"limit",BYMONTHDAY:"limit",BYDAY:"limit",BYHOUR:"limit",BYMINUTE:"limit",BYSECOND:"limit"}},this.editRecurrence=function(){var e=["SU","MO","TU","WE","TH","FR","SA"],t={SU:"Sunday",MO:"Monday",TU:"Tuesday",WE:"Wednesday",TH:"Thursday",FR:"Friday",SA:"Saturday"};if(this.rule==undefined)return!1;var n=this.rule,r=n.FREQ.replace(/LY$/,""),i="";typeof n["INTERVAL"]!="undefined"&&n.INTERVAL!=1&&(i=n.INTERVAL),r='<span class="recurrence"><span class="repeat" contenteditable="true" text="'+recurrenceUI.every+' ">'+i+'</span><span class="every" contenteditable="true">'+recurrenceUI[r]+"</span>",n.COUNT?r=r+'<span class="foruntil" contenteditable="true">'+recurrenceUI["for"]+'</span><span class="value" data-value="'+Number(n.COUNT).toLocaleString()+" "+recurrenceUI["time"+(n.COUNT>1?"s":"")]+'" contenteditable="true">'+Number(n.COUNT).toLocaleString()+" "+recurrenceUI["time"+(n.COUNT>1?"s":"")]+"</span>":n.UNTIL?r=r+'<span class="foruntil" contenteditable="true">'+recurrenceUI.until+'</span><span class="value" data-value="'+n.UNTIL.prettyDate()+'" contenteditable="true">'+n.UNTIL.prettyDate()+"</span>":r=r+'<span class="foruntil" contenteditable="true">'+valueNames.NONE+'</span><span class="value" contenteditable="true"></span>',r+="</span>";var r=$(r);return $(r).append(this.printSections(n.FREQ)),$(r).data("rule",this),$(".every",r).bind("focus",function(e){var t=["YEAR","MONTH","WEEK","DAI","HOUR","MINUTE","SECOND"],n=buildOptions({target:e.target,options:t,text:recurrenceUI,none:!0,spaceSelects:!0,search:!1,removeOnEscape:!1,callback:function(e){for(var t in recurrenceUI)if(recurrenceUI[t]==$(e).text())break;var n=t,r=$(e).parent().data("rule").printSections(n+"LY");$(e).parent().children(".byrule").replaceWith($(r))}});popupOverflowVisi(),$(e.target).prev().hasClass("completionWrapper")||$(e.target).before(n)}),$(".foruntil",r).bind("focus",function(e){$(e.target).data("value",$(e.target).next().text());var t=buildOptions({target:e.target,options:["for","until"],text:recurrenceUI,none:!0,spaceSelects:!0,search:!1,removeOnEscape:!0,callback:function(e){if($(e).text()=="")return $(e).text(valueNames.NONE).next().empty();if($(e).text()==recurrenceUI["for"])var t=new RegExp(recurrenceUI.time),n=Number(1).toLocaleString()+" "+recurrenceUI.time;if($(e).text()==recurrenceUI["until"])var t=/([0-9]{1,2})\/([0-9]{1,2})\/([0-9]{4})\s*(([0-2]?[0-9]):?([0-6][0-9])?:?([0-6][0-9])?\s*([AP]M)?)?/i,r=$($($("#wcal").data("popup")).data("event")).attr("instance"),n=Zero().parseDate(r).prettyDate();t.test($(e).next().data("value"))?$(e).next().data("value")!=$(e).next().text()&&$(e).next().text($(e).next().data("value")):$(e).next().text(n)}});popupOverflowVisi(),$(e.target).before(t)}),$(r).bind("focusin focusout",function(){$(this).toggleClass("focus")}),r},this.printSections=function(e){var t=this.rule,n="";for(var r in this.rrule_expansion[e]){if(r=="type")continue;var i=String(r).replace(/BY/,"");i=="DAY"&&(i="DAI"),n=n+'<div class="byrule"><span class="label '+String(r).toLowerCase()+'" expand="'+this.rrule_expansion[e][r]+'" >'+recurrenceUI[i]+'</span><span class="value" contenteditable="true">';var s="";if(t[r]!=undefined){var o=t[r];if(o.length==undefined)continue;for(var u=0;u<o.length;u++)s=s+(u>0?ui.listSeparator+" ":"")+this.printByValue(r,o[u])}n=n+s+"</span></div>"}var n=$(n);return $(".bymonth + .value",n).bind("focus",function(e){var t=[0,1,2,3,4,5,6,7,8,9,10,11],n=buildOptions({target:e.target,options:t,text:months,none:!0,spaceSelects:!0,search:!0,removeOnEscape:!0,multiselect:ui.listSeparator+" "});popupOverflowVisi(),$(e.target).prev().hasClass("completionWrapper")||$(e.target).before(n)}),$(".byday + .value",n).bind("focus",function(e){var t=[0,1,2,3,4,5,6],n=buildOptions({target:e.target,options:t,text:weekdays,none:!0,spaceSelects:!0,search:!0,removeOnEscape:!0,multiselect:ui.listSeparator+" "});popupOverflowVisi(),$(e.target).prev().hasClass("completionWrapper")||$(e.target).before(n)}),n},this.printByValue=function(e,t){var n={SU:0,MO:1,TU:2,WE:3,TH:4,FR:5,SA:6};switch(e){case"BYMONTH":return months[t-1];case"BYDAY":var r=String(t).match(/([-+]?[0-9]+)?([a-zA-Z]{2})/),i="";return r[1]!=undefined&&(i=recurrenceUI["position"+(Number(r[1])+6)]),i+" "+weekdays[n[r[2]]];case"BYWEEKNO":case"BYYEARDAY":case"BYMONTHDAY":case"BYHOUR":case"BYMINUTE":case"BYSECOND":return t}},this.prettyRecurrence=function(){var e=["SU","MO","TU","WE","TH","FR","SA"],t={SU:"Sunday",MO:"Monday",TU:"Tuesday",WE:"Wednesday",TH:"Thursday",FR:"Friday",SA:"Saturday"};if(this.rule==undefined)return!1;var n=this.rule,r=n.FREQ.replace(/LY$/,"");return r=recurrenceUI[r],n.COUNT&&(r=recurrenceUI.every+" "+r+" "+recurrenceUI["for"]+" "+n.COUNT+" "+recurrenceUI["time"+(n.COUNT>1?"s":"")]),n.UNTIL&&(r=recurrenceUI.every+" "+r+" "+recurrenceUI.until+" "+(new Date).parseDate(n.UNTIL).prettyDate()),!n.COUNT&&!n.UNTIL&&(r=recurrenceUI.every+" "+r),r},this.parsePrettyRecurrence=function(e){var t=["SU","MO","TU","WE","TH","FR","SA"];this.rule==undefined&&(this.rule={FREQ:"YEARLY"});var n={};if($(".repeat",e).text()!=""){var r=String($(".repeat",e).text()).match(/(\d+)/);if(!r)return!1;Number(r[1])!=1&&(n.INTERVAL=Number(r[1]))}for(var i in recurrenceUI)if(recurrenceUI[i]==$(".every",e).text())break;n.FREQ=i+"LY";if($(".foruntil",e).text()==recurrenceUI["for"]){var r=String($(".foruntil + .value",e).text()).match(/(\d+)/);if(!r)return!1;var s=Number(r[1]);s==NaN&&!1,n.COUNT=s}else $(".foruntil",e).text()==recurrenceUI["until"]&&(n.UNTIL=Zero().parsePrettyDate($(".foruntil + .value",e).text()));var o=new RegExp("\\s*"+ui.listSeparator+"\\s*");for(var u in this.rrule_expansion[n.FREQ]){var a=String(u).replace(/BY/,""),f=$.trim($("."+String(u).toLowerCase()+" + .value",e).text());if(f=="")continue;n[u]=f;if(u=="BYDAY"){var l=[],c=n[u].split(o);for(var i=0;i<c.length;i++)l.push(t[weekdays.indexOf(c[i])]);n[u]=l}if(u=="BYMONTH"){var l=[],c=n[u].split(o);for(var i=0;i<c.length;i++)l.push(months.indexOf(c[i]));n[u]=l}}this.rule=n,this.occurences!=undefined&&(delete this.occurrences,delete this.until,delete this.start)},this.parseRecurrence=function(e){var t=["SU","MO","TU","WE","TH","FR","SA"];this.text=e;var n=String(e),r=/(SECONDLY|MINUTELY|HOURLY|DAILY|WEEKLY|MONTHLY|YEARLY)/,i=/(BYSECOND|BYMINUTE|BYHOUR|BYDAY|BYMONTHDAY|BYYEARDAY|BYWEEKNO|BYMONTH|BYSETPOS)/,s=n.split(";"),o=new Array,u=new Object;for(var a=0;a<s.length;a++){var f=s[a].split("=");values=[],i.test(f[0])?values=f[1].split(","):values=[f[1]],u[f[0]]=new Array;switch(f[0]){case"BYSECOND":for(var l=0;l<values.length;l++)values[l]>=0&&values[l]<=60&&u[f[0]].push(values[l]);break;case"BYMINUTE":for(var l=0;l<values.length;l++)values[l]>=0&&values[l]<=59&&u[f[0]].push(values[l]);break;case"BYHOUR":for(var l=0;l<values.length;l++)values[l]>=0&&values[l]<=23&&u[f[0]].push(values[l]);break;case"BYDAY":for(var l=0;l<values.length;l++)/^([+-]?([1-4][0-9]|5[0-3]|[1-9]))?(SU|MO|TU|WE|TH|FR|SA)$/.test(values[l])&&u[f[0]].push(values[l]);break;case"BYMONTHDAY":for(var l=0;l<values.length;l++)values[l]>-32&&values[l]!=0&&values[l]<32&&u[f[0]].push(values[l]);break;case"BYYEARDAY":for(var l=0;l<values.length;l++)values[l]>-366&&values[l]!=0&&values[l]<366&&u[f[0]].push(values[l]);break;case"BYWEEKNO":for(var l=0;l<values.length;l++)values[l]>-53&&values[l]!=0&&values[l]<53&&u[f[0]].push(values[l]);break;case"BYMONTH":for(var l=0;l<values.length;l++)values[l]>0&&values[l]<13&&u[f[0]].push(values[l]);break;case"BYSETPOS":for(var l=0;l<values.length;l++)values[l]>-366&&values[l]!=0&&values[l]<366&&u[f[0]].push(values[l]);break;case"WKST":values.length==1&&/^(SU|MO|TU|WE|TH|FR|SA)$/.test(values[0])&&(u[f[0]]=values[0]);break;case"FREQ":values.length==1&&r.test(values[0])&&(u[f[0]]=values[0]);break;case"INTERVAL":values.length==1&&values[0]>0&&(u[f[0]]=Number(values[0]));break;case"COUNT":values.length==1&&values[0]>0&&(u[f[0]]=Number(values[0]));break;case"UNTIL":values.length==1&&Zero().parseDate(values[0])&&(u[f[0]]=Zero().parseDate(values[0]))}}u.BYWEEKNO!=undefined&&u.FREQ!="YEARLY"&&delete u.BYWEEKNO,u.BYYEARDAY!=undefined&&(u.FREQ=="DAILY"||u.FREQ=="WEEKLY"||u.FREQ=="MONTHLY")&&delete u.BYYEARDAY,u.BYMONTHDAY!=undefined&&u.FREQ=="WEEKLY"&&delete u.BYMONTHDAY,this.rule=u,this.occurences!=undefined&&(delete this.occurences,delete this.start,delete this.until)},this.unparseRecurrence=function(e){var t=/(BYSECOND|BYMINUTE|BYHOUR|BYDAY|BYMONTHDAY|BYYEARDAY|BYWEEKNO|BYMONTH|BYSETPOS)/;if(this.rule==undefined)return!1;var n=this.rule,r=new String;for(var i in n)r.length>1&&(r+=";"),i=="UNTIL"?r=r+i+"="+n[i].DateString():n[i].join?r=r+i+"="+n[i].join(","):r=r+i+"="+n[i];return this.text=r,this.text},this.expandRecurrence=function(e,t){var n={SU:0,MO:1,TU:2,WE:3,TH:4,FR:5,SA:6},r={BYMONTH:-1,BYWEEKNO:0,BYYEARDAY:0,BYMONTHDAY:0,BYDAY:0,BYHOUR:0,BYMINUTE:0,BYSECOND:0,BYSETPOS:0},i=new Array;if(this.rule==undefined)return;var s=this.rule,o=!0,u=e.match(/([0-9]{4})([0-9]{2})([0-9]{2})([Tt]([0-2][0-9])([0-6][0-9])([0-9]{2}))?[Zz]?/).slice(1);if(u[3]!=undefined){var e=new Date;e.setUTCFullYear(u[0]),e.setUTCMonth(u[1]-1),e.setUTCDate(u[2]),e.setUTCHours(u[4]),e.setUTCMinutes(u[5]),e.setUTCSeconds(u[6]),e.setMilliseconds(0);var a={BYMONTH:"m",BYWEEKNO:"w",BYYEARDAY:"Y",BYMONTHDAY:"m",BYDAY:"D",BYHOUR:"h",BYMINUTE:"M",BYSECOND:"s",BYSETPOS:"p"},f={BYMONTH:"setUTCMonth",BYWEEKNO:"setWeek",BYYEARDAY:"setDayOfYear",BYMONTHDAY:"setUTCDate",BYDAY:"setDayOfWeek",BYHOUR:"setUTCHours",BYMINUTE:"setUTCMinutes",BYSECOND:"setUTCSeconds",BYSETPOS:"p"}}else{var e=new Date;e.setUTCFullYear(u[0]),e.setUTCMonth(u[1]-1),e.setUTCDate(u[2]),e.setUTCHours(0),e.setUTCMinutes(0),e.setUTCSeconds(0),e.setMilliseconds(0),o=!1;var a={BYMONTH:"m",BYWEEKNO:"w",BYYEARDAY:"Y",BYMONTHDAY:"m",BYDAY:"D",BYSETPOS:"p"},f={BYMONTH:"setUTCMonth",BYWEEKNO:"setWeek",BYYEARDAY:"setDayOfYear",BYMONTHDAY:"setUTCDate",BYDAY:"setDayOfWeek",BYHOUR:"setUTCHours",BYMINUTE:"setUTCMinutes",BYSECOND:"setUTCSeconds",BYSETPOS:"p"}}if(!e instanceof Date)return!1;var l=new Date(e);i[l.getTime()]=new Date(l);var c=!1,h=!1,p=s.FREQ;if(this.rrule_expansion[p]==undefined||this.rrule_expansion[p].length<2)return console.log("frequency "+p+" not found"),i;var d=100,v="",m=1,g=0,y=0;s.COUNT&&(d=s.COUNT),s.INTERVAL&&(m=s.INTERVAL),s.UNTIL?v=s.UNTIL:t instanceof Date?v=t:v=dateAdd(new Date,"y",20),s.WKST&&(wkst=s.WKST);if(this.start==e&&this.until.getTime()==v.getTime())return this.occurences;for(var g=1;g<d&&!c;y++){var b=new Date(l),w=new Array;for(var E in a){if(c)break;if(s[E]!=undefined){h=!1;if(E=="BYSETPOS")var S=w;this.rrule_expansion[p][E]=="limit"&&(h=!0,w=new Array);for(var x=0;x<s[E].length&&g<d&&!c;x++)if(E=="BYDAY"){var T=s[E][x].match(/([-+]?[0-9]+)?([a-zA-Z]{2})/);if(p=="YEARLY"&&s.BYMONTH!=undefined||p=="MONTHLY")h==0&&(w=new Array,h=!0),T[1]!=undefined?(l.setUTCDate(1),T[1]<0?(l.add("m",1).setUTCDate(-1),l.setUTCDate(T[1]*7)):l.setUTCDate(T[1]*7-6),l.add(a[E],n[T[2]])):l.add(a[E],n[T[2]]),g>=d||l>v?c=!0:w[l.getTime()]=new Date(l.getTime());else if(T[1]==undefined||p!="YEARLY"||s["BYWEEKNO"]!=undefined&&p=="YEARLY")h==0&&(w=new Array,h=!0),l.getDayOfWeek()>n[T[2]]&&l.add("W",1),l[f[E]](n[T[2]]),g>=d||l>v?c=!0:w[l.getTime()]=new Date(l.getTime());else{l.setUTCDate(1);var N=l.getUTCMonth(),C=new Date(l),k=!0;while(k)C[f[E]](n[T[2]]),N==C.getUTCMonth()?(l=new Date(C),C.add("W",1),g>=d||l>v?c=!0:w[l.getTime()]=new Date(l.getTime())):k=!1}}else if(E=="BYSETPOS"){var L=S.length,A=0;for(var O in S)A==s[E][x]&&s[E][x]>0&&(w[O]=S[O]),L-A==s[E][x]&&s[E][x]<0&&(w[O]=S[O]),A++}else if(this.rrule_expansion[p][s[E]]=="expand"){var M=new Date(l),_=(new Date(M)).add(a[E],1);while(l<_&&!c)l.add(a[E],Number(s[E][x])+r[E]),g>=d||l>v?c=!0:w[l.getTime()]=new Date(l.getTime())}else l[f[E]](Number(s[E][x])+r[E]),g>=d||l>v?c=!0:w[l.getTime()]=new Date(l.getTime())}if(g>=d||l>v)c=!0}for(var O in w)i[O]==undefined&&g<d&&(g++,i[O]=w[O]);l=dateAdd(b,this.rrule_expansion[p].type,m),g>=d||l>v?c=!0:h||(g++,i[l.getTime()]=l)}return this.start=e,this.until=v,this.occurences=i,i},this.toString=function(e){return e?this.prettyRecurrence():this.text},e&&(/\s/.test(e)?this.parsePrettyRecurrence(e):this.parseRecurrence(e)),this}