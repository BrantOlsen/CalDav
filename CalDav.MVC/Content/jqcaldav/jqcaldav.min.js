function loadTZ(){abbvr.count<1&&$.ajax({url:jqcaldavPath+"tz/abbvr.tz",async:!1,dataType:"text",success:function(e){var t=String(e).split("\n");abbvr.count=t.length;for(var n=0;n<t.length;n++){var r=t[n].split(",");abbvr.abbv.push(r[0]),abbvr.names.push(r[1]),abbvr.offsets.push(Number(r[2]))}}})}function getTZ(e){if(!e||!e.getDate)var e=new Date;var t=0-(parseInt(e.getTimezoneOffset()/60)*100+e.getTimezoneOffset()%60),n=e.toLocaleString().replace(/^.*\s/,"");debug&&console.log("searching "+abbvr.abbv.length+" timezones for "+n+" ("+t+") found "+abbvr.abbv.indexOf(n));for(var r=0;r<abbvr.abbv.length;r++)if(abbvr.offsets[r]==t)return{abbv:abbvr.abbv[r],name:abbvr.names[r],offset:abbvr.offsets[r]};return!1}function visible(e){var t=$(e).parents("body").andSelf();return $.grep(t,function(e,t){return $(e).css("display")!="none"}).length==t.length?!0:!1}function doit(e){if($(".jqcaldav:eq(0)").data("wait")=="true"){if($(".jqcaldav:eq(0)").data("username").length<3&&$(".jqcaldav:eq(0)").data("password").length<3)return}else{if($("#name").val().length<3&&$("#pass").val().length<3)return;$(".jqcaldav:eq(0)").data("username",$("#name").val()),$(".jqcaldav:eq(0)").data("password",$("#pass").val())}$("#wcal").length>0&&$("#calwrap").remove(),$(".jqcaldav:first").data("caldavurl")==""&&$(".jqcaldav:first").data("caldavurl","/"),$("#cal_login").fadeOut(99);var t=$('<div id="caldavloading1" style="display:none;position:fixed;right:0;bottom:0;text-align: center; width:4em; background-color:black;color:white;-moz-border-top-left-radius:.5em;-webkit-border-top-left-radius:.5em;border-top-left-radius:.5em;opacity:.5;z-index:100;padding:.1em .4em;" data-loading="0" ><span>'+ui.loading+"</span></div>").appendTo(document.body);return window.setTimeout(function(){var e=$(".jqcaldav:first").data("fulldiscovery");e!="true"?e=!1:e=!0,cd=$(document).caldav({url:$(".jqcaldav:first").data("caldavurl"),fullDiscovery:e,username:$(".jqcaldav:eq(0)").data("username"),password:$(".jqcaldav:eq(0)").data("password"),events:addEvents,todos:addToDos,eventPut:eventPut,eventDel:removeEvent,deletedCalendar:deletedCalendar,logout:logout,loading:$("#caldavloading1")},loginFailed),$.fn.caldav.options.calendars=gotCalendars,$(document).caldav("getCalendars",{}),$(window).unload(logoutClicked),window.timezoneJS&&timezoneJS!=undefined&&timezoneJS.timezone!=undefined&&timezoneInit==0&&(timezoneInit=!0,timezoneJS.timezone.zoneFileBasePath=jqcaldavPath+"tz",timezoneJS.timezone.init())},100),e&&e.stopPropagation(),!1}function loginFailed(e,t){e.abort(),$("#name,#pass").css("background-color","red").animate({"background-color":"#FFF"},300)}function logoutClicked(){($("#calwrap").length>0||$.fn.caldav.options.username)&&$(document).caldav("logout")}function logout(){window.clearInterval($("#wcal").data("updateInterval"));for(var e in alerts)window.clearTimeout(alerts[e]);$("#calwrap").remove(),$("#cal_login").fadeIn(),$("#name").val(""),$("#pass").val("")}function gotCalendars(){if($("#wcal").length<1){var e=$.fn.caldav.collectionData[$.fn.caldav.principals[$.fn.caldav.principalMap[$.fn.caldav.data.myPrincipal]].cal].xml,t=$("*["+$.fn.caldav.xmlNSfield+"=calendar-settings]:first",e).text();if(t.length>20){$.extend(!0,settings,JSON.parse(t)),settings.start=Zero().parseDate(settings.start),settings.end=Zero().parseDate(settings.end);if(settings.calendars!=undefined){var n=/false/i;for(var r in settings.calendars)settings.calendars[r]!==!1&&(n.test(settings.calendars[r])?settings.calendars[r]=!1:settings.calendars[r]=!0)}}$(".jqcaldav:first").append(buildcal()),$(window).resize(resize),$("#wcal").animate({scrollTop:$("#calt tr:first")[0].clientHeight+1},250),$("#calpopup").removeData("clicked"),getInbox(),resize(),t=$("*["+$.fn.caldav.xmlNSfield+"=calendar-subscriptions]:first",e).text(),settings.shortAllDay?(styles.updateRule(".week .day ul.eventlist > li.multiday",{width:null}),styles.updateRule(".day ul.eventlist > li.multiday:nth-last-child(1n+6),  .day ul.eventlist > li.multiday:nth-last-child(1n+6)  ~ li.multiday",{"margin-bottom":null,"line-height":null}),styles.updateRule(".day ul.eventlist > li.multiday:nth-last-child(1n+11), .day ul.eventlist > li.multiday:nth-last-child(1n+11) ~ li.multiday",{"margin-bottom":null,"line-height":null}),styles.updateRule(".day ul.eventlist > li.multiday:nth-last-child(1n+16), .day ul.eventlist > li.multiday:nth-last-child(1n+16) ~ li.multiday",{"margin-bottom":null,"line-height":null}),styles.updateRule(".day ul.eventlist > li.multiday:nth-last-child(1n+21), .day ul.eventlist > li.multiday:nth-last-child(1n+21) ~ li.multiday",{"margin-bottom":null,"line-height":null}),styles.updateRule(".day ul.eventlist > li.multiday:nth-last-child(1n+26), .day ul.eventlist > li.multiday:nth-last-child(1n+26) ~ li.multiday",{"margin-bottom":null,"line-height":null}),styles.updateRule(".day ul.eventlist > li.multiday:nth-last-child(1n+31), .day ul.eventlist > li.multiday:nth-last-child(1n+31) ~ li.multiday",{"margin-bottom":null,"line-height":null})):(styles.updateRule(".week .day ul.eventlist > li.multiday",{width:"100%"}),styles.updateRule(".day ul.eventlist > li.multiday:nth-last-child(1n+6),  .day ul.eventlist > li.multiday:nth-last-child(1n+6)  ~ li.multiday",{"margin-bottom":"1px","line-height":"50%"}),styles.updateRule(".day ul.eventlist > li.multiday:nth-last-child(1n+11), .day ul.eventlist > li.multiday:nth-last-child(1n+11) ~ li.multiday",{"margin-bottom":"1px","line-height":"33.34%"}),styles.updateRule(".day ul.eventlist > li.multiday:nth-last-child(1n+16), .day ul.eventlist > li.multiday:nth-last-child(1n+16) ~ li.multiday",{"margin-bottom":"1px","line-height":"25%"}),styles.updateRule(".day ul.eventlist > li.multiday:nth-last-child(1n+21), .day ul.eventlist > li.multiday:nth-last-child(1n+21) ~ li.multiday",{"margin-bottom":"1px","line-height":"20%"}),styles.updateRule(".day ul.eventlist > li.multiday:nth-last-child(1n+26), .day ul.eventlist > li.multiday:nth-last-child(1n+26) ~ li.multiday",{"margin-bottom":"1px","line-height":"16.7%"}),styles.updateRule(".day ul.eventlist > li.multiday:nth-last-child(1n+31), .day ul.eventlist > li.multiday:nth-last-child(1n+31) ~ li.multiday",{"margin-bottom":"1px","line-height":"14.28%"}));if(t.length>20){var i=JSON.parse(t);for(var r in i){if(i[r]==undefined)continue;subscriptions==undefined||!subscriptions instanceof Object?subscriptions=[{name:i[r].name,url:i[r].url,color:i[r].color,order:i[r].order,description:i[r].description}]:subscriptions.push({name:i[r].name,url:i[r].url,color:i[r].color,order:i[r].order,description:i[r].description}),fetchCalendar(i[r].url,i[r].name,i[r].color,i[r].order,i[r].description)}}settings["update frequency"]>0&&(calendarSync(),$("#wcal").data("updateInterval",window.setInterval(calendarSync,settings["update frequency"]*1e3)))}}function calendarSync(){var e=$(document).caldav("calendars");for(var t=0;t<e.length;t++)$(document).caldav("syncCollection",t,$("#wcal").data("firstweek"),$("#wcal").data("lastweek"));getInbox()}function eventPut(e,t){t!="success"&&(alert("failed to save event to server"),console.log(e))}function draggable(e){$(e).addClass("draggable"),$(e).bind("mousedown",function(e){if(!$(e.target).hasClass("draggable"))return;if(e.pageX>$(this).offset().left+$(this).outerWidth()*.9&&e.pageY>$(this).offset().top+$(this).outerHeight()*.9)return!0;$(document.body).data("caldrag",{e:e.target,x:e.pageX-$(this).offset().left,y:e.pageY-$(this).offset().top});var t=function(e){var t=$(document.body).data("caldrag");return $(t.e).offset({left:e.pageX-t.x,top:e.pageY-t.y}),!1};return $(document).bind("mouseup",function(e){$(document).unbind("mousemove",t),$(document).unbind(e)}),$(document).bind("mousemove",t),!1})}function resize(){$("#calsidebar, #caltodo").css({height:window.innerHeight}),$("#callist").css({"max-height":window.innerHeight-($(".sidetitle").height()+$(".calfooter").height()+$("#calinvites").height())}),$("#wcal").css({height:window.innerHeight-($("#wcal")[0].offsetTop+2)}),$(".timeline").css({height:window.innerHeight-($("#wcal")[0].offsetTop+2)}),resize_delay!=0&&window.clearTimeout(resize_delay),resize_delay=window.setTimeout(update_weekview,resize_time),updateTimeline()}function update_weekview(){var e=new Date,t=$("#wcal").scrollTop()/$("#wcal").height();styles.getStyleSheet("calstyle");var n=window.innerHeight-($("#wcal")[0].offsetTop+40);styles.updateRule(".weekview .week",{height:n+"px"}),styles.updateRule(".weekview .weeknum",{height:n+"px"}),styles.updateRule(".weekview .week .day",{height:n+"px"}),styles.updateRule(".weekview .week ul.hoursbg",{height:n+"px"}),styles.updateRule(".weekview .week .day ul.eventlist",{height:n+"px"});var r=settings.start.getLongMinutes(),i=settings.end.getLongMinutes(),s=n/((i-r)/100);styles.updateRule(".hoursbg > li",{height:s+"px"}),window.setTimeout(function(){$("#wcal").scrollTop($("#wcal").height()*t)},300),resize_time=(new Date).getTime()-e.getTime()}function calSettings(e){var t=$('<ul class="settings" ></ul>');$(t).append('<li><span></span><span class="header">'+ui.settings+"</span></li>");var n={start:"Day Starts",end:"Day Ends",twentyFour:"24 Hour Time","update frequency":"update frequency",weekStart:"Week Starts on",usealarms:"use alarms",shortAllDay:"Collapse Events that span Multiple Days"},r={start:"time",end:"time",twentyFour:"bool","update frequency":"number",weekStart:"day",usealarms:"bool",shortAllDay:"bool"};for(var i in n)$(t).append('<li><span class="label">'+ui[i]+'</span><span class="value data'+r[i]+'" tabindex="0" contenteditable="true" >'+printValue(settings[i],r[i])+"</span></li>");$(".value",t).click(calFieldClick),$("#caldialog").empty(),$("#caldialog").append(t),draggable($("#caldialog")),$("#caldialog").show(),$("#caldialog li span:contains(name) + span").focus(),$("#caldialog").append('<div class="button done" tabindex="0" >'+ui.done+"</div>"),$(".calpopup .done").bind("click keypress",function(e){if(e.keyCode>0&&e.keyCode!=32&&e.keyCode!=13)return;saveSettings(true)==1&&($(".calpopup").fadeOut(),$("#wcal").removeData("popup"),$(document).unbind("click",$("#wcal").data("edit_click")),$(document).unbind("keyup",$("#wcal").data("edit_keyup")))}),$("#wcal").data("popup","#caldialog"),$("#wcal").data("clicked",e.target),$(document).click($("#wcal").data("edit_click")),$(document).keyup($("#wcal").data("edit_keyup"))}function saveSettings(e){if(e){var t={start:"Day Starts",end:"Day Ends",twentyFour:"24 Hour Time","update frequency":"update frequency",weekStart:"Week Starts on",usealarms:"use alarms",shortAllDay:"Collapse Events that span Multiple Days"},n={start:"time",end:"time",twentyFour:"bool","update frequency":"number",weekStart:"day",usealarms:"bool",shortAllDay:"bool"};for(var r in t)settings[r]=getValue($("#caldialog li span:contains("+ui[r]+") + span"),n[r]);styles.getStyleSheet("calstyle"),settings.shortAllDay?(styles.updateRule(".week .day ul.eventlist > li.multiday",{width:null}),styles.updateRule(".day ul.eventlist > li.multiday:nth-last-child(1n+6),  .day ul.eventlist > li.multiday:nth-last-child(1n+6)  ~ li.multiday",{"margin-bottom":null,"line-height":null}),styles.updateRule(".day ul.eventlist > li.multiday:nth-last-child(1n+11), .day ul.eventlist > li.multiday:nth-last-child(1n+11) ~ li.multiday",{"margin-bottom":null,"line-height":null}),styles.updateRule(".day ul.eventlist > li.multiday:nth-last-child(1n+16), .day ul.eventlist > li.multiday:nth-last-child(1n+16) ~ li.multiday",{"margin-bottom":null,"line-height":null}),styles.updateRule(".day ul.eventlist > li.multiday:nth-last-child(1n+21), .day ul.eventlist > li.multiday:nth-last-child(1n+21) ~ li.multiday",{"margin-bottom":null,"line-height":null}),styles.updateRule(".day ul.eventlist > li.multiday:nth-last-child(1n+26), .day ul.eventlist > li.multiday:nth-last-child(1n+26) ~ li.multiday",{"margin-bottom":null,"line-height":null}),styles.updateRule(".day ul.eventlist > li.multiday:nth-last-child(1n+31), .day ul.eventlist > li.multiday:nth-last-child(1n+31) ~ li.multiday",{"margin-bottom":null,"line-height":null})):(styles.updateRule(".week .day ul.eventlist > li.multiday",{width:"100%"}),styles.updateRule(".day ul.eventlist > li.multiday:nth-last-child(1n+6),  .day ul.eventlist > li.multiday:nth-last-child(1n+6)  ~ li.multiday",{"margin-bottom":"1px","line-height":"50%"}),styles.updateRule(".day ul.eventlist > li.multiday:nth-last-child(1n+11), .day ul.eventlist > li.multiday:nth-last-child(1n+11) ~ li.multiday",{"margin-bottom":"1px","line-height":"33.34%"}),styles.updateRule(".day ul.eventlist > li.multiday:nth-last-child(1n+16), .day ul.eventlist > li.multiday:nth-last-child(1n+16) ~ li.multiday",{"margin-bottom":"1px","line-height":"25%"}),styles.updateRule(".day ul.eventlist > li.multiday:nth-last-child(1n+21), .day ul.eventlist > li.multiday:nth-last-child(1n+21) ~ li.multiday",{"margin-bottom":"1px","line-height":"20%"}),styles.updateRule(".day ul.eventlist > li.multiday:nth-last-child(1n+26), .day ul.eventlist > li.multiday:nth-last-child(1n+26) ~ li.multiday",{"margin-bottom":"1px","line-height":"16.7%"}),styles.updateRule(".day ul.eventlist > li.multiday:nth-last-child(1n+31), .day ul.eventlist > li.multiday:nth-last-child(1n+31) ~ li.multiday",{"margin-bottom":"1px","line-height":"14.28%"}))}var i=$.extend(!0,{},settings);i.start=i.start.DateString(),i.end=i.end.DateString();var s={0:{ns:"http://boxacle.net/ns/calendar/",name:"calendar-settings",value:JSON.stringify(i)}},o=$(document).caldav("calendars"),u="";for(var r in o)if(o[r].mailto.match(RegExp($("#name").val(),"i"))){u=o[r].principal;break}return $(document).caldav("updateCollection",{url:$.fn.caldav.principals[$.fn.caldav.principalMap[$.fn.caldav.data.myPrincipal]].calendar},$.fn.caldav.principals[$.fn.caldav.principalMap[$.fn.caldav.data.myPrincipal]].calendar,s),!0}function printValue(e,t){switch(t){case"bool":return e?ui.yes:ui.no;case"text":return e;case"number":return e;case"day":return weekdays[e];case"time":return e.prettyTime();case"date":case"datetime":return e.prettyDate()}}function getValue(e,t){switch(t){case"bool":return $(e).text()==ui["yes"];case"text":return $(e).text();case"number":return Number($(e).text());case"day":return weekdays.indexOf($(e).text());case"time":return Zero().parsePrettyTime($(e).text());case"date":case"datetime":return(new Date).parsePrettyDate($(e).text())}}function colorClicked(e){var t='<div class="colorpicker" >';for(var n=1;n<=30;n++)t=t+'<span class="color'+n+'"></span>';t+="</div>";var r=$(t);$("span",r).click(function(e){var t=RGBtoHex($(e.target).css("background-color"));return $(e.target).closest(".value").text(t),$(e.target).closest(".colorpicker").remove(),!1}),$(e.target).blur(function(e){$(e.target).children(".colorpicker").remove()}),$(e.target).append(r);var i=$(e.target).position();$(r).css({left:i.left+$(e.target).outerWidth()})}function calFieldClick(e){var t=$($("#wcal").data("popup")),n=$(e.target).prev().text(),r={start:"Day Starts",end:"Day Ends",twentyFour:"24 Hour Time","update frequency":"update frequency",weekStart:"Week Starts on",usealarms:"use alarms"},i={twentyFour:[ui.yes,ui.no],usealarms:[ui.yes,ui.no]};i.weekStart=weekdays;for(var s in r)if(ui[s]==n)break;if(i[s]!=undefined&&i[s].length>0){var o=i[s],u=$(e.target).text(),a='<div class="completionWrapper"><div class="completion">';for(var f=0;f<o.length;f++)a=a+"<div"+(o[f]==u?' class="selected" ':"")+">"+o[f]+"</div>";a+="</div></div>";var l=$(a);$(l).children().click(function(e){return $(e.target).parent().parent().next().text($(e.target).text()),$(e.target).parent().parent().fadeOut(function(){$(this).remove()}),popupOverflowAuto(),!1}),$(e.target).bind("keydown",function(e){e.spaceSelects=!0,e.search=!0,e.removeOnEscape=!0;var t=keyboardSelector(e);if(t=="cancel")return $("#wcal").data("eatCancel",!0),$(this).unbind("blur"),popupOverflowAuto(),e.stopPropagation(),!1;if($(t).length==1){$(this).unbind("blur"),$(this).text($(t).text()),$(this).prev().fadeOut(function(){$(this).remove()}),popupOverflowAuto();var n=e.which==9;return n}return t},!1),$(l).css({top:$(e.target).position().top,left:$(e.target).position().left,"margin-left":"2em"}),$(e.target).bind("blur",function(e){$(e.target).prev().fadeOut(function(){$(this).remove()}),popupOverflowAuto(),$(this).unbind(e)}),popupOverflowVisi(),$(e.target).before(l)}}function subscribeCalendar(e){var t=$(".jqcaldav").data("calproxyurl");if(t=="")return;var n=$("<ul></ul>"),r={a:"name",b:"url",c:"color",d:"description",order:"order"};for(var i in r)$(n).append('<li><span class="label">'+ui[r[i]]+'</span><span class="value" tabindex="0" contenteditable="true">'+(i=="a"?"New Calendar":"")+"</span></li>");$("#caldialog").empty(),$("#caldialog").append(n),draggable($("#caldialog")),$("#caldialog").show(),$("#caldialog li span:contains("+ui.name+") + span").focus(),$("#caldialog li span:contains("+ui.color+") + span").click(colorClicked),$("#caldialog").append('<div class="button done" tabindex="0" >'+ui.done+"</div>"),$(".calpopup .done").bind("click keypress",function(e){if(e.keyCode>0&&e.keyCode!=32&&e.keyCode!=13)return;saveSubscription()==1&&($(".calpopup").fadeOut(),$("#wcal").removeData("popup"),$(document).unbind("click",$("#wcal").data("edit_click")),$(document).unbind("keyup",$("#wcal").data("edit_keyup")))}),$("#wcal").data("popup","#caldialog"),$("#wcal").data("clicked",e.target),$(document).click($("#wcal").data("edit_click")),$(document).keyup($("#wcal").data("edit_keyup"))}function saveSubscription(){var e=$("#caldialog ul").data("calendar"),t=$("#caldialog li span:contains("+ui.name+") + span").text(),n=$("#caldialog li span:contains("+ui.url+") + span").text(),r=$("#caldialog li span:contains("+ui.color+") + span").text(),i=$("#caldialog li span:contains("+ui.order+") + span").text(),s=$("#caldialog li span:contains("+ui.description+") + span").text();if(e!=undefined){var o=$("#wcal").data("subscribed");for(var u in subscriptions)subscriptions[u].url==o[e].url&&(subscriptions[u].name==o[e].name||subscriptions[u].name==o[e].displayName)&&(subscriptions[u]={name:t,url:n,color:r,order:i,description:s})}else subscriptions==undefined||!subscriptions instanceof Object?subscriptions=[{name:t,url:n,color:r,order:i,description:s}]:subscriptions.push({name:t,url:n,color:r,order:i,description:s});var a="",o=$(document).caldav("calendars");for(var u in o)if(o[u].mailto.match(RegExp($("#name").val(),"i"))){a=o[u].principal;break}var f={0:{ns:"http://boxacle.net/ns/calendar/",name:"calendar-subscriptions",value:JSON.stringify(subscriptions)}};$(document).caldav("updateCollection",{url:a},a,f);if(e==undefined)fetchCalendar(n,t,r,i,s);else{var l=styles.getStyleSheet("calstyle");l.updateRule(".calendar"+e,{color:r}),l.updateRule(".calendar"+e+":hover",{"background-color":r}),l.updateRule(".calendar"+e+"bg",{"background-color":r}),$("#callist .calendar"+e).attr("order",i),$("#callist .calendar"+e).attr("title",s),$("#callist .calendar"+e+" span").text(t),eventSort($("#callist .calendar"+e).parent())}return!0}function addSubscribedCalendar(e,t,n,r,i,s){var o=$(".jqcaldav").data("calproxyurl");if(o=="")return;var u=$("#callist li:contains(Subscribed) > ul"),a=styles.getStyleSheet("calstyle");a.updateRule(".calendar"+s,{color:t}),a.updateRule(".calendar"+s+":hover",{"background-color":t}),a.updateRule(".calendar"+s+"bg",{"background-color":t});if(!u.length){$('<li class="open"  ><span>'+ui.subscribed+'</span><ul data-mailto="Subscribed" ></ul></li>').appendTo("#callist");var u=$("#callist li:contains("+ui.subscribed+") > ul");$("#callist li:contains("+ui.subscribed+") > span").click(function(){$("li.selected",$(this).parent()).toggleClass("selected"),$(this).parent("li").toggleClass("open"),$(this).parent("li").toggleClass("closed")})}var f=$('<li class="calendar'+s+'" order="'+n+'" title="'+r+'"><input type="checkbox" id="calendar'+s+'" checked="true" /><span >'+e+"</span></li>");$(f).dblclick(editCalendar),$("input",f).change(toggleCalendar),$(u).append(f),eventSort(u);if(settings.calendars!=undefined&&settings.calendars[i]!=undefined&&settings.calendars[i]==0){$("input",f).attr("checked",!1);var a=styles.getStyleSheet("calstyle");a.updateRule("#wcal .day .event.calendar"+s,{opacity:0}),a.updateRule("#wcal .day .event.calendar"+s+"bg",{opacity:0}),a.updateRule("#wcal .day .event.calendar"+s,{display:"none"}),a.updateRule("#wcal .day .event.calendar"+s+"bg",{display:"none"})}return s}function fetchCalendar(e,t,n,r,i){var s=$(".jqcaldav").data("calproxyurl");if(s=="")return;var o=$(document).caldav("calendars"),u=$("#wcal").data("subscribed");typeof u!="object"&&(u=[],u[o.length]={});var a=null,f;for(f in u)u[f].url==e&&u[f].name==t&&(a=f);a==null&&(a=Number(f)+1);var l=a;typeof u!="object"&&(u={}),u[l]={src:e,order:r,displayName:t,desc:i,color:n,url:e},$("#wcal").data("subscribed",u),$.get($(".jqcaldav").data("calproxyurl")+e).complete(function(s){var o=s.responseText;addSubscribedCalendar(t,n,r,i,e,a);var u=$("#wcal").data("subscribed");u[l].events=new iCal(o),debug&&console.log(u[l].events.length),$("#wcal").data("subscribed",u),addSubscribedEvents(l,$("#wcal").data("firstweek"),$("#wcal").data("lastweek"))})}function addCalendar(e){var t=$('<ul data-calendar="new" ></ul>'),n={a:"name",b:"color",c:"description",e:"order",d:"owner"},r=$(document).caldav("calendars"),i=$("#callist li.selected");i.length>0?i=$(i).attr("class").match(/calendar(\d+)/)[1]:i=0;for(var s in n)$(t).append('<li><span class="label">'+ui[n[s]]+'</span><span class="value" tabindex="0" contenteditable="true">'+(s=="a"?ui["new calendar"]:"")+"</span></li>");$("span:contains("+ui.owner+") ~ .value",t).attr("data-principal",r[i].principal),$("span:contains("+ui.color+") ~ .value",t).text(randomColor()),$("span:contains("+ui.color+") ~ .value",t).click(colorClicked),$("span:contains("+ui.owner+") ~ .value",t).text(r[i].principalName),$("span:contains("+ui.owner+") ~ span",t).keydown(completePrincipal),$("span:contains("+ui.owner+") ~ span",t).before('<div class="completionWrapper"><div class="completion"></div></div>');var o=$('<li><span class="label">'+ui.privileges+"</span></li>");$(o).append('<div class="completionWrapper"><div class="completion"></div></div><span class="value" data-principal="new principal" contenteditable="true">'+ui.add+"</span>"),$('span:[data-principal="new principal"]',o).focus(function(e){$(this).text()==ui.add&&$(this).text("")}),$('span:[data-principal="new principal"]',o).blur(function(e){$(this).text()==""&&$(this).text(ui.add),$(this).attr("data-principal").length>1&&$(this).attr("data-principal")!="new principal"&&($(this).prev().before(privilegeBox($("<ace><principal><href>"+$(this).attr("data-principal")+"</href></principal></ace>"))),$(this).attr("data-principal","new principal"),$(this).removeData("principal"),$(this).text(ui.add))}),$('span:[data-principal="new principal"]',o).keydown(completePrincipal),$(t).append(o),$("#caldialog").empty(),$("#caldialog").append(t),draggable($("#caldialog")),$("#caldialog").show(),$("#caldialog li span:contains("+ui.name+") + span").focus(),$("#caldialog").append('<div class="button done" tabindex="0" >'+ui.done+"</div>"),$(".calpopup .done").bind("click keypress",function(e){if(e.keyCode>0&&e.keyCode!=32&&e.keyCode!=13)return;saveCalendar()==1&&($(".calpopup").fadeOut(),$("#wcal").removeData("popup"),$(document).unbind("click",$("#wcal").data("edit_click")),$(document).unbind("keyup",$("#wcal").data("edit_keyup")))}),$("#wcal").data("popup","#caldialog"),$("#wcal").data("clicked",e.target),$(document).click($("#wcal").data("edit_click")),$(document).keyup($("#wcal").data("edit_keyup"))}function selectCalendar(e){var t=$("#callist li.selected");$(t).removeClass("selected");var t=$(this);$(t).addClass("selected");var n=$(document).caldav("calendars"),r=$(t).attr("class").match(/calendar(\d+)/)[1];n[r]?settings.selectedCalendar=n[r].href:(n=$("#wcal").data("subscribed"),settings.selectedCalendar=n[r].src),saveSettings(!1)}function toggleCalendar(){var e=styles.getStyleSheet("calstyle"),t=this.id;this.checked?(e.updateRule("#caltodo .event."+t,{display:null}),e.updateRule("#wcal .day .event."+t,{display:null}),e.updateRule("#wcal .day .event."+t+"bg",{display:null}),window.setTimeout(function(){e.updateRule("#wcal .day .event."+t,{opacity:1,height:null}),e.updateRule("#wcal .day .event."+t+"bg",{opacity:1,height:null}),$("."+t).removeAttr("lang")},100)):(e.updateRule("#caltodo .event."+t,{display:"none"}),e.updateRule("#wcal .day .event."+t,{opacity:0,height:0}),e.updateRule("#wcal .day .event."+t+"bg",{opacity:0,height:0}),window.setTimeout(function(){e.updateRule("#wcal .day .event."+t,{display:"none"}),e.updateRule("#wcal .day .event."+t+"bg",{display:"none"}),$("."+t).attr("lang","x-klingon")},250));var n=$(document).caldav("calendars"),r=$("#wcal").data("subscribed");settings["calendars"]==undefined&&(settings.calendars={}),$.each($("#callist input"),function(e,t){var i=$(t).attr("id").match(/(\d+)/)[1];n[i]?settings.calendars[n[i].url]=this.checked?"true":"false":settings.calendars[r[i].url]=this.checked?"true":"false"}),saveSettings(!1)}function editCalendar(e){var t=$(e.target).parents("li").attr("class").match(/calendar(\d+)/)[1],n=$('<ul data-calendar="'+t+'" ></ul>'),r={displayName:"name",color:"color",order:"order",desc:"description"},i=$(document).caldav("calendars"),s=!1;i[t]==undefined&&(i=$("#wcal").data("subscribed"),r.url="url",s=!0);for(var o in r)$(n).append('<li><span class="label">'+ui[r[o]]+'</span><span class="value" data-prop="'+r[o]+'" data-value="'+i[t][o]+'" contenteditable="true">'+i[t][o]+"</span></li>");if(!s&&(i[t].perms.read||i[t].perms["read-acl"])){var u=!1;if(i[t].perms.write||i[t].perms["write-acl"])u=!0;var a=$("acl > ace:has(href)",i[t].xml),f=$("supported-privilege-set",i[t].xml),l=$('<li><span class="label" privileges="true" >'+ui.privileges+"</span></li>");$(l).hover(function(){$($("#wcal").data("popup")).css({overflow:"visible"})},function(){$($("#wcal").data("popup")).css({overflow:"auto"})});for(o=0;o<a.length;o++)$(l).append(privilegeBox(a[o],f,u));$(l).append('<div class="completionWrapper"><div class="completion"></div></div><span class="value" data-principal="new principal" contenteditable="true">'+ui.add+"</span>"),$('span:[data-principal="new principal"]',l).focus(function(e){$($("#wcal").data("popup")).css({overflow:"visible"}),$(this).text()==ui.add&&$(this).text("")}),$('span:[data-principal="new principal"]',l).blur(function(e){$($("#wcal").data("popup")).css({overflow:"auto"}),$(this).text()==""&&$(this).text(ui.add),$(this).attr("data-principal").length>1&&$(this).attr("data-principal")!="new principal"&&($(this).prev().before(privilegeBox($("<ace><principal><href>"+$(this).attr("data-principal")+"</href></principal></ace>"),f,!0)),$(this).attr("data-principal","new principal"),$(this).removeData("principal"),$(this).text(ui.add))}),$('span:[data-principal="new principal"]',l).keydown(completePrincipal),$(n).append(l)}$("#caldialog").empty(),$("#caldialog").css({overflow:"auto"}),$("[data-prop=color]",n).click(colorClicked),$("#caldialog").append(n),$("#caldialog").data("url",i[t].href),draggable($("#caldialog")),$("#caldialog").show(),$("#caldialog li span:contains(name) + span").focus(),/bind/.test($.fn.caldav.serverSupports)&&$("#caldialog").append('<div class="button bind" tabindex="0">'+ui.bind+"</div>"),$("#caldialog").append('<div class="button delete" tabindex="0">'+ui["delete"]+"</div>"),$("#caldialog").append('<div class="button done" tabindex="0" >'+ui.done+"</div>"),$("#caldialog .button").bind("click keypress",function(e){if(e.keyCode>0)if(e.keyCode!=32||e.keyCode!=13)return;if(s&&$(this).hasClass("done")&&saveSubscription()==1)$(e.target).closest(".calpopup").fadeOut(),$("#wcal").removeData("popup"),$(document).unbind("click",$("#wcal").data("edit_click")),$(document).unbind("keyup",$("#wcal").data("edit_keyup"));else if($(this).hasClass("done")&&saveCalendar()==1)$(e.target).closest(".calpopup").fadeOut(),$("#wcal").removeData("popup"),$(document).unbind("click",$("#wcal").data("edit_click")),$(document).unbind("keyup",$("#wcal").data("edit_keyup"));else if($(this).hasClass("delete")&&delCalendar()==1)$(e.target).closest(".calpopup").fadeOut(),$("#wcal").removeData("popup"),$(document).unbind("click",$("#wcal").data("edit_click")),$(document).unbind("keyup",$("#wcal").data("edit_keyup"));else if($(this).hasClass("unbind")){var n=i[t].href;n=n.replace(/\/$/,"");var r=n.match(/\/([^\/]+)$/)[1]+"";n=n.replace(/\/[^\/]*$/,""),debug&&console.log(r,n),$(document).caldav("unbind",r,n),$(e.target).closest(".calpopup").fadeOut(),$("#wcal").removeData("popup"),$(document).unbind("click",$("#wcal").data("edit_click")),$(document).unbind("keyup",$("#wcal").data("edit_keyup"))}else if($(this).hasClass("bind"))return $("#caldialog").fadeOut("fast"),bind(t),!1}),$("#wcal").data("popup","#caldialog"),$("#wcal").data("clicked",e.target),$(document).click($("#wcal").data("edit_click")),$(document).keyup($("#wcal").data("edit_keyup"))}function bind(e){var t=$(document).caldav("calendars");$("#caldialog").empty();var n=$('<ul data-calendar="'+e+'" ></ul>'),r={name:"name",user:"user",source:"source"};for(var i in r)$(n).append('<li><span class="label">'+ui[r[i]]+'</span><span class="value '+r[i]+'" data-prop="'+r[i]+'" contenteditable="true">'+i+"</span></li>");$("#caldialog").append(n),$("#caldialog span.user").data("principal",$.fn.caldav.principals[$.fn.caldav.principalMap[$.fn.caldav.data.myPrincipal]].href),$("#caldialog span.user").text($.fn.caldav.principals[$.fn.caldav.principalMap[$.fn.caldav.data.myPrincipal]].name),$("#caldialog span.user").before('<div class="completionWrapper"><div class="completion"></div></div>'),$("#caldialog span.user").keydown(completePrincipal),$("#caldialog").css({overflow:"auto"}),$("#caldialog").append('<div class="button done" tabindex="0">'+ui.done+"</div>"),0+e>-1&&($("#caldialog span.name").text(t[e].displayName),$("#caldialog span.source").text(t[e].href)),$(this).unbind("click keypress"),$("#caldialog .button").bind("click keypress",function(e){if($(this).hasClass("done")){var t=$("#caldialog span.name").text(),n=$("#caldialog span.user").data("principal"),r=$("#caldialog span.source").text();debug&&console.log("bind",t,n,r),$(document).caldav("bind",t,n,r),$(e.target).closest(".calpopup").fadeOut(),$("#wcal").removeData("popup"),$(document).unbind("click",$("#wcal").data("edit_click")),$(document).unbind("keyup",$("#wcal").data("edit_keyup"))}return!1}),$("#caldialog").fadeIn()}function privilegeBox(e,t,n){n!==!0&&(n=!1);var r={all:["bind","unbind","unlock"],read:["acl","free-busy","privileges"],write:["content","properties","acl"],"schedule-send":["invite","reply","freebusy"],"schedule-deliver":["invite","reply","query-freebusy"]},i=$('<span class="value privilegeOwner" data-principal="'+$("principal",e).text().trim()+'" >'+$("principal",e).text().trim()+"</span>");$(document).caldav("getProperties",{url:$("principal",e).text().trim()},{displayname:"DAV:"},function(e){var t=new Array,n="",r=$("response",e),i=$("href:first",r).text().trim(),s=$('.privilegeOwner[data-principal="'+i+'"]')[0];s.childNodes[0].textContent=$("displayname",r).text().trim()});var s=$('<ul class="privilegeBox"></ul>'),o="";for(var u in r){var a=$("grant "+u,e).length>0?"granted":"",f=$("grant "+u,e).length>0?"yes":"no";if(t){var o=$("supported-privilege > privilege > "+u,t);if(o.length==0)continue;var o=$(o).parent().siblings("description").text()}var l=$('<li class="'+a+'" title="'+o+'" data-granted="'+f+'" data-priv="'+u+'">'+u+"</li>"),c=$("<ul></ul>");for(var h=0;h<r[u].length;h++){var p=u=="all"?r[u][h]:u+"-"+r[u][h];p=="schedule-deliver-query-freebusy"&&(p="schedule-query-freebusy");var a=$("grant "+p,e).length>0?"granted":"",f=$("grant "+p,e).length>0?"yes":"no";if(t){var o=$("supported-privilege > privilege > "+p,t);if(o.length==0)continue;var o=$(o).parent().siblings("description").text()}$(c).append('<li class="'+a+'" title="'+o+'" data-granted="'+f+'" data-priv="'+p+'">'+privileges[r[u][h]]+"</li>")}$(l).append(c),$(s).append(l)}return n&&$("li",s).click(function(){return $(this).toggleClass("granted"),!1}),$(i).append(s),i}function saveCalendar(e){var t=$("#caldialog"),n=$("#caldialog ul").data("calendar"),r=$(document).caldav("calendars");if(r[n])var i=$("acl",r[n].xml).clone();else var i=[];var s={displayname:"name","calendar-color":"color","calendar-description":"description","calendar-order":"order"},o={displayname:"DAV:","calendar-color":"http://apple.com/ns/ical/","calendar-description":"urn:ietf:params:xml:ns:caldav","calendar-order":"http://apple.com/ns/ical/"},u=!1,a={};for(var f in s){var l=$(".label:contains("+ui[s[f]]+") ~ .value",t);$(l).length>0&&$(l).text()!=$(l).data("value")&&(a[f]={name:f,value:$(l).text(),ns:o[f]},u=!0)}if(r[n]&&(r[n].all||r[n].perms.write||r[n].perms["write-acl"])){var c=["all","bind","unbind","unlock","read","read-acl","read-free-busy","read-privileges","write","write-content","write-properties","write-acl","schedule-send","schedule-send-invite","schedule-send-reply","schedule-send-freebusy","schedule-deliver","schedule-deliver-invite","schedule-deliver-reply","schedule-query-freebusy"],h=$(".label:contains("+ui.privileges+") ~ .privilegeOwner",t);for(var p=0;p<h.length;p++){var d=$(h[p]).data("principal"),v=$("ace",i).filter(function(){if($("principal > href ",this).text()==d)return!0}),m=!1;if(v.length==0){m=!0;var v=document.createElementNS("DAV:","ace"),g=document.createElementNS("DAV:","principal");v.appendChild(g);var y=document.createElementNS("DAV:","href");y.appendChild(document.createTextNode(d)),g.appendChild(y);var b=document.createElementNS("DAV:","grant");v.appendChild(b)}else var b=$("grant",v)[0];var w=[],E=!1;for(var S in c){var x=$('li[data-priv="'+c[S]+'"]',h[p]),T=$(x).hasClass("granted"),N=$(x).data("granted");T&&w.push(c[S]);if(T&&N=="no"||!T&&N=="yes")E=!0;if(T&&N=="no"){var C=document.createElementNS("DAV:","privilege"),k=document.createElementNS("DAV:",c[S]);C.appendChild(k),b.appendChild(C)}if(!T&&N=="yes"){var L=$("grant > privilege > "+c[S],v);if(L.length==0)continue;$(L).siblings().length==0?$(L).parent().remove():$(L).remove()}}E&&(m&&$(i).append(v),console.log("privileges changed for "+d))}$("ace inherited",i).closest("ace").remove(),$("ace protected",i).closest("ace").remove();var A=new XMLSerializer,O='<?xml version="1.0" encoding="utf-8"?>\n'+A.serializeToString(i[0]);debug&&console.log(O)}if(n=="new"){var l=$(".label:contains("+ui.owner+") ~ .value",t),d=$(l).data("principal"),M=$(l).text(),r=$(document).caldav("calendars"),_=$.fn.caldav.principals[$.fn.caldav.principalMap[d]].calendarHome;if(_.length<3)var _=d;_=_+guid()+"/";var p=$("#callist > li > span:contains("+M+")").next(),f=r.length,D=a["calendar-color"].value;console.log("color "+D);var P=styles.getStyleSheet("calstyle");P.updateRule(".calendar"+f,{color:D}),P.updateRule(".calendar"+f+":hover",{"background-color":D}),P.updateRule(".calendar"+f+"bg",{"background-color":D}),r[f]={},r[f].order=a["calendar-order"].value,r[f].displayName=a.displayname.value,r[f].desc=a["calendar-description"].value,r[f].href=_+"/",r[f].url=$(".jqcaldav:first").data("caldavurl").replace(/([a-z])\/.*$/,"$1")+_+"/";var H=$('<li class="calendar'+f+'" order="'+r[f].order+'" title="'+r[f].desc+'"><input type="checkbox" id="calendar'+f+'" checked="true" /><span >'+r[f].displayName+"</span></li>");$(H)[0].addEventListener("drop",calDrop,!0),$(H)[0].addEventListener("dragenter",calDragEnter,!0),$(H)[0].addEventListener("dragover",calDragOver,!0),$(H).click(selectCalendar),$(H).dblclick(editCalendar),$(H).data(r[f]),$(p).append(H),eventSort(p)}else{(r[n].perms.all||r[n].perms.write||r[n].perms["write-acl"])&&$.acl({url:r[n].href,username:$.fn.caldav.options.username,password:$.fn.caldav.options.password,data:O,complete:function(e,t){if(t!="success")alert("error setting privileges");else{var r=$(O);$("acl",$.fn.caldav.calendarData[n].xml).replaceWith(r)}}});if(a["calendar-color"]!=undefined){var D=a["calendar-color"].value;$.fn.caldav.calendarData[n].color=D;var P=styles.getStyleSheet("calstyle");P.updateRule(".calendar"+n,{color:D}),P.updateRule(".calendar"+n+":hover",{"background-color":D}),P.updateRule(".calendar"+n+"bg",{"background-color":D})}a["calendar-order"]!=undefined&&($("#callist .calendar"+n).attr("order",a["calendar-order"].value),$.fn.caldav.calendarData[n].order=a["calendar-order"].value,eventSort($("#callist .calendar"+n).parent())),a["calendar-description"]!=undefined&&($("#callist .calendar"+n).attr("title",a["calendar-description"].value),$.fn.caldav.calendarData[n].desc=a["calendar-description"].value)}return u&&(console.log(a),n=="new"?$(document).caldav("makeCalendar",{url:_},n,a):$(document).caldav("updateCollection",{},n,a)),!0}function delCalendar(e){var t=$("#caldialog > ul").data("calendar"),n=!1,r=$(document).caldav("calendars");return r[t]==undefined&&(r=$("#wcal").data("subscribed"),n=!0),$("#wcal").data("drop-question",t),questionBox(deleteCalQuestion[0]+r[t].displayName,deleteCalQuestion[1],function(e){var t=$("#wcal").data("drop-question");$("#wcal").removeData("drop-question");if(e==1){var n=$(document).caldav("calendars");if(n[t]==undefined){var n=$("#wcal").data("subscribed");$(".calendar"+t).remove();for(var r in subscriptions)subscriptions[r]!=undefined&&subscriptions[r].url==n[t].url&&subscriptions[r].name==n[t].displayName&&delete subscriptions[r];delete n[t],$("#wcal").data("subscribed",n);var i="",n=$(document).caldav("calendars");for(var r in n)if(n[r].mailto.match(RegExp($("#name").val(),"i"))){i=n[r].principal;break}var s={0:{ns:"http://boxacle.net/ns/calendar/",name:"calendar-subscriptions",value:JSON.stringify(subscriptions)}};$(document).caldav("updateCollection",{url:i},i,s)}else $(document).caldav("delCalendar",t)}return}),!0}function deletedCalendar(e,t,n){n=="success",$(".calendar"+e).remove()}function editPrincipal(e){var t=$('<ul data-calendar="'+e.href+'" ></ul>');$(t).data("c",e.cal);var n={name:"name",desc:"description"},r=$.fn.caldav.collectionData,i=!1;if(r[e.cal]==undefined||!r[e.cal].perms["read-acl"])i=!0;else var s=e.cal;for(var o in n)$(t).append('<li><span class="label">'+ui[n[o]]+'</span><span class="value" data-prop="'+n[o]+'" data-value="'+(e[o]?e[o]:"")+'" contenteditable="true">'+(e[o]?e[o]:"")+"</span></li>");if(!i){var u=!1;if(r[s].perms.all||r[s].perms.write||r[s].perms["write-acl"])u=!0;var a=$("acl > ace:has(href)",r[s].xml),f=$("supported-privilege-set",r[s].xml),l=$('<li><span class="label" privileges="true" >'+ui.privileges+"</span></li>");$(l).hover(function(){$($("#wcal").data("popup")).css({overflow:"visible"})},function(){$($("#wcal").data("popup")).css({overflow:"auto"})});for(o=0;o<a.length;o++)$(l).append(privilegeBox(a[o],f,u));u&&$(l).append('<div class="completionWrapper"><div class="completion"></div></div><span class="value" data-principal="new principal" contenteditable="true">'+ui.add+"</span>"),$('span:[data-principal="new principal"]',l).focus(function(e){$($("#wcal").data("popup")).css({overflow:"visible"}),$(this).text()==ui.add&&$(this).text("")}),$('span:[data-principal="new principal"]',l).blur(function(e){$($("#wcal").data("popup")).css({overflow:"auto"}),$(this).text()==""&&$(this).text(ui.add);if($(this).attr("data-principal").length>1&&$(this).attr("data-principal")!="new principal"){var t=$("ace:has(authenticated)",r[s].xml);$(this).prev().before(privilegeBox($("<ace><principal><href>"+$(this).data("principal")+"</href></principal></ace>"),f,!0)),$(this).attr("data-principal","new principal"),$(this).removeData("principal"),$(this).text(ui.add)}}),$('span:[data-principal="new principal"]',l).keydown(completePrincipal),$(t).append(l)}$("#caldialog").empty(),$("#caldialog").css({overflow:"auto"}),$("[data-prop=color]",t).click(colorClicked),$("#caldialog").append(t),draggable($("#caldialog")),$("#caldialog").show(),$("#caldialog li span:contains(name) + span").focus(),$("#caldialog").append('<div class="button delete" tabindex="0">'+ui["delete"]+"</div>"),$("#caldialog").append('<div class="button done" tabindex="0" >'+ui.done+"</div>"),$("#caldialog .button").bind("click keypress",function(e){if(e.keyCode>0)if(e.keyCode!=32||e.keyCode!=13)return;$(this).hasClass("done")&&savePrincipal()==1&&($(e.target).closest(".calpopup").fadeOut(),$("#wcal").removeData("popup"),$(document).unbind("click",$("#wcal").data("edit_click")),$(document).unbind("keyup",$("#wcal").data("edit_keyup"))),$(this).hasClass("delete")&&delCalendar()==1&&($(e.target).closest(".calpopup").fadeOut(),$("#wcal").removeData("popup"),$(document).unbind("click",$("#wcal").data("edit_click")),$(document).unbind("keyup",$("#wcal").data("edit_keyup")))}),$("#wcal").data("popup","#caldialog"),$("#wcal").data("clicked",e.target),$(document).click($("#wcal").data("edit_click")),$(document).keyup($("#wcal").data("edit_keyup"))}function savePrincipal(e){var t=$("#caldialog"),n=$("#caldialog ul").data("calendar"),r=$("#caldialog ul").data("c"),i=$.fn.caldav.collectionData,s={displayname:"name","calendar-description":"description"},o={displayname:"DAV:","calendar-color":"http://apple.com/ns/ical/","calendar-description":"urn:ietf:params:xml:ns:caldav","calendar-order":"http://apple.com/ns/ical/"},u=!1,a=!1,f=!1,l={};if(i[r])var c=$("acl",i[r].xml).clone();else var c=[];for(var h in s){var p=$(".label:contains("+ui[s[h]]+") ~ .value",t);$(p).length>0&&$(p).text()!=$(p).data("value")&&(l[h]={name:h,value:$(p).text(),ns:o[h]},u=!0)}if(i[r].perms.all||i[r].perms.write||i[r].perms["write-acl"]){f=!0;var d=["all","bind","unbind","unlock","read","read-acl","read-free-busy","read-privileges","write","write-content","write-properties","write-acl","schedule-send","schedule-send-invite","schedule-send-reply","schedule-send-freebusy","schedule-deliver","schedule-deliver-invite","schedule-deliver-reply","schedule-query-freebusy"],v=$(".label:contains("+ui.privileges+") ~ .privilegeOwner",t);for(var m=0;m<v.length;m++){var g=$(v[m]).data("principal"),y=$("ace",c).filter(function(){if($("principal > href ",this).text()==g)return!0}),b=!1;if(y.length==0){b=!0;var y=document.createElementNS("DAV:","ace"),w=document.createElementNS("DAV:","principal");y.appendChild(w);var E=document.createElementNS("DAV:","href");E.appendChild(document.createTextNode(g)),w.appendChild(E);var S=document.createElementNS("DAV:","grant");y.appendChild(S)}else var S=$("grant",y)[0];var x=[],T=!1;for(var N in d){var C=$('li[data-priv="'+d[N]+'"]',v[m]),k=$(C).hasClass("granted"),L=$(C).data("granted");k&&x.push(d[N]);if(k&&L=="no"||!k&&L=="yes")T=!0;if(k&&L=="no"){var A=document.createElementNS("DAV:","privilege"),O=document.createElementNS("DAV:",d[N]);A.appendChild(O),S.appendChild(A)}if(!k&&L=="yes"){var M=$("grant > privilege > "+d[N],y);if(M.length==0)continue;$(M).siblings().length==0?$(M).parent().remove():$(M).remove(),$("grant",y).children().length==0&&$(y).remove()}}T&&(a=!0,b&&$(c).append(y),console.log("privileges changed for "+g),u=!0)}$("ace inherited",c).closest("ace").remove(),$("ace protected",c).closest("ace").remove(),$("privilege > *",c).empty(),$("owner,authenticated,unauthenticated",c).empty(),console.log(c);var _=new XMLSerializer,D='<?xml version="1.0" encoding="utf-8"?>\n'+XML(_.serializeToString(c[0])).toXMLString();debug&&console.log(D)}if(n=="new"){var p=$(".label:contains("+ui.owner+") ~ .value",t),g=$(p).data("principal"),P=$(p).text(),H=g+guid(),i=$(document).caldav("calendars"),m=$("#callist > li > span:contains("+P+")").next(),h=i.length,B=l["calendar-color"].value;console.log("color "+B);var j=styles.getStyleSheet("calstyle");j.updateRule(".calendar"+h,{color:B}),j.updateRule(".calendar"+h+":hover",{"background-color":B}),j.updateRule(".calendar"+h+"bg",{"background-color":B}),i[h]={},i[h].order=l["calendar-order"].value,i[h].displayName=l.displayname.value,i[h].desc=l["calendar-description"].value,i[h].href=H+"/",i[h].url=$(".jqcaldav:first").data("caldavurl").replace(/([a-z])\/.*$/,"$1")+H+"/";var F=$('<li class="calendar'+h+'" order="'+i[h].order+'" title="'+i[h].desc+'"><input type="checkbox" id="calendar'+h+'" checked="true" /><span >'+i[h].displayName+"</span></li>");$(F)[0].addEventListener("drop",calDrop,!0),$(F)[0].addEventListener("dragenter",calDragEnter,!0),$(F)[0].addEventListener("dragover",calDragOver,!0),$(F).click(selectCalendar),$(F).dblclick(editCalendar),$(F).data(i[h]),$(m).append(F),eventSort(m)}else l["displayname"]!=undefined&&($('#callist ul[data-principal="'+n+'"]').parent().children("span").text(l.displayname.value),$.fn.caldav.principals[r].displayName=l.displayname.value,$.fn.caldav.collectionData[r].displayName=l.displayname.value),l["calendar-description"]!=undefined&&($('#callist ul[data-principal="'+n+'"]').parent().children("span").attr("title",l["calendar-description"].value),$.fn.caldav.principals[r].desc=l["calendar-description"].value,$.fn.caldav.collectionData[r].desc=l["calendar-description"].value);return u&&(console.log(l),n=="new"?$(document).caldav("makeCalendar",{url:H},n,l):$(document).caldav("updateCollection",{},n,l),f&&a&&$.acl({url:i[r].href,username:$.fn.caldav.options.username,password:$.fn.caldav.options.password,data:D,complete:function(e,t){console.log(D);if(t!="success")alert("error setting privileges");else{var n=$(D);$("acl",$.fn.caldav.collectionData[r].xml).replaceWith(n)}}})),!0}function completePrincipal(e){if((e.keyCode==13||e.keyCode==9)&&$(e.target).prev().find(".selected").length>0)return $(e.target).text($(e.target).prev().find(".selected").text()),$(e.target).attr("data-principal",$(e.target).prev().find(".selected").attr("data-href")),$(e.target).attr("data-email",$(e.target).prev().find(".selected").attr("data-mail")),$(e.target).data("principal",$(e.target).prev().find(".selected").attr("data-href")),$(e.target).data("email",$(e.target).prev().find(".selected").attr("data-mail")),$(e.target).data("value",$(e.target).prev().find(".selected").attr("data-mail")),$(e.target).data("new-email",$(e.target).prev().find(".selected").attr("data-mail")),$(e.target).data("new-text",$(e.target).prev().find(".selected").text()),$(e.target).prev().children(".completion").empty(),$(e.target).removeData("matches"),$(e.target).blur(),e.preventDefault(),!1;if((e.keyCode==13||e.keyCode==9)&&$(e.target).text().length>1&&$(e.target).data("matches"))return $(e.target).text($(e.target).data("matches")[0].name),$(e.target).attr("data-principal",$(e.target).data("matches")[0].href),$(e.target).attr("data-email",$(e.target).data("matches")[0].email),$(e.target).data("new-email",$(e.target).data("email")[0].email),$(e.target).data("new-text",$(e.target).data("matches")[0].name),$(e.target).prev().children(".completion").empty(),$(e.target).blur(),e.preventDefault(),!1;if(e.keyCode==13)return e.preventDefault(),!1;if(e.keyCode==40)return $(e.target).prev().children(".completion").children(".selected").length>0?$(e.target).prev().children(".completion").children(".selected").removeClass("selected").next().addClass("selected"):$(e.target).prev().children(".completion").children().first().addClass("selected"),e.preventDefault(),!1;if(e.keyCode==38)return $(e.target).prev().children(".completion").children(".selected").length>0?$(e.target).prev().children(".completion").children(".selected").removeClass("selected").prev().addClass("selected"):$(e.target).prev().children(".completion").children().last().addClass("selected"),e.preventDefault(),!1;var t;if(e.keyCode==8){t=$(e.target).text().slice(0,-1);if($(e.target).text().length<1)return e.preventDefault(),!1}else t=$(e.target).text()+String.fromCharCode(e.keyCode);var n=[9,13,27,33,34,35,36,37,38,39,40,45,46];t.length>1&&n.indexOf(e.keyCode)==-1?$(document).caldav("searchPrincipals",{url:$(".jqcaldav:first").data("caldavurl")},"displayname",t,function(t){var n=new Array,r="",i=$("response",t);for(var s=0;s<i.length;s++)n.push({name:$("displayname",i[s]).text(),href:$(">href:eq(0)",i[s]).text(),mail:$("href:contains('mailto')",i[s]).text()}),r+='<div data-href="'+$("href:eq(0)",i[s]).text()+'" data-mail="'+$("href:contains('mailto')",i[s]).text()+'">'+$("displayname",i[s]).text()+"</div>";$(e.target).data("matches",n);var o=$(e.target).position();$(e.target).prev().css({top:o.top,left:o.left}),$(e.target).prev().children(".completion").html(r),$(e.target).prev().children(".completion").children().first().addClass("selected"),$(e.target).prev().children(".completion").children().click(function(t){return $(e.target).text(t.target.textContent),$(e.target).attr("data-principal",$(t.target).data("href")),$(e.target).attr("data-email",$(t.target).data("email")),$(e.target).data("email",$(t.target).data("email")),$(e.target).data("new-text",$(t.target).text()),$(t.target).parent().empty(),$(e.target).blur(),t.stopPropagation(),t.preventDefault(),!1})}):$(e.target).prev().children(".complteion").children().length>0&&$(e.target).prev().children(".completion").empty()}function keyboardSelector(e){var t=$(e.target).prev().children(".completion");switch(e.keyCode){case 40:return $(".highlighted",t).length>0?$(".highlighted",t).removeClass("highlighted").first().next().addClass("highlighted"):$(t).children().first().addClass("highlighted"),$(".highlighted",t).length==0&&$(t).children().first().addClass("highlighted"),$(t).scrollTop($(".highlighted",t).position().top-$(t).height()/2),e.preventDefault(),!1;case 38:return $(".highlighted",t).length>0?$(".highlighted",t).removeClass("highlighted").first().prev().addClass("highlighted"):$(t).children().last().addClass("highlighted"),$(".highlighted",t).length==0&&$(t).children().last().addClass("highlighted"),$(t).scrollTop($(".highlighted",t).position().top-$(t).height()/2),e.preventDefault(),!1;case 32:if(e.spaceSelects!==!0)return!0;case 13:e.preventDefault();case 9:return $(".highlighted",t);case 8:return $(e.target).text().length==0&&e.preventDefault(),!1;case 27:return e.removeOnEscape===!0?$(this).prev().fadeOut(function(){$(this).remove()}):$(t).empty(),e.preventDefault(),"cancel"}if(e.search===!0&&!e.altKey&&!e.ctrlKey&&!e.metaKey&&String.fromCharCode(e.keyCode).match(/[A-Za-z0-9.,:\=+-]/)){var n=$.now(),r=$(e.target).data("lastKeypressTime");$(e.target).data("lastKeypressTime",n),e.preventDefault(),$(".highlighted",t).removeClass("highlighted");var i="";n-r<500&&(i=$(e.target).data("lastKeypressString")),i+=String.fromCharCode(e.keyCode),$(e.target).data("lastKeypressString",i);var s=new RegExp("^"+i,"i"),o=$(t).children().filter(function(e){return s.test($(this).text())}),s=new RegExp(i,"i");return $(o).length==0&&(o=$(t).children().filter(function(e){return s.test($(this).text())})),$(o).length==1?$(o).addClass("highlighted"):$(o).length>1&&$(o).addClass("highlighted"),!1}return!0}function dateScroll(e){if(e.wheelDelta==undefined)var t=e.detail;else var t=0-(Math.abs(e.wheelDelta)>=3?Math.abs(e.wheelDelta)>29?Math.round(e.wheelDelta/30):Math.round(e.wheelDelta/3):e.wheelDelta);Math.abs(t)>2&&(t=Math.round(t/3));var n=0;if(document.caretRangeFromPoint){var r=document.caretRangeFromPoint(e.originalEvent.pageX,e.originalEvent.pageY);n=r.startOffset}else e.originalEvent.rangeOffset?n=e.originalEvent.rangeOffset:(n=Math.round($(e.target).text().length*(e.offsetX/$(e.target).width())),console.log("offset "+n+"  from "+$(e.target).width()+"/"+e.offsetX));var i=String($(e.target).text()).replace(/^(\s*[0-9]{2,4}\s*[,./';: ]\s*[0-9]{2,4}\s*[,./';: ]\s*[0-9]{2,4}\s+).*$/,"$1").length;try{var s=(new Date).Zero().parsePrettyDate($(e.target).text())}catch(e){return}if(n<i)s.add("d",t),console.log("moved "+t+" @ dlen ="+i+" and off ="+n);else{var o=String($(e.target).text()).slice(i-1).split(/:/);n>i+o[0].length?(Number(o[1])%5!=0&&(Number(o[1])<=57?s.setUTCMinutes(Math.round(Number(o[1])/5)*5):s.setUTCMinutes(60)),s.add("M",t*5)):s.add("h",t),console.log("moved "+t+" @ dlen ="+i+" hlen ="+o[0].length+" and off ="+n)}$(e.target).text(s.prettyDate())}function getInbox(e){$.fn.caldav.inboxMap&&$.fn.caldav.inboxMap[$.fn.caldav.data.myPrincipal]&&$(document).caldav("getAll",{},gotInbox,"VEVENT",$.fn.caldav.inboxMap[$.fn.caldav.data.myPrincipal])}function gotInbox(e){for(var t=0;t<e.length;t++){if(e[t].text.length<10)continue;var n=new String(e[t].text),r=new iCal(n);r.eTag=e[t].etag;for(var i in r.ics)insertInvite(e[t].href,r.ics[i])}}function showVisTodos(e){if($(e.target).prev().hasClass("completionWrapper")){$("#caltodo .completionWrapper").remove();return}var t=String($("#caltodo > ul").attr("show")).split(","),n=["COMPLETED","CANCELLED","NEEDS-ACTION","IN-PROCESS","past due","upcoming"],r=[];for(var i=0;i<n.length;i++)t.indexOf(n[i])>-1&&r.push(valueNames[n[i]]);txt=r.join(","),console.log(txt),$(e.target).text(txt);var s=buildOptions({target:e.target,options:["COMPLETED","CANCELLED","NEEDS-ACTION","IN-PROCESS","past due","upcoming"],text:valueNames,none:!1,multiselect:",",callback:showHideTodos});$(s).css({width:"8em","text-align":"left"}),$(e.target).text(ui.show),$("#caltodo .completionWrapper").remove(),$(e.target).before(s)}function showHideTodos(e){var t=$(e).text();console.log(t);var n=String(t).split(","),r=["COMPLETED","CANCELLED","NEEDS-ACTION","IN-PROCESS","past due","upcoming"],i=[];for(var s=0;s<r.length;s++)n.indexOf(valueNames[r[s]])>-1&&i.push(r[s]);t=i.join(","),$("#caltodo > ul").attr("show",t),console.log(t),settings.todoShow=t,saveSettings(!1),$(e).text(ui.show),$("#caltodo .completionWrapper").remove(),$("#caltodo .event").each(function(e,t){todoVisible(t)?$(t).removeClass("hidden"):$(t).addClass("hidden")})}function showSortTodos(e){if($(e.target).prev().hasClass("completionWrapper")){$("#caltodo .completionWrapper").remove();return}$(e.target).text($("#caltodo > ul").attr("sort"));var t=buildOptions({target:e.target,options:["priority","percent-complete","due","manual"],text:{priority:fieldNames.priority,"percent-complete":fieldNames["percent-complete"],due:fieldNames.due,manual:ui.manual},none:!1,callback:sortTodos});$(t).css({width:"8em","margin-left":"-2em","margin-top":"1em","text-align":"left"}),$(e.target).text(ui.sort),$("#caltodo .completionWrapper").remove(),$(e.target).before(t)}function sortTodos(e){var t=$(e).text(),n=$("#caltodo > ul").attr("sort");n==t?settings.todoSortReverse?settings.todoSortReverse=!1:settings.todoSortReverse=!0:t=="priority"?settings.todoSortReverse=!0:settings.todoSortReverse=!1,$("#caltodo > ul").attr("sort",t),settings.todoSort=t,saveSettings(!1),$(e).text(ui.sort),todoSort($("#caltodo ul"))}function todoVisible(e){var t=$("#caltodo > ul").attr("show"),n=!0,r=String(t).split(",");console.log(r),r.indexOf("COMPLETED")==-1&&($(e).attr("completed")||$(e).attr("status")=="completed")&&(n=!1),r.indexOf("CANCELLED")==-1&&$(e).attr("status")=="cancelled"&&(n=!1),r.indexOf("NEEDS-ACTION")==-1&&$(e).attr("status")=="needs-action"&&(n=!1),r.indexOf("IN-PROCESS")==-1&&$(e).attr("status")=="in-process"&&(n=!1);var i=$(e).attr("due");return r.indexOf("past due")==-1&&i!=undefined&&String(i).length>4&&i<$.now()&&(n=!1),r.indexOf("upcoming")==-1&&i!=undefined&&String(i).length>4&&i>$.now()&&(n=!1),n}function addEvents(e,t,n,r){var i=/([0-9]{4})([0-9]{2})([0-9]{2})([Tt]([0-2][0-9])([0-6][0-9])([0-9]{2}))?[Zz]?/,s;for(var o=0;o<e.length;o++){if(e[o].text.length<10)continue;s=$.now();var u=new String(e[o].text),a=new iCal(u);perf[6].push($.now()-s),a.eTag=e[o].etag;for(var f in a.ics)insertEvent(e[o].href,a.ics[f],t,n,r),perf[7].push($.now()-s);perf[8].push($.now()-s)}}function addToDos(e,t){var n=/([0-9]{4})([0-9]{2})([0-9]{2})([Tt]([0-2][0-9])([0-6][0-9])([0-9]{2}))?[Zz]?/;for(var r=0;r<e.length;r++){if(e[r].length<10)continue;var i=new String(e[r].text),s=new iCal(i);for(var o in s.ics)insertTodo(e[r].href,s.ics[o],t)}}function addSubscribedEvents(e,t,n){var r=$("#wcal").data("subscribed");if(e<0)for(var i in r){if(r[i].events==undefined)continue;for(var s in r[i].events.recurrence)s.TYPE=="vevent"&&insertEvent(r[i].src+"_event-"+s.vevent.uid,s,i,t,n);var o=(new Date(t)).YM();while(o<=n){for(var s in r[i].events.index[o.YM()]){var u=r[i].events.index[o.YM()][s];u.TYPE=="vevent"&&$("#wcal").queue(function(){insertEvent(r[i].src+"_event-"+String(u.vcalendar.vevent.uid),u,i,t,n),$(this).dequeue()})}o.add("m",1)}}else{i=e;for(var s in r[i].events.recurrence)s.TYPE=="vevent"&&insertEvent(r[i].src+"_event-"+s.vevent.uid,s,i,t,n);for(var s in r[i].events.ics)r[i].events.ics[s].TYPE=="vevent"&&r[i].events.ics[s].vcalendar.vevent.dtstart.DATE>t&&r[i].events.ics[s].vcalendar.vevent.dtstart.DATE<n&&insertEvent(r[i].src+"_event-"+r[i].events.ics[s].vcalendar.vevent.uid,r[i].events.ics[s],i,t,n)}}function insertEvent(e,t,n,r,i,s){var o="",u=(new Date).getTime(),a=$(document).caldav("calendars");if(typeof i!="object"&&typeof r!=object&&(i<$("#wcal").data("firstweek")||r>$("#wcal").data("lastweek")))return;if(t.vcalendar.vevent==undefined&&s==undefined){for(var f=0;f<t.vcalendar.length;f++)insertEvent(e,t,n,r,i,etag,f);return}if(t.vcalendar.vevent==undefined&&s>-1)var l=t.vcalendar[s].vevent;else var l=t.vcalendar.vevent;if(l.rrule!=undefined)var c=l.rrule.RECURRENCE.expandRecurrence(l.dtstart.VALUE,dateAdd(i,"d",7));var h=l.dtstart.DATE;if(l.dtend!=undefined)var p=l.dtend.DATE;else if(l.duration!=undefined){var p=new Date(h.getTime());p.addDuration(l.duration.DURATION),debug&&console.log(h,l.duration.DURATION)}else var p=h;var d=Math.floor((p-h)/100)*100,v=new Array;if(c!=undefined)for(var f in c)c[f]>r&&c[f]<i&&(v[f]=c[f]);else v[h.DayString()]=h;perf[0].push($.now()-u),$("#wcal li.calendar"+n+'[href="'+e+'"]').remove();var m=$("#wcal > #DOESNTEXIST");for(var f in v){var h=v[f];if(l.exdate!=undefined)if(l.exdate.DATES){if($.grep(l.exdate.DATES,function(e,t){return l.exdate.DATES[t].getTime()==h.getTime()?!0:!1}).length>0)continue}else if(l.exdate.DATE.getTime()==h.getTime())continue;if(m.length>0){var g=!1;for(var y=0;y<m.length;y++){var b=$(m[y]).data("ics");if(b.vcalendar.vevent==undefined)for(var w in b.vcalendar)b.vcalendar[w].vevent["recurrence-id"]!=undefined&&b.vcalendar[w].vevent["recurrence-id"].DATE==h&&(g=!0);else b.vcalendar.vevent["recurrence-id"]!=undefined&&b.vcalendar.vevent["recurrence-id"].DATE==h&&(g=!0)}if(g)continue}if(l.summary&&l.summary.VALUE!=undefined)var E=l.summary.VALUE;else var E="";perf[1].push($.now()-u);if(l.valarm!=undefined&&h.getTime()>u-864e5&&h.getTime()<u+3456e6&&settings.usealarms){var S=[];l.valarm.action!=undefined?S.push(l.valarm):S=l.valarm;for(var x in S){debug&&console.log("adding alert for "+E);if(S[x].trigger!=undefined&&S[x].action.VALUE=="AUDIO"||S[x].action.VALUE=="DISPLAY"){if(S[x].trigger.DURATION!=undefined){if(S[x].trigger.PROP&&S[x].trigger.PROP.related&&S[x].trigger.PROP.related=="END")var T=(new Date(p.getTime())).localTzRemove();else var T=(new Date(h.getTime())).localTzRemove();T.addDuration(S[x].trigger.DURATION)}else{if(S[x].trigger.DATE==undefined)continue;var T=S[x].trigger.DATE}var N="";S[x].description!=undefined?N=S[x].description:N=E+" "+(T.getTime()-u>864e5?h.prettyDate():h.prettyTime());if(T.getTime()-u<=3e4)continue;debug&&console.log("alert in "+(T.getTime()-u)/1e3+" seconds: "+N),alerts.push(window.setTimeout(function(){$("#calalertsound")[0].play(),alert(N),alerts.shift()},T.getTime()-u))}}}if(d<=864e5){if(d<864e5){o=h.prettyTime()+" ";var C=h.TimeString()}else var C=0;o+=E;var k=l.transp!=undefined?l.transp.VALUE:"TRANSPARENT",L=l.status!=undefined?'status="'+l.status.VALUE+'"':"",A=0+parseInt(d/9e5)*15;debug&&console.log("duration",A,d),A>=(settings.end.getLongMinutes()-settings.start.getLongMinutes())/25*15&&(A=1);var O=parseInt(C/1e4)*100;O+=Math.round((parseInt(C/100)-O)/15)*15;var M=new Array;if(l["recurrence-id"]!=undefined){if(String(l.uid.VALUE).length>0)var M=$("#day_"+l["recurrence-id"].DATE.DayString()+' li[uid="'+l.uid.VALUE+'"]').detach();else var M=$("#day_"+l["recurrence-id"].DATE.DayString()+' li[instance="'+h.DateString()+'"]').detach();var _=$("#wcal").data("cal"+n+e);typeof _!="object"&&(_=new Object),_[l["recurrence-id"].VALUE]=eventcount,$("#wcal").data("cal"+n+e,_);var D=!0}if(M.length==0)var M=$('<li class="event calendar'+n+" time"+O+'" data-duration="'+A+'" draggable="true" data-time="'+C+'" href="'+e+'" eventcount="'+eventcount+'" uid="'+l.uid.VALUE+'" instance="'+h.DateString()+'" transparent="'+k+'" '+L+" >"+o+"</li>");$(M).data("ics",t),$(M).attr("owner",a[n].owner),$(M).attr("sequence",0),l.sequence!=undefined&&$(M).attr("icssequence",l.sequence.VALUE),l["recurrence-id"]!=undefined?$(M).attr("original",0):$(M).attr("original",1);if(a[n].perms.write||a[n].perms["write-content"])$(M).click(eventClick),$(M)[0].addEventListener("dragstart",calDragStart,!0),$(M)[0].addEventListener("dragend",calDragEnd,!0),$(M)[0].dragDrop!=undefined&&($(M)[0].addEventListener("dragover",calDragOver,!0),$(M)[0].addEventListener("drag",calDragOver,!0),$(M)[0].addEventListener("mousemove",function(e){window.event.button==1&&e.currentTarget.dragDrop()},!0));$(M).hover(eventHover,eventMouseout),perf[2].push($.now()-u),$("#calendar"+n).attr("checked")?$(M).hide():$(M).attr("lang","x-klingon"),globalEvents.href[e]==undefined||$("#day_"+h.DayString()+' li[href="'+e+'"]').length<1?($("#calendar"+n).attr("checked")?$(M).appendTo($("#day_"+h.DayString()+" ul.eventlist")).fadeIn():$(M).appendTo($("#day_"+h.DayString()+" ul.eventlist")),$(M).removeAttr("style"),eventcount++,eventSort($("#day_"+h.DayString()+" ul.eventlist"))):($("#calendar"+n).attr("checked")&&$(M).show(),$("#day_"+h.DayString()+' li[href="'+e+'"]').replaceWith(M),eventcount++,eventSort($("#day_"+h.DayString()+" ul.eventlist"))),globalEvents.href[e]=t,perf[4].push($.now()-u)}else{var C="0."+h.DayString();o+=E;var k=l.transp!=undefined?l.transp.VALUE:"OPAQUE",M=new Array,P=eventcount;if(l["recurrence-id"]!=undefined){if(String(l.uid.VALUE).length>0)var M=$("#day_"+l["recurrence-id"].DATE.DayString()+' li[uid="'+l.uid.VALUE+'"]').detach();else var M=$("#day_"+l["recurrence-id"].DATE.DayString()+' li[instance="'+h.DateString()+'"]').detach();var P=$(M).attr("eventcount");$('[eventcount="'+$(M).attr("eventcount")+']"').remove()}var M=$('<li class="event calendar'+n+" calendar"+n+'bg" draggable="true" data-time="'+C+'" href="'+e+'" eventcount="'+P+'" uid="'+l.uid.VALUE+'" instance="'+h.DateString()+'" transparent="'+k+'" >'+o+"</li>");$(M).attr("owner",a[n].owner),s!=undefined&&(t.current=s),$(M).data("ics",t),l["recurrence-id"]!=undefined?$(M).attr("original",0):$(M).attr("original",1),l.sequence!=undefined&&$(M).attr("icssequence",l.sequence.VALUE),$(M).addClass("multiday");if(a[n].perms.write||a[n].perms["write-content"])$(M).click(eventClick),$(M)[0].addEventListener("dragstart",calDragStart,!0),$(M)[0].addEventListener("dragend",calDragEnd,!0),$(M)[0].dragDrop!=undefined&&$(M)[0].addEventListener("mousemove",function(e){window.event.button==1&&e.currentTarget.dragDrop()},!0);$(M).hover(eventHover,eventMouseout),perf[2].push($.now()-u),$("#calendar"+n).attr("checked")?($(M).hide(),$(M).attr("lang","x-klingon")):$(M).attr("lang","x-klingon"),eventcount++;for(var H=0;H*864e5<d;H++){var B=new Date(h.getTime()+H*864e5),j=$(M).clone(!0);$(j).attr("sequence",H),H==0&&$(j).addClass("eventstart"),(H+1)*864e5>=d&&$(j).addClass("eventend");if(a[n].perms.write||a[n].perms["write-content"])$(j)[0].addEventListener("dragstart",calDragStart,!0),$(j)[0].addEventListener("dragend",calDragEnd,!0);$("#day_"+B.DayString()+' li[href="'+e+'"]').length<1&&($("#calendar"+n).attr("checked")?$(j).appendTo($("#day_"+B.DayString()+" ul.eventlist")).fadeIn():$(j).appendTo($("#day_"+B.DayString()+" ul.eventlist")),$(j).attr("style",""),eventSort($("#day_"+B.DayString()+" ul.eventlist"))),H==0&&$(M).html("&nbsp;")}globalEvents.href[e]=t,perf[5].push($.now()-u)}}}function perfStats(){var e=[],t,n;for(var r=0;r<perf.length;r++){e[r]=0,t=perf[r][0],n=perf[r][0];for(var i=0;i<perf[r].length;i++)e[r]+=perf[r][i],perf[r][i]<t&&(t=perf[r][i]),perf[r][i]>n&&(n=perf[r][i]);console.log(r+" count: "+i+" min:"+t+" max:"+n+" median:"+(t+(n-t)/2)+" avg:"+e[r]/i)}}function insertTodo(e,t,n){var r=t.TYPE,i=t.vcalendar[r]["x-apple-sort-order"],s="",o=$(document).caldav("calendars");s+=t.vcalendar[r].summary.VALUE;if(t.vcalendar[r].uid)var u=t.vcalendar[r].uid.VALUE;else var u="";var a=$('<li class="event calendar'+n+'" data-time="'+i+'" href="'+e+'" uid="'+u+'" draggable="true" >'+s+"</li>");$(a).attr("owner",o[n].owner),t.vcalendar[r].due&&t.vcalendar[r].due.DATE&&$(a).attr("due",t.vcalendar[r].due.DATE.getTime()),$(a).attr("completed",t.vcalendar[r].completed),$(a).attr("priority",t.vcalendar[r].priority),$(a).attr("percent-complete",t.vcalendar[r]["percent-complete"]),$(a).attr("status",t.vcalendar[r].status),$(a).data("ics",t),$(a).hover(eventHover,eventMouseout);if(o[n].perms.write||o[n].perms["write-content"])$(a).click(eventClick),$(a)[0].addEventListener("dragstart",calDragStart,!0),$(a)[0].addEventListener("dragend",calDragEnd,!0);$('#caltodo ul li[href="'+e+'"]').length>0&&$('#caltodo ul li[href="'+e+'"]').remove(),$("#calendar"+n).attr("checked")?todoVisible(a)?$(a).hide().appendTo($("#caltodo ul")).fadeIn("fast",function(){$(this).removeAttr("style")}):$(a).addClass("hidden").appendTo($("#caltodo ul")):$(a).appendTo($("#caltodo ul")),todoSort($("#caltodo ul"))}function insertInvite(e,t){var n=t.TYPE,r="";if(!t.vcalendar.method)return;t.vcalendar[n].summary&&(r+=t.vcalendar[n].summary.VALUE);if(t.vcalendar[n].uid)var i=t.vcalendar[n].uid.VALUE;else{debug&&console.log(e+" is invalid, no uid");var i=""}if(t.vcalendar[n].dtstart)var s=t.vcalendar[n].dtstart.DATE.getTime();else var s=1;var o="";t.vcalendar[n].organizer&&(o=String(t.vcalendar[n].organizer)),$('#calinvites .event[href="'+e+'"]').length>0&&$('#calinvites .event[href="'+e+'"]').remove();var u=$('<li class="event calendar0" data-method="'+t.vcalendar.method+'" data-time="'+s+'" href="'+e+'" uid="'+i+'" data-from="'+o+'" >'+r+"</li>");$(u).attr("status",t.vcalendar[n].status),$(u).data("ics",t),$(u).hover(eventHover,eventMouseout),$(u).click(inviteClick),$(u).appendTo($("#calinvites"))}function inviteClick(e){$("#calpopupe").remove(),$("#wcal").removeData("popup"),e.stopPropagation(),eventHover(e);var t=$($("#wcal").data("popup")),n=$($(t).data("event")).attr("href"),r=$(document).caldav("calendars"),i=$($(t).data("event")).attr("class").match(/calendar(\d+)/)[1];$("#calpopup").clone(!0).attr("id","calpopupe").removeClass("left right bottom").appendTo("#calwrap"),$("#wcal").data("popup","#calpopupe"),$("#calpopupe").data("overflow",0),$("#calpopup").hide();var s=$("#calpopupe").innerHeight()-$("#calpopupe").height();$("#calpopupe > ul").outerHeight()+s*1.5+10>$("#calpopupe").height()&&$("#calpopupe").height($("#calpopupe > ul").outerHeight()+s*1.5+10),$("#calpopupe").data("fields",fieldNames),$("#calpopupe").css("opacity",1);var o=$(e.target).data("method");o=="REQUEST"?$("#calpopupe").append('<div class="schedulebuttons group"><div class="button accept" tabindex="0">'+ui.accept+'</div><div class="button maybe" tabindex="0">'+ui.maybe+'</div><div class="button decline" tabindex="0">'+ui.decline+"</div></div>"):(o=="CANCEL"||o=="REPLY")&&$("#calpopupe").append('<div class="button done" tabindex="0">'+ui.done+"</div>"),debug&&($("#calpopupe").append('<div class="button tweak" style="position:absolute;bottom:5px;left:70px; width:40px;" tabindex="0">tweak</div>'),$("#calpopupe .tweak").bind("click",function(e){var t=$($("#wcal").data("popup")),n=r[i],s=$('<textarea id="eventsource" style="position:absolute;top:0;left:0;background:grey; overflow-y: auto; white-space: pre;" cols="80" rows="30" contenteditable="true" ></textarea>'),o=$('<div id="eventsave" style="position:absolute;bottom:25px;left:70px; width:40px;" class="button">save</div>'),u=$($(t).data("event")).data("ics");$(s).text(u.PARENT.printiCal()),$(o).click(function(e){var t=(new iCal($("#eventsource").val())).ics[0],n=$($("#wcal").data("popup")),r=$($(n).data("event")).attr("href"),i=$($(n).data("event")).attr("class").match(/calendar(\d+)/)[1];$('[href="'+r+'"]').fadeOut("fast",function(){$(n).remove()}),$(document).caldav("putEvent",{url:r},t.PARENT.printiCal()),insertEvent(r,t,i,$("#wcal").data("firstweek"),$("#wcal").data("lastweek"))}),$("#calpopupe").append(s),$("#calpopupe").append(o)})),$("#calpopupe .button").bind("click keypress",inviteButtonClick),draggable($("#calpopupe")),$("#calpopupe").show(),$("#wcal").data("clicked",e.target),$(document).click($("#wcal").data("edit_click")),$(document).keyup($("#wcal").data("edit_keyup"))}function inviteButtonClick(e){if(e.keyCode>0)if(e.keyCode!=32||e.keyCode!=13)return;var t=$($("#calpopupe").data("event")),n=$(t).data("ics");if($(t).data("method")=="CANCEL"){var r=$(t).attr("href");$(document).caldav("delEvent",{url:r});var i=$.fn.caldav.data.myPrincipal,s=$('#wcal .event[uid="'+n.vcalendar[n.TYPE].uid+'"], #caltodo .event[uid="'+n.vcalendar[n.TYPE].uid+'"]').filter("[owner^="+i+"]");if(s.length>0&&$(s).parents("#calinvites").length==0){var o=$(s).attr("href");$(s).remove(),$(document).caldav("delEvent",{url:o})}!$.fn.caldav.supports["calendar-auto-schedule"]}else if($(t).data("method")=="REPLY"){var r=$(t).attr("href");$(document).caldav("delEvent",{url:r}),$('#calinvites [href="'+r+'"]').remove(),!$.fn.caldav.supports["calendar-auto-schedule"]}else{var u=n.vcalendar[n.TYPE].attendee;if(typeof u!="object"){debug&&console.log("attendee missing from event"),$(document).unbind("click",$("#wcal").data("edit_click")),$(document).unbind("keydown",$("#wcal").data("edit_keyup")),$("#calpopupe").fadeOut(),$("#wcal").removeData("popup"),$("#wcal").removeData("clicked");return}var a;$(e.target).text()==ui.accept&&(a="ACCEPTED"),$(e.target).text()==ui.maybe&&(a="TENTATIVE"),$(e.target).text()==ui.decline&&(a="DECLINED");if(u["VALUES"]==undefined)return;var f=u.VALUES;n.vcalendar.method&&delete n.vcalendar.method;var l=$.fn.caldav.principalMap[$.fn.caldav.data.myPrincipal],c="";for(var h=0;h<f.length;h++)/^mailto:/.test(u.VALUES[h])&&(u.PROPS[h].cn?c=c+", "+u.PROPS[h].cn+" <"+String(u.VALUES[h]).replace(/^mailto:/,"")+">":c=c+", "+String(u.VALUES[h]).replace(/^mailto:/,"")),$.fn.caldav.principalMap[f[h]]==l&&(u.PROPS[h].partstat=a);c=c.replace(/^, /,""),debug&&console.log(a,n.PARENT.printiCal());var i=$.fn.caldav.data.myPrincipal,s=$('#wcal .event[uid="'+n.vcalendar[n.TYPE].uid+'"], #caltodo .event[uid="'+n.vcalendar[n.TYPE].uid+'"]').filter('[owner^="'+i+'"]'),r=$(t).attr("href"),p="mailto:"+c+"?subject="+n.vcalendar[n.TYPE].summary+"&body="+n.PARENT.printiCal();console.log(p);if(!$.fn.caldav.supports["calendar-auto-schedule"]){var p="mailto:"+c+"?subject="+n.vcalendar[n.TYPE].summary+"&body="+n.PARENT.printiCal();console.log(p)}else if(s.length>0){var o=$(s).attr("href"),d=String($(s).attr("class")).replace(/.*calendar([0-9]+).*/,"$1"),v=$.fn.caldav.outboxMap[$.fn.caldav.data.myPrincipal]+guid()+".ics";$(s).remove(),n.TYPE=="vevent"&&insertEvent(o,n,d,$("#wcal").data("firstweek"),$("#wcal").data("lastweek")),n.TYPE=="vtodo"&&insertTodo(o,n,d,$("#wcal").data("firstweek"),$("#wcal").data("lastweek")),a=="DECLINED"?($(document).caldav("delEvent",{url:o,"Schedule-Reply":"F"}),$(s).remove()):$(document).caldav("putEvent",{url:o},n.PARENT.printiCal()),r.indexOf($.fn.caldav.inboxMap[$.fn.caldav.data.myPrincipal])>-1?($(document).caldav("delEvent",{url:r,"Schedule-Reply":"F"}),$(t).remove()):$('#invitewrap [uid="'+n.vcalendar[n.TYPE].uid+'"]').remove()}else{var o=$(t).attr("href").replace(/^.*\//,""),d=String($("#callist .selected").attr("class")).replace(/.*calendar([0-9]+).*/,"$1"),v=$.fn.caldav.outboxMap[$.fn.caldav.data.myPrincipal]+o;$.fn.caldav.calendarData[d].principal==$.fn.caldav.data.myPrincipal?o=$.fn.caldav.calendarData[d].href+o:o=$.fn.caldav.calendarData[0].href+o,a!="DECLINED"&&$(document).caldav("putNewEvent",{url:o},n.PARENT.printiCal()),$(document).caldav("delEvent",{url:r,"Schedule-Reply":"F"}),n.TYPE=="vevent"&&insertEvent(o,n,d,$("#wcal").data("firstweek"),$("#wcal").data("lastweek")),n.TYPE=="vtodo"&&insertTodo(o,n,d,$("#wcal").data("firstweek"),$("#wcal").data("lastweek"))}}$(document).unbind("click",$("#wcal").data("edit_click")),$(document).unbind("keydown",$("#wcal").data("edit_keyup")),$("#calpopupe").fadeOut(),$("#wcal").removeData("popup"),$("#wcal").removeData("clicked")}function updateIcs(e,t,n){var r,i=$(".jqcaldav:eq(0)").data("ics"+n),s=t.vcalendar;typeof i!="object"&&(i={cal:n,vtimezone:{},vevent:{},vtodo:{},vjournal:{},hrefs:{},uid:{}}),s.vtimezone!=undefined&&i.vtimezone[s.vtimezone.tzid.VALUE]==undefined&&(i.vtimezone[s.vtimezone.tzid.VALUE]=$.extend(!0,{},s.vtimezone));if(s.vevent!=undefined&&i.vevent[s.vevent.uid.VALUE+""+s.vevent.sequence!=undefined?s.vevent.sequence.VALUE:""]==undefined){var r=$.extend(!0,{},s.vevent);i.vevent[s.vevent.uid.VALUE+""+s.vevent.sequence!=undefined?s.vevent.sequence.VALUE:""]=r}if(s.vtodo!=undefined&&i.vtodo[s.vtodo.uid.VALUE+""+s.vtodo.sequence!=undefined?s.vtodo.sequence.VALUE:""]==undefined){var r=$.extend(!0,{},s.vtodo);i.vtodo[s.vtodo.uid.VALUE+""+s.vtodo.sequence!=undefined?s.vtodo.sequence.VALUE:""]=r}if(s.vjournal!=undefined&&i.vjournal[s.vjournal.uid.VALUE+""+s.vjournal.sequence!=undefined?s.vjournal.sequence.VALUE:""]==undefined){var r=$.extend(!0,{},s.vjournal);i.vjournal[s.vjournal.uid.VALUE+""+s.vjournal.sequence!=undefined?s.vjournal.sequence.VALUE:""]=r}i.hrefs[e]==undefined&&(i.hrefs[e]=new Array),i.hrefs[e].push(r),i.uid[r.uid]==undefined&&(i.uid[r.uid]=new Array),i.uid[r.uid].push(r),$(".jqcaldav:eq(0)").data("ics"+n,i)}function calDragEnter(e){var t="";return e.dataTransfer!=undefined&&(e.dataTransfer.dropEffect=="none"&&!e.altKey?e.dataTransfer.dropEffect="move":e.dataTransfer.dropEffect=="none"&&e.altKey&&(e.dataTransfer.dropEffect="copy"),t=e.dataTransfer.getData("type")),$("#wcal").has(e.target)&&!$("#caltodo").has(e.target)&&(e.target instanceof HTMLTableCellElement||e.target instanceof HTMLUListElement)?($(".drop").removeClass("drop"),$("#caldrop").detach().prependTo($(e.target).closest("td")),$(e.target).closest("td").addClass("drop")):$("#caltodo").has(e.target)&&$(e.target).closest("ul").addClass("drop"),$("#wcal").addClass("dragging"),e.preventDefault(),e.stopPropagation(),!1}function calDragLeave(e){return e.preventDefault(),e.stopPropagation(),!1}function calDragOver(e){var t="";e.dataTransfer!=undefined&&(e.dataTransfer.dropEffect=="none"&&!e.ctrlKey&&!e.altKey?e.dataTransfer.dropEffect="move":e.dataTransfer.dropEffect=="none"&&(e.ctrlKey||e.altKey)&&(e.dataTransfer.dropEffect="copy"),e.dataTransfer.effectAllowed="copyMove");var n=$(e.target).closest(".drop");if(n.length&&$("#wcal").data("dragging")!=undefined){var r=$($("#wcal").data("dragging")).attr("class").match(/calendar\d+bg/);$($("#wcal").data("dragging")).data("duration")==1?r=!0:r=!1;var i=$(n).offset();if($(e.target).parents("#wcal").length>0)if(!r&&($("#wcal.weekview").length>0||e.pageX-i.left<n[0].clientWidth/3)){var s=(settings.start.getLongMinutes()+Math.round((settings.end.getLongMinutes()-settings.start.getLongMinutes())/100*((e.pageY-i.top)/n[0].clientHeight))*100)/100,o=new Date;o.setUTCMinutes(0),o.setUTCHours(s),$("#caldrop").text(o.prettyTime()),$("#caldrop").css("top",i.top+(n[0].clientHeight-$("#caldrop")[0].clientHeight)/((settings.end.getLongMinutes()-settings.start.getLongMinutes())/100)*(s-settings.start.getLongMinutes()/100)+"px"),$("#caldrop").css("left",i.left+n[0].clientWidth/3+"px"),$("#caldrop").css("width",n[0].clientWidth*2/3+"px"),$("#caldrop").show()}else $("#caldrop").hide();else $("#caldrop").hide()}return e.target.dragDrop||(e.preventDefault(),e.stopPropagation()),!1}function calDrop(e){var t=$(".highlighted");e.otarget==undefined&&(e.otarget=e.currentTarget);if(e.multi!==!0&&t.length>0&&(e.dataTransfer!=undefined||e.originalEvent.dataTransfer!=undefined)){e.preventDefault();var n,r,i;i=0,$(e.target).parents("#wcal").length>0&&$($("#wcal").data("dragging")).parents("#wcal").length&&(n=(new Date).Zero().parseDate($($("#wcal").data("dragging")).closest("td").attr("id").match(/day_(\d+)/)[1]),r=(new Date).Zero().parseDate($(e.currentTarget).closest("td").attr("id").match(/day_(\d+)/)[1]),i=r.getTime()-n.getTime());if($($("#wcal").data("dragging")).hasClass("highlighted")){e.multi=!0;for(var s=0;s<t.length;s++)$("#wcal").data("dragging",t[s]),i!=0&&(n=(new Date((new Date).Zero().parseDate($(t[s]).closest("td").attr("id").match(/day_(\d+)/)[1]).getTime()+i)).DayString(),console.log("adjusting target to "+n),e.otarget=$("#day_"+n)[0]),console.log("dragging",t[s]),calDrop(e)}$(".highlighted").toggleClass(".highlighted");return}e.preventDefault(),$("#wcal").removeClass("dragging"),$(e.otarget).closest("td").removeClass("drop");var o=$("#wcal").data("dragging");e.preventOK=!0,e.cTarget=e.otarget;if(o!=undefined&&$(o).data("ics").TYPE=="vevent"&&$(o).data("ics").vcalendar.vevent.rrule!=undefined&&e.moveAll==undefined)return $("#wcal").data("drop-question",e),questionBox(dropquestion[0],dropquestion[1],function(e){var t=$("#wcal").data("drop-question");$("#wcal").removeData("drop-question"),t.moveAll=e==0?!0:!1,calDrop(t)}),!1;if($("#caldrop").css("display")=="none"||$(o).attr("class").match(/calendar\d+bg/))var u=undefined;else var u=(new Date).parsePrettyTime($("#caldrop").text());$(".drop").removeClass("drop"),$("#caldrop").detach().hide().appendTo("#wcal");if(o!=null){var a=$(e.otarget).parents("#callist").length;if(a>=1){$("#wcal").removeData("dragging");var f=$(o).attr("href"),l=$(o).data("ics"),c=$(e.otarget).closest("li").first().attr("class").match(/calendar(\d+)/)[1];!e.ctrlKey&&!e.altKey&&$('[href="'+f+'"]').detach();var h=$(document).caldav("calendars"),p=$(o).attr("class").match(/calendar([0-9]+)\s?/);if(p[1]!=undefined){if(!e.ctrlKey&&!e.altKey){debug&&console.log(" moving "+f+" to "+h[c].href+f.replace(/^.*\//,""));var d={url:window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:"")+f,headers:{Destination:h[c].href+f.replace(/^.*\//,""),Overwrite:"F","Content-type":undefined},username:$.fn.caldav.options.username,password:$.fn.caldav.options.password};$(document).caldav("moveEvent",d)}else{debug&&console.log(" copying "+f+" to "+h[c].href+f.replace(/^.*\//,""));var d={url:h[c].href+f.replace(/^.*\//,""),headers:{"If-None-Match":"*"},username:$.fn.caldav.options.username,password:$.fn.caldav.options.password};$(document).caldav("putNewEvent",d,l.PARENT.toString())}l.TYPE=="vevent"&&insertEvent(h[c].href+f.replace(/^.*\//,""),l,c,$("#wcal").data("firstweek"),$("#wcal").data("lastweek")),l.TYPE=="vtodo"&&insertTodo(h[c].href+f.replace(/^.*\//,""),l,c,$("#wcal").data("firstweek"),$("#wcal").data("lastweek"))}}else{var v=$(e.cTarget).closest("td");$("#wcal").removeData("dragging");var f=$(o).attr("href"),l=$(o).data("ics"),c=$(o).attr("class").match(/calendar(\d+)/)[1],m=$("#callist li.selected");m=$(m).attr("class").match(/calendar(\d+)/)[1];var h=$(document).caldav("calendars");if($(v).length==0){if(c==m&&(!e.ctrlKey||!e.altKey))return;v=$(e.cTarget).closest("#caltodo");var g=(new iCal("vtodo")).ics[0],y=g.vcalendar.vtodo;for(var s in l.vcalendar[l.TYPE])if(l.PARENT.components[l.TYPE].required.indexOf(s)>-1||l.PARENT.components[l.TYPE].optional.indexOf(s)>-1){if(l.PARENT.components.vtodo.required.indexOf(s)>-1||l.PARENT.components.vtodo.optional.indexOf(s)>-1)y[s]=l.vcalendar[l.TYPE][s]}else y[s]=l.vcalendar[l.TYPE][s];l.vcalendar[l.TYPE].dtend&&g.vcalendar.vtodo.due.UPDATE(l.vcalendar[l.TYPE].dtend),y.uid.VALUE=guid(),f=h[m].url+y.uid.VALUE;var d={url:f};$(document).caldav("putNewEvent",d,g.PARENT.toString()),insertTodo(f,g,m,$("#wcal").data("firstweek"),$("#wcal").data("lastweek"))}else if(l.TYPE=="vevent"){var n=(new Date).parseDate($(o).closest("td").attr("id").match(/day_(\d+)/)[1]),r=(new Date).parseDate($(v).closest("td").attr("id").match(/day_(\d+)/)[1]),b=l.vcalendar.vevent.dtend.DATE.getTime()-l.vcalendar.vevent.dtstart.DATE.getTime();if(e.ctrlKey||e.altKey){var g=$.extend(!0,{},l),b=r.getTime()-n.getTime(),c=$(o).attr("class").match(/calendar(\d+)/)[1];u!=undefined&&(b+=(u.getUTCHours()-l.vcalendar.vevent.dtstart.DATE.getUTCHours())*36e5),l.vcalendar.vevent.dtstart.ORIGDATE=l.vcalendar.vevent.dtstart,l.vcalendar.vevent.dtstart.UPDATE(new Date(l.vcalendar.vevent.dtstart.DATE.getTime()+b)),l.vcalendar.vevent.dtend.UPDATE(new Date(l.vcalendar.vevent.dtend.DATE.getTime()+b));var w=guid();l.vcalendar.vevent.uid.UPDATE(w);var E=h[c].href+w+".ics";debug&&console.log(" copying "+f+" to "+E);var d={url:E,headers:{"If-None-Match":"*"},username:$.fn.caldav.options.username,password:$.fn.caldav.options.password};$(document).caldav("putNewEvent",d,l.PARENT.toString()),insertEvent(E,l,c,$("#wcal").data("firstweek"),$("#wcal").data("lastweek"))}else{if(e.moveAll===!1){$(o).detach();var g=$.extend(!0,{},l);g.vcalendar.vevent.dtstamp=(new Date).DateString(),g.vcalendar.vevent.sequence.VALUE++;var S=n,x=l.vcalendar.vevent.rrule.RECURRENCE.expandRecurrence(l.vcalendar.vevent.dtstart.VALUE,dateAdd(S,"d",2));delete g.vcalendar.vevent.rrule,delete g.vcalendar.vevent.exdate;for(var s in x)if(x[s]>=S){var T=x[s];break}g.vcalendar.vevent["recurrence-id"]=g.PARENT.newField("RECURRENCE-ID",T,g.vcalendar.vevent.dtstart.PROP);var N=new Date(T.getTime()+(r.getTime()-n.getTime()));u!=undefined&&N.setUTCHours(u.getUTCHours());var C=l.vcalendar.vevent.dtend.DATE.getTime()-l.vcalendar.vevent.dtstart.DATE.getTime(),k=new Date(T.getTime()+C);g.vcalendar.vevent.dtstart=g.PARENT.newField("dtstart",N,g.vcalendar.vevent.dtstart.PROP),g.vcalendar.vevent.dtend=g.PARENT.newField("dtend",N,g.vcalendar.vevent.dtstart.PROP),g.PARENT=l.PARENT,l.PARENT.push(g.vcalendar);var d={url:f};$(document).caldav("putEvent",d,l.PARENT.toString()),insertEvent(f,g,c,$("#wcal").data("firstweek"),$("#wcal").data("lastweek"));return}if(e.moveAll===!0){$('li[uid="'+l.vcalendar.vevent.uid.VALUE+'"][original=1][href="'+f+'"]').detach();var b=r.getTime()-n.getTime();l.vcalendar.vevent.rrule.RECURRENCE.UNTIL!=undefined&&(l.vcalendar.vevent.rrule.RECURRENCE.UNTIL=(new Date).DateString(new Date((new Date).parseDate(l.vcalendar.vevent.rrule.RECURRENCE.UNTIL).getTime()+b)))}else{var b=l.vcalendar.vevent.dtend.DATE.getTime()-l.vcalendar.vevent.dtstart.DATE.getTime();$(o).detach(),$('li[uid="'+l.vcalendar.vevent.uid.VALUE+'"][original=1][href="'+f+'"]').detach()}var b=r.getTime()-n.getTime();u!=undefined&&(b+=(u.getUTCHours()-l.vcalendar.vevent.dtstart.DATE.getUTCHours())*36e5),l.vcalendar.vevent.dtstart.ORIGDATE=l.vcalendar.vevent.dtstart,l.vcalendar.vevent.dtstart.UPDATE(new Date(l.vcalendar.vevent.dtstart.DATE.getTime()+b)),l.vcalendar.vevent.dtend.UPDATE(new Date(l.vcalendar.vevent.dtend.DATE.getTime()+b));var d={url:f};$(document).caldav("putEvent",d,l.PARENT.toString()),insertEvent(f,l,c,$("#wcal").data("firstweek"),$("#wcal").data("lastweek"))}}else{var n=(new Date).parseDate($(v).closest("td").attr("id").match(/day_(\d+)/)[1]);u!=undefined&&(n.setUTCHours(u.getUTCHours()),n.setUTCMinutes(u.getUTCMinutes()));var g=(new iCal("vevent")).ics[0],y=g.vcalendar.vevent;for(var s in l.vcalendar[l.TYPE])if(l.PARENT.components[l.TYPE].required.indexOf(s)>-1||l.PARENT.components[l.TYPE].optional.indexOf(s)>-1){if(l.PARENT.components.vevent.required.indexOf(s)>-1||l.PARENT.components.vevent.optional.indexOf(s)>-1)y[s]=l.vcalendar[l.TYPE][s]}else y[s]=l.vcalendar[l.TYPE][s];g.vcalendar.vevent.dtstart.UPDATE(new Date(n.getTime())),g.vcalendar.vevent.dtend.UPDATE(n.add("h",1)),y.uid.VALUE=guid(),f=String(f).replace(/(\.[a-zA-Z]*)$/,"-1$1");var d={url:f};$(document).caldav("putNewEvent",d,g.PARENT.toString()),insertEvent(f,g,c,$("#wcal").data("firstweek"),$("#wcal").data("lastweek"))}}}else{if(e.dataTransfer!=undefined)var L=e.dataTransfer;else if(e.originalEvent.dataTransfer!=undefined)var L=e.originalEvent.dataTransfer;else var L={files:undefined};$("#wcal").removeData("dragging");if(window.File&&window.FileReader&&window.FileList&&L.files.length>0){var a=$(e.target).parents("#callist").length,A=L.files[0],O=new FileReader;a>=1&&(O.calendar=$(e.target).closest("li").first().attr("class").match(/calendar(\d+)/)[1]),O.onload=function(e){var t=$("#callist li.selected");e.target.calendar!=undefined?t=e.target.calendar:t.length>0?t=$(t).attr("class").match(/calendar(\d+)/)[1]:t=0;var n=$(document).caldav("calendars"),r=n[t].href+guid(),i={url:r};$(document).caldav("putNewEvent",i,e.target.result);var s=new iCal(String(e.target.result));insertEvent(r,s.ics[0],t,$("#wcal").data("firstweek"),$("#wcal").data("lastweek"))},O.readAsText(A,"UTF-8")}else var M=L.getData("text/plain"),_=L.getData("com.apple.pasteboard.promised-file-url"),D=L.getData("Text")}}function calDragStart(e){$("#wcal").data("popup",$("#calpopup")),$("#calpopup").data("event",e.target);if(e.target instanceof HTMLLIElement){var t=$(e.target).attr("class").match(/calendar(\d+)/)[1],n=$(document).caldav("calendars");if(n[t]==undefined)return e.preventDefault(),!1;e.dataTransfer.setDragImage&&typeof e.dataTransfer["setDragImage"]=="function"&&($("#wcal").has(e.target).length?e.dataTransfer.setDragImage(e.target,$(e.target).width()*(2/3),1):$("#caltodo").has(e.target).length?e.dataTransfer.setDragImage(e.target,$(e.target).width()*(2/3),1):e.dataTransfer.setDragImage(e.target));var r=$(e.target).data("ics").PARENT.printiCal();try{e.dataTransfer.setData("text/calendar",r),e.dataTransfer.setData("text/plain",r),e.dataTransfer.setData("Text",r),e.dataTransfer.setData("type",r.TYPE)}catch(i){e.dataTransfer.setData("Text",r)}return typeof window.btoa=="function"&&e.dataTransfer.setData("DownloadURL","text/calendar:event.ics:data:text/calendar;base64,"+window.btoa(r)),$("#wcal").data("dragging",$(e.target)),$("#wcal").addClass("dragging"),$("#calpopup").hide(),$("#calpopupe").length&&$("#calpopupe").hide(),n[t]!=undefined?e.dataTransfer.effectAllowed="copyMove":e.dataTransfer.effectAllowed="copy",!0}e.preventDefault()}function calDragEnd(e){$("#caldrop").hide(),$(".drop").removeClass("drop"),$("#wcal").removeData("dragging"),$("#wcal").removeClass("dragging")}function newevent(e){$("#calpopupe").remove(),$("#calpopup").clone(!0).attr("id","calpopupe").removeClass("left right bottom").appendTo("#calwrap"),$("#wcal").data("popup","#calpopupe"),$("#calpopup").hide(),$("#calpopupe").hide(),$("#calpopupe .value").attr("contentEditable",!0),$("#calpopupe .value").attr("spellcheck","true"),$(document).click($("#wcal").data("edit_click")),$(document).keyup($("#wcal").data("edit_keyup"));var t=$("#calpopupe"),n=$("#callist li.selected");n.length>0?n=$(n).attr("class").match(/calendar(\d+)/)[1]:n=0;var r,i;if($(e.target).closest("td").length>0){var s=$(e.target).closest("td").attr("id").match(/day_(\d+)/)[1];i=(new Date).parseDate(s),r="event"}else $(e.target).closest("div").attr("id")=="caltodo"&&(r="todo");var o=new iCal("v"+r);o=o.ics[0],o.vcalendar["v"+r].uid=o.PARENT.newField("UID",guid()),$(t).data("ics",o),$(t).attr("href","+&New Event"),$(t).empty(),$(t).append('<div class="button done" tabindex="0">'+ui.done+"</div>"),$(".calpopup .done").bind("click keypress",function(e){if(e.keyCode>0)if(e.keyCode!=32||e.keyCode!=13)return;eventEdited()==1&&($(document).unbind("click",$("#wcal").data("edit_click")),$(document).unbind("keydown",$("#wcal").data("edit_keyup")))});var u=$("<ul></ul>");$(u).append('<li><span class="label summary" data-field="summary" >'+fieldNames.summary+'</span><span class="value">'+ui[o.vcalendar["v"+r].summary.VALUE]+"</span></li>");if(r=="event")i.setUTCHours((new Date).getHours()),$(u).append('<li><span class="label ESTART" data-field="from" >'+fieldNames.dtstart+'</span><span class="value">'+i.prettyDate()+"</span></li>"),i.setUTCHours(i.getUTCHours()+1),$(u).append('<li><span class="label EEND" data-field="to" >'+fieldNames.dtend+'</span><span class="value">'+i.prettyDate()+"</span></li>"),$(u).append('<li><span class="label transp" data-field="show as" >'+fieldNames.transp+'</span><span class="value">'+valueNames.TRANSPARENT+"</span></li>"),$(".ESTART ~ .value",u).bind("mousewheel DOMMouseScroll",dateScroll),$(".ESTART ~ .value",u).addClass("date"),$(".EEND ~ .value",u).bind("mousewheel DOMMouseScroll",dateScroll),$(".EEND ~ .value",u).addClass("date");else if(r=="todo"){var i=new Date;i.setUTCDate((new Date).getDate()+1),$(u).append('<li><span class="label due" data-field="due" >'+fieldNames.due+'</span><span class="value">'+i.prettyDate()+"</span></li>"),$(".due ~ .value",u).bind("mousewheel DOMMouseScroll",dateScroll),$(".due ~ .value",u).addClass("date")}$(t).append(u);var a=$(e.target).offset(),f={width:300,height:350};a.left+e.target.offsetWidth+f.width>window.innerWidth?($(t).css({left:a.left-(f.width+17)}),$(t).removeClass("left").removeClass("right")):($(t).css({left:a.left+e.target.offsetWidth}),$(t).removeClass("right").addClass("left")),a.top+f.height>window.innerHeight?($(t).css({top:a.top-(f.height-100)}),$(t).addClass("bottom")):($(t).css({top:a.top}),$(t).removeClass("bottom")),$("#calpopupe .value,.evheader").attr("contentEditable",!0),$("#calpopupe .value").focus(fieldClick),$("#calpopupe .evheader").focus(),$("#calpopupe .value,.evheader").attr("spellcheck","true"),$("#calpopupe > ul").append('<li><div class="completionWrapper"><div class="completion"></div></div><span class="add button dropdown">'+ui.add+"</span></li>"),$("#calpopupe .add").click(addField),$("#calpopupe").data("event","#calpopupe"),$("#calpopupe").data("ics",o),draggable($("#calpopupe")),$("#wcal").data("clicked",$(t)),$(document).click($("#wcal").data("edit_click")),$(document).keyup($("#wcal").data("edit_keyup")),$("#calpopupe").show()}function eventHover(e){if($("#wcal").data("clicked")==e.target||$("#wcal").data("dragging")!=undefined)return;var t=$("#calpopup");if($("#wcal").data("popup"))return;$("#wcal").data("popup","#calpopup"),$(t).data("event",e.target);var n=$(e.target).data("ics");$(t).empty();var r=$("<ul></ul>").appendTo(t);if(n.vcalendar.vevent!=undefined){var i=new Date(n.vcalendar.vevent.dtstart.DATE.getTime()),s,o;n.vcalendar.vevent.dtend!=undefined?(s=new Date(n.vcalendar.vevent.dtend.DATE.getTime()),o=s-i):n.vcalendar.vevent.duration!=undefined?(s=new Date(i.getTime()),s.addDuration(n.vcalendar.vevent.duration.DURATION),o=s-i):(o=0,s=new Date(i.getTime()));if(n.vcalendar.vevent.rrule!=undefined){var u=(new Date).parseDate($(e.target).attr("instance")),a=n.vcalendar.vevent.rrule.RECURRENCE.expandRecurrence(n.vcalendar.vevent.dtstart.VALUE,dateAdd(u,"d",2)),f=new Array;if(a!=undefined){for(var l in a)if(a[l]>=u){i=a[l];break}s=new Date(i.getTime()+o)}}var c=new Array,h="vevent",p=!1,d=[];d.push("summary"),o==864e5&&(p=!0),d.push("ESTART"),n.vcalendar.vevent.dtend!=undefined?d.push("EEND"):debug&&console.log(n.vcalendar.vevent.duration.DURATION);for(var v in n.PARENT.components.vevent.optional)d.push(n.PARENT.components.vevent.optional[v]);n.vcalendar[h].valarm!=undefined&&d.push("valarm"),n.vcalendar[h].ESTART=n.PARENT.newField("DTSTART",i),n.vcalendar[h].EEND=n.PARENT.newField("DTEND",s)}else if(n.vcalendar.vtodo!=undefined){var d=[],h="vtodo";d.push("summary"),d.push("due"),n.vcalendar[h].valarm!=undefined&&d.push("valarm");for(var v in n.PARENT.components.vtodo.required)d.push(n.PARENT.components.vtodo.required[v]);for(var v in n.PARENT.components.vtodo.optional)d.push(n.PARENT.components.vtodo.optional[v])}/calendarserver-private-comments/.test($.fn.caldav.serverSupports)&&d.push("x-calendarserver-private-comment"),/calendarserver-private-events/.test($.fn.caldav.serverSupports)&&d.push("x-calendarserver-access");var m=[],g;for(var v in d){var y="";g=d[v];switch(d[v]){case"ESTART":var y=p?'extra="'+recurrenceUI.on+'"':"",b=fieldNames.dtstart;g="dtstart";break;case"EEND":var y=p?'extra="'+recurrenceUI.until+'"':"",b=fieldNames.dtend;g="dtend";break;case"DURATION":var b=fieldNames.duration;break;case"rrule":if(n.vcalendar[h][d[v]]&&n.vcalendar[h][d[v]].RECURRENCE)try{m.push(d[v]);var w=$('<li><span class="label"  data-field="'+fieldNames.rrule+'">'+fieldNames.rrule+"</span></li>");$(w).append(n.vcalendar[h][d[v]].RECURRENCE.editRecurrence()),$(r).append(w)}catch(e){console.log("error printing recurrence")}continue;case"valarm":m.push(d[v]);var w=$('<li><span class="label alarm"  data-field="'+ui.alarm+'">'+ui.alarm+"</span></li>");$(w).append(printAlarm(n.vcalendar[h][d[v]])),$(r).append(w);continue;case"attendee":if(n.vcalendar[h][d[v]]){m.push(d[v]);var w=$('<li><span class="label '+d[v]+'"  data-field="'+fieldNames[d[v]]+'">'+fieldNames[d[v]]+"</span></li>");$(w).append(printAttendee(n.vcalendar[h][d[v]])),$(r).append(w)}continue;default:if(m.indexOf(d[v])!=-1)continue;if(d[v]=="dtend"&&v!="to"&&v!="until")continue;if(!n.PARENT.fields[d[v]]&&d[v]!="summary")continue;if(!n.PARENT.fields[d[v]].visible)continue;var b=fieldNames[d[v]];m.push(d[v])}if(n.vcalendar[h][d[v]]){try{var E=String(n.vcalendar[h][d[v]])}catch(e){var E="";console.log("error printing "+d[v])}if(n.vcalendar[h][d[v]].length>1){var w=$('<li><span class="label '+d[v]+'" data-field="'+b+'" '+y+" >"+b+'</span><span class="value"></span></li>');$(".value",w).text(E),$(".value",w).attr("data-value",E)}else{var w=$('<li><span class="label '+d[v]+'" data-field="'+b+'" '+y+" >"+b+'</span><span class="value"></span></li>');$(".value",w).append(expandText(E)),$(".value",w).attr("data-value",E)}n.PARENT.fields[g].type=="date"&&$(".value",w).bind("mousewheel DOMMouseScroll",dateScroll),$(".value",w).addClass(n.PARENT.fields[g].type),d[v]=="url"&&urlHover(w),$(r).append(w)}}var S=$(e.target).offset(),x={width:300,height:350};S.left+e.target.offsetWidth+x.width>window.innerWidth?($(t).css({left:S.left-(x.width+30)}),$(t).removeClass("left").addClass("right")):($(t).css({left:S.left+e.target.offsetWidth+9}),$(t).removeClass("right").addClass("left")),S.top+x.height-40>window.innerHeight?($(t).css({top:S.top-(x.height-100)}),$(t).addClass("bottom")):($(t).css({top:S.top}),$(t).removeClass("bottom")),$(t).show()}function eventMouseout(){$("#calpopup").hide(),$("#wcal").data("popup")=="#calpopup"&&$("#wcal").removeData("popup")}function eventClick(e){if(e.shiftKey){var t=$(".highlighted");t.length>0&&($(t[0]).parents("#caltodo").length>0&&$(e.target).parents("#caltodo").length==0&&$(".highlighted").toggleClass("highlighted"),$(t[0]).parents("#wcal").length>0&&$(e.target).parents("#wcal").length==0&&$(".highlighted").toggleClass("highlighted")),$(e.target).toggleClass("highlighted");return}$("#calpopupe").remove(),$("#wcal").removeData("popup"),e.stopPropagation(),$("#wcal").data("dragging")!=undefined&&$("#wcal").removeData("dragging"),eventHover(e);var n=$($("#wcal").data("popup")),r=$($(n).data("event")).attr("href"),i=$(document).caldav("calendars"),s=$($(n).data("event")).attr("class").match(/calendar(\d+)/)[1],o=$($(n).data("event")).data("ics"),u=!0;i[s]!=undefined&&/(^| )2,/.test($.fn.caldav.serverSupports)&&(u=$(document).caldav("lock",r,600,function(e){e!==!0&&$("#calpopupe .done,#calpopupe .delete").addClass("warning")})),$("#calpopup").clone(!0).attr("id","calpopupe").removeClass("left right bottom").appendTo("#calwrap"),$("#wcal").data("popup","#calpopupe"),$("#calpopupe").data("overflow",0),$("#calpopup").hide();var a=$("#calpopupe").innerHeight()-$("#calpopupe").height();$("#calpopupe > ul").outerHeight()+a*1.5+10>$("#calpopupe").height()&&$("#calpopupe").height($("#calpopupe > ul").outerHeight()+a*1.5+10),$("#calpopupe").data("fields",fieldNames),$("#calpopupe").css("opacity",1);if(i[s]!=undefined){$("#calpopupe > ul").append('<li><div class="completionWrapper"><div class="completion"></div></div><span class="add button dropdown">'+ui.add+"</span></li>"),$("#calpopupe .value").focus(fieldClick),$("#calpopupe .add").click(addField),$("#calpopupe").append('<div class="button delete" tabindex="0">'+ui["delete"]+"</div>"),$("#calpopupe").append('<div class="button done" tabindex="0">'+ui.done+"</div>");if(o.vcalendar[o.TYPE].attendee&&(i[s].principal==$.fn.caldav.data.myPrincipal||i[s].perms.all||i[s].perms["schedule-send"]||i[s].perms["schedule-send-reply"])){var f=$.fn.caldav.principals[$.fn.caldav.principalMap[$.fn.caldav.data.myPrincipal]].email;if("mailto:"+f!=o.vcalendar[o.TYPE].organizer.VALUE){var l=String($("#calpopupe .attendee.me").data("partstat")).toLowerCase();$("#calpopupe").append('<div class="smallschedulebuttons group '+l+'"><div class="button accept" tabindex="0">'+ui.accept+'</div><div class="button maybe" tabindex="0">'+ui.maybe+'</div><div class="button decline" tabindex="0">'+ui.decline+"</div></div>"),$("#calpopupe .smallschedulebuttons .button").bind("click keypress",inviteButtonClick)}}debug&&($("#calpopupe").append('<div class="button tweak" style="position:absolute;bottom:5px;left:70px; width:40px;" tabindex="0">tweak</div>'),$("#calpopupe .tweak").bind("click",function(e){var t=$($("#wcal").data("popup")),n=i[s],r=$('<textarea id="eventsource" style="position:absolute;top:0;left:0;background:grey; overflow-y: auto; white-space: pre;" cols="80" rows="30" contenteditable="true" ></textarea>'),o=$('<div id="eventsave" style="position:absolute;bottom:25px;left:70px; width:40px;" class="button">save</div>'),u=$($(t).data("event")).data("ics");$(r).text(u.PARENT.printiCal()),$(o).click(function(e){var t=(new iCal($("#eventsource").val())).ics[0],n=$($("#wcal").data("popup")),r=$($(n).data("event")).attr("href"),i=$($(n).data("event")).attr("class").match(/calendar(\d+)/)[1];$('[href="'+r+'"]').fadeOut("fast",function(){$(n).remove()}),$(document).caldav("putEvent",{url:r},t.PARENT.printiCal()),insertEvent(r,t,i,$("#wcal").data("firstweek"),$("#wcal").data("lastweek"))}),$("#calpopupe").append(r),$("#calpopupe").append(o)})),$("#calpopupe .done").bind("click keypress",function(e){if(e.keyCode>0)if(e.keyCode!=32||e.keyCode!=13)return;eventEdited()==1&&($(document).unbind("click",$("#wcal").data("edit_click")),$(document).unbind("keydown",$("#wcal").data("edit_keyup")))}),$("#calpopupe .delete").bind("click keypress",function(e){if(e.keyCode>0)if(e.keyCode!=32||e.keyCode!=13)return;var t=$($("#calpopupe").data("event")),n=$(t).attr("class").match(/calendar(\d+)/)[1],r=$(t).attr("href"),i=$(document).caldav("calendars");eventDeleted(e),$(document).unbind("click",$("#wcal").data("edit_click")),$(document).unbind("keydown",$("#wcal").data("edit_keyup")),$("#calpopupe").hide(),$("#calpopupe").remove(),$("#wcal").removeData("clicked")}),$("#calpopupe .value,.evheader,#calpopupe .action,#calpopupe .length").attr("contentEditable",!0),$("#calpopupe .value,.evheader").attr("spellcheck","true"),$("#calpopupe .value:first").focus()}draggable($("#calpopupe")),$("#calpopupe").show(),$("#wcal").data("clicked",e.target),$(document).click($("#wcal").data("edit_click")),$(document).keyup($("#wcal").data("edit_keyup"))}function urlHover(e){$(e).hover(function(e){if($(".value",e.target).text().match(/^https?:\/\/.+/))return $("a",e.target).remove(),$(".value",e.target).after('<a href="'+encodeURI($(".value",e.target).text())+'" class="link" target="_newtab">'+(ui.open?ui.open:"open")+"</a>"),e.stopPropagation(),!0},function(e){$("a",e.target).remove()})}function expandText(e){return"<p>"+String(e).split("\n").join("</p><p>")+"</p>"}function unexpandText(e){var t="";return $("p",e).length>0?$("p",e).each(function(e,n){t+=$(n).text()+"\n"}):t=$(e).text(),t}function buildOptions(e){var t={target:undefined,options:undefined,text:valueNames,none:!0,spaceSelects:!0,search:!1,removeOnEscape:!0,multiselect:!1,callback:undefined};for(var n in t)typeof e[n]!="undefined"&&(t[n]=e[n]);var r=$(t.target).text(),i="completion";if(t.multiselect!==!1){var s=new RegExp("\\s*"+t.multiselect+"\\s*"),o=String($.trim(r)).split(s);i+=" multiselect"}var u='<div class="completionWrapper"><div class="'+i+'">';t.none!==!1&&(u=u+'<div class="remove" text="'+valueNames.NONE+'"></div>');var a=t.text;if(t.multiselect===!1)for(var f=0;f<t.options.length;f++)u=u+"<div"+(a[t.options[f]]==r?' class="selected" ':"")+">"+a[t.options[f]]+"</div>";else for(var f=0;f<t.options.length;f++)u=u+"<div"+(o.indexOf(a[t.options[f]])>-1?' class="selected" ':"")+">"+a[t.options[f]]+"</div>";u+="</div></div>";var l=$(u);return $(l).children().click(function(e){if(t.multiselect!==!1){if($(e.target).hasClass("remove"))$(e.target).parent().children().removeClass("selected"),$(e.target).parent().parent().next().text("");else{$(e.target).toggleClass("selected");var n=[];$(e.target).parent().children().each(function(e){$(this).hasClass("selected")&&n.push($(this).text())}),$(e.target).parent().parent().next().text(n.join(t.multiselect))}return typeof t.callback=="function"&&t.callback($(e.target).parent().parent().next()),!0}return $(e.target).parent().parent().next().text($(e.target).text()),t.multiselect===!1&&$(e.target).parent().parent().fadeOut(function(){$(this).remove(),popupOverflowAuto(),$(e.target).parent().parent().next().unbind("blur keydown")}),typeof t.callback=="function"&&t.callback($(e.target).parent().parent().next()),!1}),$(t.target).bind("keydown",function(e){e.spaceSelects=t.spaceSelects,e.search=t.search,e.removeOnEscape=t.removeOnEscape;var n=keyboardSelector(e);if(n=="cancel")return $(this).prev().fadeOut(function(){$(this).remove(),popupOverflowAuto(),$(this).unbind("blur keydown")}),$("#wcal").data("eatCancel",!0),e.stopPropagation(),!1;if($(n).length==1){if(t.multiselect===!1)$(this).text($(n).text()),$(this).prev().fadeOut(function(){$(this).remove(),popupOverflowAuto(),$(this).unbind("blur keydown")});else if($(n).hasClass("remove"))$(n).parent().children().removeClass("selected"),$(n).parent().parent().next().text("");else{$(n).toggleClass("selected");var r=[];$(n).parent().children().each(function(e){$(this).hasClass("selected")&&r.push($(this).text())}),$(n).parent().parent().next().text(r.join(t.multiselect))}typeof t.callback=="function"&&t.callback($(evt.target).parent().parent().next());var i=e.which==9;return i}return n},!1),$(l).css({top:$(t.target).position().top,left:$(t.target).position().left,"margin-left":"2em"}),$(t.target).bind("blur",function(e){$(e.target).prev().fadeOut(function(){$(this).remove(),popupOverflowAuto()}),$(this).unbind("blur keydown")}),l}function fieldClick(e){var t=$($("#wcal").data("popup")),n=$($(t).data("event")).data("ics"),r=$(e.target).prev().text();for(var i in fieldNames)if(fieldNames[i]==r)break;if(n.PARENT.fields[i]&&n.PARENT.fields[i].values&&n.PARENT.fields[i].values[n.TYPE]&&n.PARENT.fields[i].values[n.TYPE].length>0){var s=buildOptions({target:e.target,options:n.PARENT.fields[i].values[n.TYPE]});popupOverflowVisi(),$(e.target).before(s)}}function addField(e){if($(this).prev().children(".completion").children().length>0){$(this).prev().children(".completion").empty();return}$(e.target).focus();var t=$(e.target).position();$(e.target).prev().css({top:t.top-$(e.target).height()*10,left:t.left+$(e.target).outerWidth()});var n=$($("#wcal").data("popup")),r=$($(n).data("event")).attr("class"),i=$($(n).data("event")).data("ics"),s=$(".label",n),o=[],u={};for(var a in fieldNames){u[fieldNames[a]]=a;var f=$(".label:contains("+fieldNames[a]+")",n);for(var l=0;l<f.length;l++)$(f[l]).text()==fieldNames[a]&&o.push(a)}var c=i.TYPE.toLowerCase(),h=$.extend(!0,{},i.PARENT.fields);h.valarm={max:-1,visible:!0};var p=i.PARENT.components[c].optional.slice();p.push("valarm"),/calendarserver-private-comments/.test($.fn.caldav.serverSupports)&&p.push("x-calendarserver-private-comment"),/calendarserver-private-events/.test($.fn.caldav.serverSupports)&&p.push("x-calendarserver-access");var d=[];for(var l in p){var a=p[l];if(!h[a].visible)continue;h[a].max==-1&&d.push(a),h[a].max==1&&o.indexOf(a)==-1&&d.push(a)}if(d.length<1)return;$(n).css({overflow:"visible"}),d.sort(function(e,t){return fieldNames[e]>fieldNames[t]?1:fieldNames[e]<fieldNames[t]?-1:0});var v="";for(var a=0;a<d.length;a++)v=v+'<div data-field="'+d[a]+'" >'+fieldNames[d[a]]+"</div>";$(this).prev().children(".completion").append(v),$(this).prev().children(".completion").children().click(function(e){var t=$('<li><span class="label" data-field="'+$(this).text()+'">'+$(this).text()+'</span><span class="value" contenteditable="true" spellcheck="true"></span></li>');if($(this).text()==ui.alarm){var n=$('<span><span class="alarm"><span class="action" contenteditable="true">'+valueNames.AUDIO+'</span><span class="value" contenteditable="true">15</span><span class="length" contenteditable="true" >'+durations["minutes before"]+'</span><span class="related" contenteditable="true" >'+valueNames.START+"</span></span></span>").append($('<span class="plus">'+ui.add+"</span>").click(function(){$(this).before('<span class="alarm"><span class="action" contenteditable="true">'+valueNames.AUDIO+'</span><span class="value" contenteditable="true">15</span><span class="length" contenteditable="true" >'+durations["minutes before"]+'</span><span class="related" contenteditable="true" >'+valueNames.START+"</span></span>"),$(".action,.length,.related",$(this).prev()).bind("click, focus",alarmFieldClick)}));$(".value",t).replaceWith(n),$(".action,.length,.related",t).bind("click, focus",alarmFieldClick);var r=$(this).closest("li").before(t)}else if($(this).text()==fieldNames.organizer)var i=$.fn.caldav.principals[$.fn.caldav.principalMap[$.fn.caldav.data.myPrincipal]].email?"mailto:"+$.fn.caldav.principals[$.fn.caldav.principalMap[$.fn.caldav.data.myPrincipal]].email:$.fn.caldav.principals[$.fn.caldav.principalMap[$.fn.caldav.data.myPrincipal]].href,t=$('<li><span class="label" data-field="'+fieldNames.organizer+'" >'+fieldNames.organizer+'</span><span class="value" contenteditable="true" data-cn="'+$.fn.caldav.principals[$.fn.caldav.principalMap[$.fn.caldav.data.myPrincipal]].name+'" data-value="'+i+'" spellcheck="true">'+$.fn.caldav.principals[$.fn.caldav.principalMap[$.fn.caldav.data.myPrincipal]].name+"</span></li>"),r=$(this).closest("li").before(t);else if($(this).text()==fieldNames.attendee){var i=$.fn.caldav.principals[$.fn.caldav.principalMap[$.fn.caldav.data.myPrincipal]].email?"mailto:"+$.fn.caldav.principals[$.fn.caldav.principalMap[$.fn.caldav.data.myPrincipal]].email:$.fn.caldav.principals[$.fn.caldav.principalMap[$.fn.caldav.data.myPrincipal]].href,t=$('<li><span class="label" data-field="'+fieldNames.organizer+'" >'+fieldNames.organizer+'</span><span class="value" contenteditable="true" data-cn="'+$.fn.caldav.principals[$.fn.caldav.principalMap[$.fn.caldav.data.myPrincipal]].name+'" data-value="'+i+'" spellcheck="true">'+$.fn.caldav.principals[$.fn.caldav.principalMap[$.fn.caldav.data.myPrincipal]].name+"</span></li>"),r=$(this).closest("li").before(t),t=$('<li><span class="label" data-field="'+fieldNames.attendee+'" >'+$(this).text()+'</span><span class="value" contenteditable="true" spellcheck="true"></span></li>');$(".value",t).replaceWith(printAttendee());var r=$(this).closest("li").before(t)}else if($(this).text()==fieldNames.rrule){var s=recurrence("FREQ=YEARLY");$(".value",t).replaceWith(s.editRecurrence());var r=$(this).closest("li").before(t)}else{$(".value",t).focus(fieldClick),iCal().fields[u[$(this).text()]].type=="date"&&$(".value",t).bind("mousewheel DOMMouseScroll",dateScroll);var r=$(this).closest("li").before(t);$(r).prev().children(".value").focus()}return $(e.target).parent().empty(),popupOverflowAuto(),!1}),$(e.target).keydown(function(t){t.spaceSelects=!0,t.search=!1;var n=keyboardSelector(t);if(n=="cancel")return $(e.target).prev().empty(),popupOverflowAuto(),!1;if($(n).length==1){var r=$('<li><span class="label">'+$(n).text()+'</span><span class="value" contenteditable="true" spellcheck="true"></span></li>');if($(this).text()==ui.alarm){var i=$("<span></span>").append($('<span class="plus">'+ui.add+"</span>").click(function(){$(this).before('<span class="alarm"><span class="action" contenteditable="true">'+valueNames.AUDIO+'</span><span class="value" contenteditable="true">15</span><span class="length" contenteditable="true" >'+durations["minutes before"]+'</span><span class="related" contenteditable="true" >'+valueNames.START+"</span></span>")}));$(".value",r).replaceWith(i),$(".value",r).bind("mousewheel DOMMouseScroll",dateScroll);var s=$(this).closest("li").before(r);$(".action,.length,.related",s).bind("click, focus",alarmFieldClick)}else if($(this).text()==fieldNames.organizer)var o=$.fn.caldav.principals[$.fn.caldav.principalMap[$.fn.caldav.data.myPrincipal]].email?"mailto:"+$.fn.caldav.principals[$.fn.caldav.principalMap[$.fn.caldav.data.myPrincipal]].email:$.fn.caldav.principals[$.fn.caldav.principalMap[$.fn.caldav.data.myPrincipal]].href,r=$('<li><span class="label" data-field="'+fieldNames.organizer+'" >'+fieldNames.organizer+'</span><span class="value" contenteditable="true" data-cn="'+$.fn.caldav.principals[$.fn.caldav.principalMap[$.fn.caldav.data.myPrincipal]].name+'" data-value="'+o+'" spellcheck="true">'+$.fn.caldav.principals[$.fn.caldav.principalMap[$.fn.caldav.data.myPrincipal]].name+"</span></li>"),s=$(this).closest("li").before(r);else if($(this).text()==fieldNames.attendee){var o=$.fn.caldav.principals[$.fn.caldav.principalMap[$.fn.caldav.data.myPrincipal]].email?"mailto:"+$.fn.caldav.principals[$.fn.caldav.principalMap[$.fn.caldav.data.myPrincipal]].email:$.fn.caldav.principals[$.fn.caldav.principalMap[$.fn.caldav.data.myPrincipal]].href,r=$('<li><span class="label" data-field="'+fieldNames.organizer+'" >'+fieldNames.organizer+'</span><span class="value" contenteditable="true" data-cn="'+$.fn.caldav.principals[$.fn.caldav.principalMap[$.fn.caldav.data.myPrincipal]].name+'" data-value="'+o+'" spellcheck="true">'+$.fn.caldav.principals[$.fn.caldav.principalMap[$.fn.caldav.data.myPrincipal]].name+"</span></li>"),s=$(this).closest("li").before(r),r=$('<li><span class="label" data-field="'+fieldNames.attendee+'" >'+$(this).text()+'</span><span class="value" contenteditable="true" spellcheck="true"></span></li>');$(".value",r).replaceWith(printAttendee());var s=$(this).closest("li").before(r)}else if($(this).text()==fieldNames.rrule){var a=recurrence("FREQ=YEARLY");$(".value",r).replaceWith(a.editRecurrence())}else{$(".value",r).focus(fieldClick),iCal().fields[u[$(this).text()]].type=="date"&&$(".value",r).bind("mousewheel DOMMouseScroll",dateScroll);var s=$(this).closest("li").before(r);$(s).prev().children(".value").focus()}return $(n).parent().empty(),popupOverflowAuto(),!1}return n})}function printAttendee(e){var t=$('<span class="value"><span>'),n=[],r=[];e==undefined?(n.push("mailto:"+$.fn.caldav.principals[$.fn.caldav.principalMap[$.fn.caldav.data.myPrincipal]].email),r.push({partstat:"ACCEPTED",cn:$.fn.caldav.principals[$.fn.caldav.principalMap[$.fn.caldav.data.myPrincipal]].name,rsvp:"FALSE",email:$.fn.caldav.principals[$.fn.caldav.principalMap[$.fn.caldav.data.myPrincipal]].email})):e.VALUES?(n=e.VALUES,r=e.PROPS):(n.push(e.VALUE),r.push(e.PROP));for(var i=0;i<n.length;i++)r[i]!=undefined&&$(t).append('<span class="value attendee '+String(r[i].partstat+"").toLowerCase()+'" title="'+String(r[i].email?r[i].email:n[i].replace(/^mailto:/i,"")+"")+'" data-value="'+n[i]+'" data-original="'+n[i]+'" data-cn="'+String(r[i].cn+"")+'" data-email="'+String(r[i].email+"")+'" data-partstat="'+String(r[i].partstat+"")+'" data-schedstatus="'+String(r[i]["schedule-status"]+"")+'" data-rsvp="'+String(r[i].rsvp+"")+'" contenteditable="true" >'+(r[i].cn?r[i].cn:n[i].replace(/^mailto:/i,"")).replace(/^"(.*)"$/,"$1")+"</span>");$('[data-email="'+$.fn.caldav.principals[$.fn.caldav.principalMap[$.fn.caldav.data.myPrincipal]].email+'"]',t).addClass("me");var s=$('<span class="plus">'+ui.add+"</span>").click(function(){var e=$('<span class="value attendee needs-action" contenteditable="true" ></span>');$(e).bind("keydown",completePrincipal),$(this).before(e),$(this).prev().focus()}),o=$('<span class="plus">'+ui.available+"</span>").click(function(e){var t=$('<div id="scheduling" ><span id="resolve" class="button">'+ui.resolve+'</span><span class="close button">'+ui.done+'</span><ul id="schedusers"></ul><ul id="schedtime"></ul></div>');$(".close",t).click(function(e){return $("#scheduling").remove(),!1});var n=$($("#calpopupe").data("event")).data("ics"),r,i=$(e.target).parent().children(".attendee");for(var s=0;s<i.length;s++){var o=$.trim($(i[s]).text());if(o!=""&&$.trim($(i[s]).data("email"))!=""){$("#schedusers",t).append('<li class="suser'+s+'" user="'+o+'">'+o+"</li>");var u;u="mailto:"+$.trim($(i[s]).data("email")).replace(/^mailto:/i,"").replace(/^"(.*)"$/,"$1"),r==undefined?r=n.PARENT.newField("attendee",u,{cn:o}):r.UPDATE(u,{cn:o})}}var a=Zero().parsePrettyDate($("#calpopupe .ESTART + .value").text()).add("h",-7),f=new Date(a.getTime()),l=new Date(a.getTime());l=l.add("h",102);var c="",h=[];for(var s=0;s<96;s++,a.add("h",1)){c=c+'<li class="sday'+a.getUTCDate()+" shour"+a.getUTCHours()+'" data-month="'+months[a.getUTCMonth()]+'" data-date="'+a.getUTCDate()+'" data-hour="'+a.getUTCHours()+'" data-time="'+a.DateString()+'"></li>';for(var p=s*4;p<(s+1)*4;p++)h[p]=0}$("#schedtime",t).append(c),$("#schedtime",t).data("begin",f),$("#schedtime",t).data("vector",h),$("#resolve",t).click(function(e){var n=$("#schedtime",t).data("vector"),r=$("#schedtime",t).data("begin"),i=Zero().parsePrettyDate($("#calpopupe .ESTART + .value").text()),s=Zero().parsePrettyDate($("#calpopupe .EEND + .value").text()),o=parseInt((i-r)/6e4/15),u=parseInt((s-i)/6e4/15);for(var a=o;a<n.length-u;a++)if(n.slice(a,a+u).indexOf(1)==-1)break;if(a<n.length-u){var f=new Date(i.getTime()+(a-o)*15*6e4),l=$("#schedtime li.sday"+f.getUTCDate()+".shour"+f.getUTCHours());$("#schedtime .sched").detach().appendTo(l),$("#schedtime .sched").removeClass("start0 start1 start2 start3"),a%4!=0&&$("#schedtime .sched").addClass("start"+a%4);var c=new Date(f.getTime()+(s.getTime()-i.getTime()));console.log(r,s,c),$("#calpopupe .ESTART + .value").text(f.prettyDate()),$("#calpopupe .EEND + .value").text(c.prettyDate()),$("#schedtime .sched").removeClass("conflict")}}),$("#schedtime li",t).click(function(e){if(e.currentTarget.nodeName!="LI")return;var t=Zero().parsePrettyDate($("#calpopupe .ESTART + .value").text()),n=Zero().parsePrettyDate($("#calpopupe .EEND + .value").text()),r=$(e.currentTarget),i=Math.round(e.offsetX/$(e.currentTarget).innerWidth()*3);for(var s=0;s<parseInt(i/4);s++)r=$(r).next();var o=Math.round((new Date(t)).getUTCMinutes()/15);i!=o&&$("#schedtime").data("exactpositioning")&&(t.setUTCMinutes(15*i%4),o=i);var u=Zero().parseDate($(r).data("time")),a=u.getTime()-t.getTime();console.log(f,l,a,i),$("#calpopupe .ESTART + .value").text((new Date(t.getTime()+a)).prettyDate()),$("#calpopupe .EEND + .value").text((new Date(n.getTime()+a)).prettyDate()),$("#schedtime .sched").detach().appendTo(r),$("#schedtime .sched").removeClass("start0 start1 start2 start3");var c=$("#schedtime").data("fb");t=t.getTime()+a,n=n.getTime()+a,$("#schedtime .sched").addClass(o),$("#schedtime .sched").removeClass("conflict");for(var s=0;s<c.length;s++)(c[s].start>=t&&c[s].end<=t||c[s].start>=n&&c[s].end<=n||c[s].start>=t&&c[s].end<=n||c[s].start<=t&&c[s].end>=n)&&$("#schedtime .sched").addClass("conflict")});var d=Zero().parsePrettyDate($("#calpopupe .ESTART + .value").text()),v=Zero().parsePrettyDate($("#calpopupe .EEND + .value").text());len=parseInt((v.getTime()-d.getTime())*4/36e5)/4;var m="start"+Math.round(d.getUTCMinutes()/15);$("#schedtime li.sday"+d.getUTCDate()+".shour"+d.getUTCHours(),t).append('<span class="sched '+m+'" data-hours="'+len+'"></span>');var g=new iCal(n.PARENT.icsTemplateVfreebusy),y=g.ics[0];y.vcalendar.vfreebusy.uid=g.newField("uid",guid()),y.vcalendar.vfreebusy.dtstamp.UPDATE(new Date),y.vcalendar.vfreebusy.dtstart.UPDATE(f),y.vcalendar.vfreebusy.dtend.UPDATE(l),y.vcalendar.vfreebusy.organizer=g.newField("organizer",$.fn.caldav.data.myPrincipal,{cn:$.fn.caldav.principals[$.fn.caldav.principalMap[$.fn.caldav.data.myPrincipal]].name}),y.vcalendar.vfreebusy.attendee=r;var b=String(g);$.POST({url:$.fn.caldav.outboxMap[$.fn.caldav.data.myPrincipal],data:b,username:$.fn.caldav.options.username,password:$.fn.caldav.options.password,contentType:"text/calendar",complete:function(e,t){$.ajaxSetup.headers={};if(t=="success"){var n=$("response",e.responseXML),r=$($("#calpopupe").data("event")).data("ics"),i=Zero().parsePrettyDate($("#calpopupe .ESTART + .value").text()).getTime(),s=Zero().parsePrettyDate($("#calpopupe .EEND + .value").text()).getTime(),o=[],u=$("#schedtime").data("vector"),a=$("#schedtime").data("begin");for(var f=0;f<n.length;f++){var l=$("href",n[f]).text(),c=$("request-status",n[f]).text(),h=$("calendar-data",n[f]).text();if(/2.0/.test(c)){var p=new iCal(h),d=p.ics[0],v=$('#schedusers li[user="'+d.vcalendar[d.TYPE].attendee.PROP.cn+'"]').attr("class");if(d.vcalendar[d.TYPE]["freebusy"]==undefined)continue;var m=[],g=d.vcalendar[d.TYPE].freebusy.DATA;for(var y in g)/^FREE/.test(y)||(m=m.concat(g[y]));for(var b=0;b<m.length;b++){var w=m[b].start,E=m[b].end,S="start"+Math.round(w.getUTCMinutes()/15);o.push(m[b]),$("#schedtime .sday"+w.getUTCDate()+".shour"+w.getUTCHours()).append('<span class="'+v+" "+S+" "+m[b].type+'" data-hours="'+parseInt((E.getTime()-w.getTime())*4/36e5)/4+'"></span>'),(w>=i&&E<=i||w>=s&&E<=s||w>=i&&E<=s||w<=i&&E>=s)&&$("#schedtime .sched").addClass("conflict");var t=parseInt((w-a)/6e4/15),x=parseInt((E-a)/6e4/15);for(var T=t;T<x;T++)u[T]=1}debug&&console.log(d)}else $("#schedtime ."+v).addClass("warning")}$("#schedtime").data("fb",o),$("#schedtime").data("vector",u)}}}),popupOverflowVisi(),$(this).after(t)});return $(".attendee").die("focus"),$(".attendee").die("blur"),$(".attendee").live("focus",attendeeFocus),$(".attendee",t).bind("keydown",completePrincipal),$(".attendee").live("blur",function(e){popupOverflowAuto(),$(".completionWrapper",$(e.target).parent()).remove();var t=$(e.target).text(),n=t.split(" "),r,i;for(var s=0;s<n.length;s++)/@/.test(n[s])&&(i=String(n[s]).replace(/^mailto:/,""),i=i.replace(/[<>"']/g,""),n.splice(s,1));r=n.join(" "),$(e.target).data("email",i),$(e.target).text(r)}),$(t).append(s),/calendar-auto-schedule/.test($.fn.caldav.serverSupports)&&$.fn.caldav.outboxMap[$.fn.caldav.data.myPrincipal]&&$(t).append(o),t}function attendeeFocus(e){popupOverflowVisi();var t=$(e.target).text(),n=$(e.target).data("value");$(".completionWrapper",$(e.target).parent()).remove(),$(e.target).before('<div class="completionWrapper"><div class="completion"></div></div>');if(!n)return;n=n.replace(/^mailto:/,""),t.match(n)||$(e.target).text($.trim(t)+" "+n)}function attendeeEdited(e,t){var n=$(".attendee",e),r=[],i=[],s=!1;t.VALUES?(r=t.VALUES,i=t.PROPS):(r.push(t.VALUE),i.push(t.PROP));if(n.length==0){var o=$.trim($(n[c]).text()).split(" "),u,a;for(var f=0;f<o.length;f++)/@/.test(o[f])&&(a=String(o[f]).replace(/^mailto:/,"").replace(/[<>"']/g,""),o.splice(f,1));a==""&&$(n[c]).data("email")&&(a=$.trim($(n[c]).data("email"))),u=o.join(" ");var l={cn:u,cutype:"INDIVIDUAL",email:a,partstat:$(n[c]).data("partstat"),rsvp:$(n[c]).data("rsvp")};return/calendar-auto-schedule/.test($.fn.caldav.serverSupports)&&(l["schdeule-agent"]="SERVER"),t.UPDATE("mailto:"+a,l),!0}for(var c=0;c<r.length;c++)if($('.value[data-value="'+r[c]+'"]').length==0||i[c]==null&&!/^mailto/.test(r[c]))r.splice(c,1),i.splice(c,1),s=!0;var h="";for(var c=0;c<n.length;c++){var p=$(n[c]).data();i[d]==undefined&&(i[d]={});if(p.value&&r.indexOf(p.value)>-1){var d=r.indexOf(p.value);if($.trim($(n[c]).text())==""){r.splice(d,1),i.splice(d,1),s=!0;continue}i[d]["cn"]!=$.trim($(n[c]).text())&&(s=!0,i[d].cn=$.trim($(n[c]).text())),i[d].email!=$.trim(p.email)&&(i[d].email=$.trim(p.email),r[d]="mailto:"+p.email,s=!0)}else{var o=$.trim($(n[c]).text()).split(" "),u,a="";for(var f=0;f<o.length;f++)/@/.test(o[f])&&(a=String(o[f]).replace(/^mailto:/,"").replace(/[<>"']/g,""),o.splice(f,1));a==""&&$(n[c]).data("email")&&(a=$.trim($(n[c]).data("email")).replace(/^mailto:/,"").replace(/[<>"']/g,"")),u=o.join(" ");var l={cn:u,cutype:"INDIVIDUAL",email:a,partstat:$(n[c]).data("partstat")?$(n[c]).data("partstat"):"NEEDS-ACTION",rsvp:$(n[c]).data("rsvp")?$(n[c]).data("rsvp"):"TRUE"};h=h+", "+u+" <"+a+">",$.fn.caldav.supports["calendar-auto-schedule"]&&a!=$.fn.caldav.principals[$.fn.caldav.principalMap[$.fn.caldav.data.myPrincipal]].email&&(l["schdeule-agent"]="SERVER"),t.UPDATE("mailto:"+a,l),s=!0}}var v=$($("#calpopupe").data("event")).data("ics"),m="mailto:"+h+"?subject="+v.vcalendar[v.TYPE].summary+"&body=ics goes here";return console.log(m),s}function printOrganizer(e){return $('<span class="value" data-cn="'+(e.PROP?e.PROP.cn:"")+'" data-value="'+e.VALUE+'" >'+e.VALUE+"</span>")}function organizerEdited(e,t){typeof t.PROP=="object"?t.PROP.cn=$(e).text():t.PROP={cn:$(e).text()},t.VALUE==undefined&&(t.VALUE=$(e).data("value"))}function printAlarm(e){var t=[];e.action!=undefined?t.push(e):t=e,console.log(t.length+" alarms");var n=$("<span><span>");for(var r in t)if(t[r].trigger!=undefined&&t[r].action.VALUE=="AUDIO"||t[r].action.VALUE=="DISPLAY"){if(t[r].trigger.DURATION!=undefined){var i=t[r].trigger.DURATION;if(i.minutes>0)var s=i.minutes,o="minutes";if(i.hours>0)var s=i.hours,o="hours";if(i.days>0)var s=i.days,o="days";if(i.weeks>0)var s=i.weeks,o="weeks";if(i.negative)var o=o+" before";else var o=o+" after"}if(t[r].trigger.DATE==undefined){if(t[r]["x-apple-proximity"])continue;continue}var s=t[r].trigger.DATE.prettyDate(),o="on date",u="";t[r].description!=undefined&&(u=t[r].description);var a=valueNames.START;t[r].trigger.PROP&&t[r].trigger.PROP.related&&t[r].trigger.PROP.related!=undefined&&(a=valueNames[t[r].trigger.PROP.related]),$(n).append('<span class="alarm"><span class="action" contenteditable="true" data-value="'+t[r].action.VALUE+'" >'+valueNames[t[r].action.VALUE]+'</span><span class="value" contenteditable="true" >'+s+'</span><span class="length" contenteditable="true" >'+durations[o]+"</span>"+'<span class="related" contenteditable="true" >'+a+"</span></span>")}var f=$('<span class="plus">'+ui.add+"</span>").click(function(){var e=$('<span class="alarm"><span class="action" contenteditable="true" >'+valueNames.AUDIO+'</span><span class="value" contenteditable="true" >15</span><span class="length" contenteditable="true" >'+durations["minutes before"]+'</span><span class="related" contenteditable="true" >'+valueNames.START+"</span></span>");$(".action,.length,.related",e).bind("click, focus",alarmFieldClick),$(this).before(e)});return $(n).append(f),$(".action,.length,.related",n).bind("click, focus",alarmFieldClick),n}function alarmEdited(e,t,n){var r=[],i=!1,s=!1;e!=undefined&&e.action!=undefined?r.push(e):e!=undefined&&e.length>1?r=e:i=!0;var o=$("span > span.alarm",t);for(var u=0;u<o.length;u++){if($(".action",o[u]).text()==valueNames["NONE"]){r[u]!=undefined&&(r[u]=undefined);continue}r[u]==undefined&&(r[u]={BEGIN:!0,UPDATED:!0},i=!0);var a=$(".value",o[u]).text(),f=$(".action",o[u]).text(),l=$(".related",o[u]).text(),c=$(".length",o[u]).text();for(var h in valueNames)if(valueNames[h]==f)break;f=h;for(var h in durations)if(durations[h]==c)break;c=h;for(var h in valueNames)if(valueNames[h]==l)break;l=h,r[u].action==undefined?(r[u].action=n.PARENT.newField("action",f),r[u].action.PARENT=r[u],s=!0):r[u].action.VALUE!=f&&(r[u].action.UPDATE(f),s=!0);if(c=="on date")r[u].trigger==undefined||r[u].trigger.DURATION!=undefined?(r[u].trigger=n.PARENT.newField("trigger",Zero().parsePrettyDate(a),{VALUE:"DATE-TIME",RELATED:undefined}),r[u].trigger.PARENT=r[u],s=!0):(r[u].trigger.UPDATE(Zero().parsePrettyDate(a)),s=!0);else{var p=parseDuration(a+" "+c);console.log(p),r[u].trigger==undefined||r[u].trigger.DATE!=undefined?(r[u].trigger=n.PARENT.newField("trigger",p),r[u].trigger.PARENT=r[u],s=!0):r[u].trigger.DURATION!=p&&(r[u].trigger.UPDATE(p),s=!0);if(r[u].trigger.PROP!=undefined){if(!r[u].trigger.PROP.related||r[u].trigger.PROP.related!=l)r[u].trigger.PROP.related=l,s=!0}else r[u].trigger.PROP={related:l},s=!0}}return i&&(s=!0,r.length==1?n.vcalendar[n.TYPE].valarm=r[0]:n.vcalendar[n.TYPE].valarm=r),s}function alarmFieldClick(e){var t={length:["minutes before","hours before","days before","weeks before","minutes after","hours after","days after","weeks after","on date"],action:["AUDIO","DISPLAY"],related:["START","END"]},n=t[$(e.target).attr("class")];if($(e.target).attr("class")=="length")var r=durations;else var r=valueNames;var i=!1;$(e.target).attr("class")=="action"&&(i=!0);var s=$(e.target).text(),o=buildOptions({target:e.target,options:n,text:r,none:i,spaceSelects:!0,search:!1,removeOnEscape:!0});popupOverflowVisi(),$(e.target).before(o)}function eventEdited(e){var t=!1,n=$($("#wcal").data("popup"));if($(n).attr("id")!="calpopupe")return $(n).hide(),!1;var r=$(n).data("event"),i=$($(n).data("event")).attr("class");if(i!=undefined&&i.match(/calendar(\d+)/))i=i.match(/calendar(\d+)/)[1];else{var i=$("#callist li.selected");i.length>0?i=$(i).attr("class").match(/calendar(\d+)/)[1]:i=0}var s=$($(n).data("event")).data("ics");if(!s instanceof Object)return!1;var o="",u=!1;if(s.vcalendar.vevent!=undefined&&$("span:contains("+fieldNames.dtstart+") + span",n).length){debug&&console.log("checking vevent for basic validity");try{var a=(new Date).parsePrettyDate($("span:contains("+fieldNames.dtstart+") + span",n).text())}catch(e){return $("span:contains("+fieldNames.dtstart+") + span",n).css("outline","1px solid red").attr("tabindex",-1).focus(),!1}if($("span:contains("+fieldNames.dtend+") + span",n).length>0){var f=(new Date).parsePrettyDate($("span:contains("+fieldNames.dtend+") + span",n).text());if(a>f)return $("span:contains("+fieldNames.dtend+") + span",n).css("outline","1px solid red").attr("tabindex",-1).focus(),!1}else if($("span:contains("+fieldNames.duration+") + span",n).length>0){var l=parseDuration($("span:contains("+fieldNames.duration+") + span",n).text());if(l.negative)return $("span:contains("+fieldNames.duration+") + span",n).css("outline","1px solid red").attr("tabindex",-1).focus(),!1}}if($("span:contains("+fieldNames.duration+") + span",n).text()==fieldNames.duration)var c={on:"dtstart","all day":"dtend"};else var c={from:"dtstart",to:"dtend",due:"due",completed:"completed"};if(s.vcalendar.vevent!=undefined)var h=s.PARENT.components.vevent.required.concat(s.PARENT.components.vevent.optional).concat(["ESTART","EEND"]),p=new Array,d="vevent";else if(s.vcalendar.vtodo!=undefined)var h=s.PARENT.components.vtodo.required.concat(s.PARENT.components.vtodo.optional),p=new Array,d="vtodo";/calendarserver-private-comments/.test($.fn.caldav.serverSupports)&&h.push("x-calendarserver-private-comment"),/calendarserver-private-events/.test($.fn.caldav.serverSupports)&&h.push("x-calendarserver-access");for(var v in h){var m=fieldNames[h[v]];debug&&console.log("looking for changes in field: "+(m==undefined?h[v]+" no label":m));if(m==undefined)continue;var g=$('span.label[data-field="'+m+'"] + span',n);if($(g).length){var g=$('span.label[data-field="'+m+'"] + span',n)[0],y=$.trim(unexpandText(g));s.vcalendar[d][h[v]]==undefined&&(s.vcalendar[d][h[v]]=s.PARENT.newField(h[v]));if($(g).data("value")==y)continue;if(s.vcalendar[d][h[v]]==y)continue;if($.trim($(g).text())==""){if(s.PARENT.components.vevent.required.indexOf(h[v])>-1)return $(g).css("outline","1px solid red").attr("tabindex",-1).focus(),!1;delete s.vcalendar[d][h[v]]}else if(h[v]=="organizer")organizerEdited($(g),s.vcalendar[d][h[v]]);else if(h[v]=="attendee"){if(attendeeEdited($(g),s.vcalendar[d][h[v]])==0)continue}else h[v]=="rrule"?s.vcalendar[d][h[v]].UPDATE($(g)):s.vcalendar[d][h[v]].UPDATE(y);debug&&console.log("modified prop "+h[v]+" with display name "+m+" from type "+d+"\n  from "+s.vcalendar[d][h[v]]+"\n    to "+$(g).text()),o+=h[v],t=!0}}if(s.vcalendar[d].valarm!=undefined||$("span:contains("+ui.alarm+")").length>0){s.vcalendar[d].valarm==undefined&&(s.vcalendar[d].valarm={BEGIN:!0,UPDATED:!0});var b=alarmEdited(s.vcalendar[d].valarm,$("li > span:contains("+ui.alarm+")",n).parent(),s);b&&(t=!0)}$(r).attr("href")=="+&New Event"&&(t=!0);if(t){var w=$(r).attr("href");s.vcalendar[d].dtstamp.UPDATE(new Date),typeof s.vcalendar[d].sequence!="undefined"?s.vcalendar[d].sequence.VALUE++:s.vcalendar[d].sequence=s.PARENT.newField("SEQUENCE",1);var E=$(document).caldav("calendars");if(w!="+&New Event")$('[href="'+w+'"]').fadeOut("fast",function(){$(this).remove()}),$(document).caldav("putEvent",{url:w},s.PARENT.printiCal());else{w=$(document).caldav("calendars")[i].href+s.vcalendar[d].uid+".ics";var S={url:w};$(document).caldav("putNewEvent",S,s.PARENT.printiCal())}s.TYPE=="vevent"&&insertEvent(w,s,i,$("#wcal").data("firstweek"),$("#wcal").data("lastweek")),s.TYPE=="vtodo"&&insertTodo(w,s,i)}else $(r).attr("href")!="+&New Event"&&$(document).caldav("unlock",$(r).attr("href"));return $("#calpopupe").hide(),$("#wcal").removeData("popup"),$("#wcal").removeData("clicked"),!0}function removeEvent(e){$('[href="'+e+'"]').fadeOut("fast",function(){$(this).remove()})}function eventDeleted(e){var t=!1,n=$($("#wcal").data("clicked"));$(n).length||(n=$("#wcal").data("deleting"));var r=$(n).attr("class").match(/calendar(\d+)/)[1],i=$(n).attr("href"),s=$(document).caldav("calendars"),o=$($("#wcal").data("popup")),u=$(n).data("ics");if(!u instanceof Object)return!1;if(u.vcalendar[u.TYPE].attendee&&e.notify==undefined)$("#wcal").data("deleting",n),$("#wcal").data("drop-question",e),questionBox(notifyquestion[0],notifyquestion[1],function(e){var t=$("#wcal").data("drop-question");$("#wcal").removeData("drop-question");if(e==-1)return $("#wcal").removeData("popup"),$("#wcal").removeData("clicked"),!1;t.notify=e==0?"T":"F",eventDeleted(t)});else if(u.TYPE=="vtodo"){var a={url:i};$(document).caldav("unlock",i),$(document).caldav("delEvent",a)}else if(u.vcalendar.vevent.rrule==undefined&&u.vcalendar.vevent["recurrence-id"]==undefined){var a={url:i};e.notify!=undefined&&(a["Schedule-Reply"]=e.notify),$(document).caldav("unlock",i),$(document).caldav("delEvent",a)}else{if(e.all==undefined){$("#wcal").data("deleting",n),$("#wcal").data("drop-question",e),questionBox(deletequestion[0],deletequestion[1],function(e){var t=$("#wcal").data("drop-question");$("#wcal").removeData("drop-question");if(e==-1)return $("#wcal").removeData("popup"),$("#wcal").removeData("clicked"),!1;t.all=e==0?!0:!1,eventDeleted(t)});return}if(e.all==1){var a={url:i};$(document).caldav("unlock",i),e.notify!=undefined&&(a["Schedule-Reply"]=e.notify),$(document).caldav("delEvent",a),$('[href="'+$(n).attr("href")+'"]').fadeOut("fast",function(){$(this).remove()})}else if(e.all==0){if(u.vcalendar.vevent["recurrence-id"]!=undefined)u.DELETE();else{var f=$.extend(!0,{},u.vcalendar.vevent.dtstart.PROP);u.vcalendar.vevent.exdate==undefined?u.vcalendar.vevent.exdate=u.PARENT.newField("EXDATE",$(n).attr("instance"),f):u.vcalendar.vevent.exdate.UPDATE($(n).attr("instance"),f)}var l=$(n).attr("href");$(n).fadeOut("fast",function(){$(n).remove()});var a={url:l};e.notify!=undefined&&(a["Schedule-Reply"]=e.notify),$(document).caldav("putEvent",a,u.PARENT.printiCal())}else console.log("logic error deleting event")}return $("#wcal").removeData("popup"),$("#wcal").removeData("clicked"),!0}function eventSort(e){var t=$(e).children("li");$(t).detach(),t.sort(function(e,t){return $(e).hasClass("multiday")&&$(t).hasClass("multiday")?Zero().parseDate($(e).attr("instance")).getTime()-Zero().parseDate($(t).attr("instance")).getTime():$(e).hasClass("multiday")?-1:$(t).hasClass("multiday")?1:$(e).attr("order")?$(e).attr("order")-$(t).attr("order"):$(e).data("time")-$(t).data("time")}),$(e).append(t)}function todoSort(e){var t=$(e).children("li"),n=settings.todoSortReverse;$(t).detach();var r=$(e).attr("sort");r=="manual"&&(r="data-time"),/ /.test(r)&&(r=r.replace(/ /,"-")),t.sort(function(e,t){if(n){var i=t;t=e,e=i}return $(e).attr(r)&&$(t).attr(r)?$(e).attr(r)-$(t).attr(r):$(e).attr(r)?1:$(t).attr(r)?-1:0}),$(e).append(t)}function popupOverflowVisi(){var e=Number($($("#wcal").data("popup")).data("overflow"))+1;$($("#wcal").data("popup")).data("overflow",e),$($("#wcal").data("popup")).css({overflow:"visible"})}function popupOverflowAuto(){var e=Number($($("#wcal").data("popup")).data("overflow"))-1;$($("#wcal").data("popup")).data("overflow",e),e==0&&$($("#wcal").data("popup")).css({overflow:"auto"})}function scrollCal(e){var t=$("#wcal").data("firstweek"),n=$("#wcal").data("lastweek"),r=new Date(e.getTime()),i=new Date(e.getTime());$("#wcal").hasClass("weekview")||(r.add("d",-7-parseInt($("#wcal")[0].clientHeight/$(".today")[0].clientHeight/2)*7),i.add("w",parseInt($("#wcal")[0].clientHeight/$(".today")[0].clientHeight/2)+1));var s=new Date(e.getTime());if(r<t){var o=t;s.setDate(s.getDate()-28),$.fn.caldav.eventAverageTime=100;while(o>s)$("#calt").prepend(buildweek(o)),o.setDate(o.getDate()-7);$("#wcal").data("firstweek",o)}if(i>n){var o=n;$.fn.caldav.eventAverageTime=100;while(o<i||$("#day_"+e.LocalDayString()).length==0)$("#calt").append(buildweek(o)),o.setDate(o.getDate()+7);$("#wcal").data("lastweek",o)}var u=$("#day_"+e.DayString());$("#wcal").scrollTop(u[0].offsetTop-($("#wcal")[0].clientHeight/2-$(".today")[0].clientHeight/2));var a=$(".weeknum.currentweek"),f=$("#calt tr:eq("+Math.floor(($("#wcal").scrollTop()+$("#wcal")[0].clientHeight/2)/$("#calt tr:eq(0)")[0].clientHeight)+") .weeknum");$(a).removeClass("currentweek"),$(f).addClass("currentweek");var l=$(".header:last",$(f).parent());if($(l).length<1)return;$("#calmonthname").text($(l).attr("month"));var c=$(l).parent().attr("id").replace(/day_([0-9]{4}).*/,"$1");$("#calyearname").text(c)}function currentWeek(e){var t=$("#wcal").scrollTop(),n=$("#calt tr:eq(0)")[0].clientHeight;if($("#wcal").hasClass("weekview"))var r=Math.round(t/n);else var r=Math.round((t+($("#wcal")[0].clientHeight-n)/2)/n);if(e){var i=new Date,s=$("#wcal tr:eq("+parseInt(r)+") .day:eq(0)").attr("id").replace(/day_/,"");return i.parseDate(s),i}return r}function buildcal(e){e!=undefined?s=e:s=new Date,s.setDate(s.getDate()-7),$(document.body).append('<div id="em" style="postion:absolute; float: left; left: -5000; top: 100; width: 1em; height: 1em; overflow: hidden; background: none; margin:0; padding: 0; border: none; outline: none;">&nbsp;</div>'),calstyle();var t=$('<div id="calwrap"><audio id="calalertsound" src="SweetAlertSound2.wav" type="audio/wave" preload="auto" autobuffer ></audio></div>');$(t).data("tabindex",10),t.nextIndex=function(){var e=$(this).data("tabindex");return e++,$(this).data("tabindex",e),e};var n=$('<div id="calsidebar" ><div class="sidetitle">'+ui.calendar+"</div></div>"),r=$('<ul id="callist"  ></ul>'),i=$(document).caldav("calendars");for(var o=0;o<i.length;o++){if(i[o].principalName==undefined||i[o].principalName=="")continue;var u=$("li:contains("+i[o].principalName+") > ul",r);if(!u.length){if($.fn.caldav.principals[$.fn.caldav.principalMap[i[o].principal]]&&$.fn.caldav.principals[$.fn.caldav.principalMap[i[o].principal]].desc)var a=$.fn.caldav.principals[$.fn.caldav.principalMap[i[o].principal]].desc;else var a="";$('<li class="open"  ><span title="'+a+'" >'+i[o].principalName+'</span><ul data-mailto="'+i[o].mailto+'" data-principal="'+i[o].principal+'" ></ul></li>').appendTo(r);var u=$("li:contains("+i[o].principalName+") > ul",r)}var f=$('<li class="calendar'+o+'" order="'+i[o].order+'" title="'+i[o].desc+'"><input type="checkbox" id="calendar'+o+'" checked="true" /><span >'+i[o].displayName+"</span></li>");if(i[o].perms.write||i[o].perms["write-content"])$(f)[0].addEventListener("drop",calDrop,!0),$(f)[0].addEventListener("dragenter",calDragEnter,!0),$(f)[0].addEventListener("dragover",calDragOver,!0),$(f).click(selectCalendar);$(f).dblclick(editCalendar),$(f).data(i[o]),$(u).append(f),eventSort(u);var l=styles.getStyleSheet("calstyle");settings.calendars!=undefined&&settings.calendars[i[o].href]!=undefined&&settings.calendars[i[o].href]==0?($("#calendar"+o,u).attr("checked",!1),$("#calendar"+o,u).val(!1),l.addRule("#caltodo .event.calendar"+o,"display: none;"),l.addRule("#wcal .day .event.calendar"+o," opacity: 0; display: none; "),l.addRule("#wcal .day .event.calendar"+o+"bg"," opacity: 0; display: none; ")):(l.addRule("#wcal .day .event.calendar"+o," opacity: 1; "),l.addRule("#wcal .day .event.calendar"+o+"bg"," opacity: 1; "))}var c=0;settings["selectedCalendar"]!=undefined&&settings.selectedCalendar.length>2?c=i.map(function(e){return e.href}).indexOf(settings.selectedCalendar):settings["selectedCalendar"]!=undefined&&(c=settings.selectedCalendar),$("#calendar"+c,r).parent().addClass("selected"),$("input",r).change(toggleCalendar),$("li > span",r).click(function(e){if($(this).next().length>0&&$(this).next()[0].nodeName=="UL"&&e.pageX>$(this).offset().left+$(this).width()-$(this).height()*2.25){var t=$(this).next().data("principal"),n=$.fn.caldav.principals[$.fn.caldav.principalMap[t]];return editPrincipal(n),!1}$("li.selected",$(this).parent()).toggleClass("selected"),$(this).parent("li").toggleClass("open"),$(this).parent("li").toggleClass("closed")}),$(n).append(r);var h=$('<div id="invitewrap"><ul id="calinvites"  ><li class="header" >'+ui.invitations+"</li></ul></div>");$(n).append(h),$(n).append('<div class="calfooter group" tabindex="2"><div id="addcalendar" class="button" >'+ui.add+'</div><div id="calsettings" class="button" >'+ui.settings+"</div></div>"),String($(".jqcaldav").data("calproxyurl")).length>1&&($("#calfooter",n).append('<div id="calsubscribe" class="button" >'+ui.subscribe+"</div>"),$("#calsubscribe",n).click(subscribeCalendar)),typeof startTranslating=="function"&&($(".calfooter",n).append('<div id="caltranslate" class="button" >translate</div>'),$("#caltranslate",n).click(startTranslating)),$("#addcalendar",n).click(addCalendar),$("#calsettings",n).click(calSettings),$(t).append(n),$.fn.caldav.reports["sync-collection"]?$(t).append('<div id="calcenter" ><div id="calheader" tabindex="6"><span id="gototoday" class="button" >'+ui.today+'</span><span id="weekview" class="button" >'+ui.week+'</span><span id="refresh" class="button" >&#8635;</span><span id="calmonthname">'+months[s.getMonth()]+'</span><span id="calyearname">'+s.getFullYear()+'</span><span id="logout" class="button" >'+ui.logout+"</span></div>"):$(t).append('<div id="calcenter" ><div id="calheader" tabindex="6"><span id="gototoday" class="button" >'+ui.today+'</span><span id="weekview" class="button" >'+ui.week+'</span><span id="calmonthname">'+months[s.getMonth()]+'</span><span id="calyearname">'+s.getFullYear()+'</span><span id="logout" class="button" >'+ui.logout+"</span></div>"),$("#refresh",t).click(function(){return calendarSync(),!1}),$("#gototoday",t).click(function(){var e=new Date;return scrollCal(e),!1}),$("#logout",t).click(function(){return logoutClicked(),!1}),$("#weekview",t).click(function(){var t=$("#wcal tr:eq(0)")[0].clientHeight;e=currentWeek(!0);if($(this).text()=="Week")$(this).text("Month"),$("#wcal").data("dayHeight",t),$("#wcal").addClass("weekview"),scrollCal(e);else{$(this).text("Week");var n=$("#wcal").data("dayHeight"),r=currentWeek(),i=$("#wcal").scrollTop(),s=Math.round($("#wcal")[0].clientHeight/2-n/2);console.log(n+"dayheight"),$("#wcal").scrollTop(n*r-s),$("#wcal").removeClass("weekview"),$(".currentweek").removeClass("currentweek"),$("#calt tr:eq("+r+") .weeknum").addClass("currentweek")}currentTimeIndicator()}),$("#calmonthname",t).click(function(e){if(e.pageX<$(this).offset().left+$(this).innerWidth()/2)var t=-1;else var t=1;var n=$.inArray($(this).text(),months)+t,r=new Date($("#calyearname").text(),n,7,0,0,0);scrollCal(r)}),$("#calyearname",t).click(function(e){if(e.pageX<$(this).offset().left+$(this).innerWidth()/2)var t=-1;else var t=1;var n=$.inArray($("#calmonthname").text(),months),r=new Date($("#calyearname").text()-0+t,n,7,0,0,0);scrollCal(r)});var p=$('<table id="calh"></table>'),d=$('<thead class="days"></thead>'),v=$("<tr></tr>"),m=settings.weekStart;for(var o=0;o<7;o++)$(v).append("<td>"+weekdays[m]+"</td>"),m++,m>6&&(m=0);$(d).append(v),$(p).append(d),$("#calheader",t).append(p),$("#calheader",t).bind("keyup",function(e){var t=parseInt($.inArray($("#calmonthname").text(),months)),n=parseInt($("#calyearname").text());console.log(n+" "+t+" key "+e.which);switch(e.keyCode){case 37:scrollCal(new Date(n-1,t,1));break;case 38:scrollCal(new Date(n,t-1,1));break;case 39:scrollCal(new Date(n+1,t,1));break;case 40:scrollCal(new Date(n,t+1,1));break;default:return!0}return e.preventDefault(),!1});if(settings.todoShow)var g=settings.todoShow;else var g="COMPLETED,CANCELLED,past due,upcoming,NEEDS-ACTION,IN-PROCESS";settings.todoSortReverse=="false"&&(settings.todoSortReverse=!1);if(settings.todoSort)var y=settings.todoSort;else var y="manual";var b=$('<div id="caltodo" tabindex="8"><div class="sidetitle">'+ui.todos+'<div><span class="button show">'+ui.show+'</span><span class="button sort">'+ui.sort+'</span></div></div><ul show="'+g+'" sort="'+y+'"></ul></div>');$(".button.show",b).click(showVisTodos),$(".button.sort",b).click(showSortTodos),$("ul",b).dblclick(newevent);var w=$("ul",b);$(w).bind("drop",calDrop),$(w).bind("dragenter",calDragEnter),$(w).bind("dragleave",calDragLeave),$(w).bind("dragover",calDragOver),$(t).append(b);var E=$('<div id="wcal" tabindex=7"><div id="caldrop" style="display:none;"><div></div></div></div>');E[0].recur=new Array;var S=settings.start.getLongMinutes(),x=settings.end.getLongMinutes(),T=$('<ul class="hoursbg"></ul>'),e=new Date;e.setUTCMinutes(0);for(var o=S;o<=x;o+=100)e.setUTCHours(o/100),$(T).append('<li class="time'+o+'" data-duration="60">'+e.prettyTime()+"</li>");hw=$('<div class="hourswrapper"></div>').append(T),$(document.body).append(hw),fhw=$(".hourswrapper").clone(!0),hw=$(fhw).clone(!0),$("li",hw).empty(),$(E).data("tabindex",5e3),E.nextIndex=function(){var e=$(this).data("tabindex");return e++,$(this).data("tabindex",e),e},$("#caldrop",E)[0].addEventListener("dragenter",calDragOver,!0),$("#caldrop",E)[0].addEventListener("dragleave",calDragOver,!0),$("#caldrop",E)[0].addEventListener("dragover",calDragOver,!0);var N=$('<div id="calpopup" class="calpopup left" style="display:none;" data-clicked=0 ></div>');$(N).appendTo(t),$(N).clone(!0).attr("id","caldialog").removeClass("left").appendTo(t),$(E).data("edit_click",function(e){var t=$("#wcal").data("popup");if($("#wcal").data("clicked")!=e.target&&$(e.target).parents(t).length<1&&e.target!=$(t)[0]){var n=$($(t).data("event")).attr("href");String(n).length>1&&$.fn.caldav.locks[n]!=undefined&&$(document).caldav("unlock",n),$("#wcal").removeData("clicked"),$("#wcal").removeData("popup"),$(t).fadeOut(),$(document).unbind("click",$("#wcal").data("edit_click")),$(document).unbind("keyup",$("#wcal").data("edit_keyup"))}}),$(E).data("edit_keyup",function(e){if(e.keyCode==27){if($("#wcal").data("eatCancel")){$("#wcal").removeData("eatCancel");return}var t=$("#wcal").data("popup"),n=$($(t).data("event")).attr("href");String(n).length>1&&$.fn.caldav.locks[n]!=undefined&&$(document).caldav("unlock",n),$(t).fadeOut(),$("#wcal").removeData("popup"),$("#wcal").removeData("clicked"),$(document).unbind("keyup",$("#wcal").data("edit_keyup")),$(document).unbind("click",$("#wcal").data("edit_click")),$("#wcal").removeData("popup"),$("#wcal").removeData("clicked")}if(e.keyCode==13&&$(e.target).attr("multiline")!=1)return e.stopPropagation(),!1});var C=new Date(s.toString());C.setDate(C.getDate()-7),$(E).data("firstweek",C);var k=$('<table id="calt"></table>'),L=Math.ceil(window.innerHeight/96)+2;L<3&&(L=3);for(var o=0;o<L;o++)$(k).append(buildweek(s)),s.setDate(s.getDate()+7);$("#day_"+(new Date).LocalDayString(),k).addClass("today"),$(E).data("lastweek",s),$(E).data("created",Date.now()),$(E).scroll(function(){var e=$(this)[0].scrollHeight-15,t=$(this).scrollTop(),n=$(this)[0].clientHeight,r=$(E).data("st");r||$(E).data("st",t);if(Math.abs(t-r)>5){var i=$("#calt tr:eq(0)");if($("#wcal").hasClass("weekview"))var s=$("#calt tr:eq("+Math.round(t/i[0].clientHeight)+") .weeknum");else var s=$("#calt tr:eq("+Math.round((t+(n-i[0].clientHeight)/2)/i[0].clientHeight)+") .weeknum");if($(s).length==0)var s=$("#calt tr:last");var o=$(".weeknum.currentweek");s!=o&&($(o).removeClass("currentweek"),$(s).addClass("currentweek"));var u=$(".header:last",$(s).parent());$("#calmonthname").text($(u).attr("month"));var a=$(u).parent().attr("id").replace(/day_([0-9]{4}).*/,"$1");$("#calyearname").text(a),updateTimeline(),$(E).data("st",t)}if(e-t<=n){var f=$("#wcal").data("lastweek");for(var l=1;l<3;l++)$("#calt").append(buildweek(f)),f.setDate(f.getDate()+7);$("#wcal").data("lastweek",f)}else if(t<45&&r){var f=$("#wcal").data("firstweek"),c=f;for(var l=1;l<3;l++)$("#wcal").scrollTop($("#wcal").scrollTop()+$("#calt tr:first")[0].clientHeight),$("#calt").prepend(buildweek(f)),f.setDate(f.getDate()-7);$("#wcal").data("firstweek",f)}}),$(E).append(k),$("#calcenter",t).append(buildtimeline()),$("#calcenter",t).append(E),$(".timeline li",t).click(function(e){scrollCal($(this).parents(".timeline").data("date"))});for(var o=0;o<i.length;o++)i[o].url=String(i[o].url).replace(/\/\//g,"/"),$(document).caldav("getToDos",{url:i[o].url,username:$.fn.caldav.options.username,password:$.fn.caldav.options.password},o);return currentTimeIndicator(),window.setInterval(currentTimeIndicator,3e3),t}function questionBox(e,t,n){$("#calpopupd").remove();var r=$("#calpopup").clone(!0).attr("id","calpopupd").removeClass("left right bottom"),i=$('<div id="callightbox"></div>').append(r);$(i).appendTo("#calwrap"),$("#wcal").data("popupe","#calpopupd"),$("#calpopup").hide(),$("#calpopupd").empty(),$("#calpopupd").css({opacity:1,height:"auto","min-height":"5em",padding:"1em"}),$("#calpopupd").append('<div class="question">'+e+"</div>");var s=$('<div class="box'+t.length+'"></div>');for(var o=0;o<t.length;o++)$(s).append('<span><div class="button">'+t[o]+"</div></span>");$(".button",s).click(function(){var e=t.indexOf($(this).text());$("#callightbox").remove(),n(e)}),$(document.body).keypress(function(e){if(e.keyCode==27)return $("#callightbox").remove(),n(-1),!1}),$("#calpopupd").append(s),$("#calpopupd").show(),$("#calpopupd").css({position:"absolute",top:window.innerHeight/2-$("#calpopupd").height()/2,left:window.innerWidth/2-$("#calpopupd").width()/2,"z-index":99})}function buildtimeline(){var e=new Date,t=e.getFullYear()-3,n=e.getFullYear()+3,r=function(e){$(".line",this).css({top:e.pageY-$(this).offset().top-$(".line").height()/2}),$(".timeline").data("date")!=undefined&&$(".line").html($(".timeline").data("date").getMonth()+1+"&nbsp;&mdash;")},i=$('<div class="timeline" ></div'),s=$("<ol></ol>");for(var o=t;o<n;o++)$(s).append('<li class="year'+o+'" ><span>&mdash;'+o+"</span></li>");return $(s).append('<li class="current"></li>'),$("li",s).hover(function(e){$(this).addClass("hover200"),$(this).prev().addClass("hover165"),$(this).prev().prev().addClass("hover120"),$(this).next().addClass("hover165a").next().addClass("hover120a"),$(this).mousemove(function(e){var t=Math.round(10.5*((e.pageY-$(this).offset().top)/$(this).height()));$(".timeline").data("date",new Date(Number($(this).text().replace(/[^0-9]/g,"")),t,1))})},function(e){$(this).removeClass("hover200").prev().removeClass("hover165").prev().removeClass("hover120"),$(this).next().removeClass("hover165a").next().removeClass("hover120a"),$(this).unbind("mousemove")}),$(s).hover(function(e){$(".line",this).length==0&&$(this).append('<li class="line"></li>'),$(this).mousemove(r)},function(e){$(this).unbind("mousemove"),$(".line",this).remove(),$(".display",this).empty()}),$(i).append(s),i}function updateTimeline(){var e=$("#wcal").scrollTop(),t=$("#calt tr:eq(0)"),n=$("#calt tr:eq("+Math.floor(e/t[0].clientHeight)+") .header:last");if($(n).length<1)return;var r=$(n).parent().attr("id").replace(/day_([0-9]{4}).*/,"$1"),i=$(n).parent().attr("id").replace(/day_....([0-9]{2}).*/,"$1"),s=$(".timeline li.year"+r);$(s).length>0&&$(".timeline li.current").css("top",$(s).position().top+$(s).height()*(i/12))}function currentTimeIndicator(){var e=new Date,t=e.getHours()*100;if(t>settings.end.getLongMinutes()||t<settings.start.getLongMinutes()&&$("#calcurrenttime").length>0){$("#calcurrenttime").remove();return}$("#calcurrenttime").length==0&&$("#day_"+e.LocalDayString()+" .header").append('<div id="calcurrenttime"></div>');var n=$("#calcurrenttime").closest(".day");$(n).attr("id")!="day_"+e.LocalDayString()&&$("#calcurrenttime").detach().appendTo("#day_"+e.LocalDayString()+" .header"),t+=e.getMinutes()/60*100;var r=(t-settings.start.getLongMinutes())/(settings.end.getLongMinutes()-settings.start.getLongMinutes()),i=$(".eventlist",n).outerHeight()-$(".eventlist",n).innerHeight();$("#calcurrenttime").css("top",i+$(".eventlist",n).innerHeight()*r)}function buildweek(e,t){var n=new Date(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate()-e.getUTCDay()+settings.weekStart),r=new Date(e.getUTCFullYear(),0,1),i=(n.getTime()-r.getTime())/1e3;i/=604800,i=Number(i+1).toFixed(0);var s=$('<tr class="week week'+i+'"></tr>');$(s).append('<td class="weeknum" weeknum="'+i+'"></td>'),$(s).children().append($(fhw).clone(!0));for(var o=0;o<7;o++)$(s).append(buildday(n)),n.setDate(n.getDate()+1);$("ul",s).dblclick(newevent),$("td",s).dblclick(newevent),$.each($("td",s),function(e,t){$(t).bind("drop",calDrop),$(t).bind("dragenter",calDragEnter),$(t).bind("dragleave",calDragLeave),$(t).bind("dragover",calDragOver)}),n=new Date(e.getFullYear(),e.getMonth(),e.getDate()-e.getDay()),n.setTime(n.getTime()-6e4*n.getTimezoneOffset());var u=new Date(e.getFullYear(),e.getMonth(),e.getDate()-e.getDay()+7);u.setTime(u.getTime()-1-6e4*u.getTimezoneOffset());var a=$(document).caldav("calendars");for(var o=0;o<a.length;o++)$(document).caldav("getEvents",{url:a[o].href,username:$.fn.caldav.options.username,password:$.fn.caldav.options.password},n,u,o);return subStart!=null?(subStart>n&&(subStart=n),subEnd<u&&(subEnd=u)):(subStart=n,subEnd=u,window.setTimeout(function(){addSubscribedEvents(-1,subStart,subEnd),subStart=null,subEnd=null},350)),s}function buildday(e){var t=$('<td class="day day'+e.getDate()+" weekday"+e.getDay()+" month"+(e.getMonth()+1)+'" id="day_'+e.LocalDayString()+'" ><div class="header" month="'+months[e.getMonth()]+'" >'+e.getDate()+'</div><ul class="eventlist"></ul></td>');return $(t).prepend($(hw).clone(!0)),t}var cd,hw,fhw,jqcaldavPath,localTimezone,debug=!1,alerts=[],timezoneInit=!1,lang,settings={twentyFour:!0,start:Zero().setUTCHours(6),end:Zero().setUTCHours(22),"update frequency":300,weekStart:0,usealarms:!1,shortAllDay:!1},defaultColors=["#00D","#0D0","#D00","#08D","#0D8","#D80"],months,weekdays,dropquestion,deletequestion,fieldNames,valueNames,subscriptions,perf=[[],[],[],[],[],[],[],[],[]],globalEvents={href:{}};settings.start=new Date(Zero().setUTCHours(6)),settings.end=new Date(Zero().setUTCHours(22));var abbvr={abbv:[],names:[],offsets:[],count:0},defaults={ui:{calendar:"Calendars",todos:"To Do",show:"Show",sort:"Sort",add:"Add",settings:"Settings",subscribe:"Subscribe",today:"Today",week:"Week",month:"Month",start:"Day Starts",end:"Day Ends",twentyFour:"24 Hour Time",username:"Username",password:"Password",go:"go","New Event":"New Event","New Todo":"New Todo","New Journal":"New Journal",alarm:"alarm",done:"Done","delete":"Delete",name:"name",color:"color",description:"description",url:"url",privileges:"privileges",logout:"Logout","new calendar":"New Calendar",yes:"yes",no:"no","logout error":"Error logging out, please CLOSE or RESTART your browser!",owner:"Owner",subscribed:"Subscribed","lock failed":"failed to acquire lock, may not be able to save changes",loading:"working","update frequency":"update frequency",usealarms:"Enable Alarms",listSeparator:",",manual:"manual",bind:"bind",unbind:"unbind",refresh:"refresh",user:"User",path:"Path",source:"Source",available:"Show Availibility",resolve:"Next Availible",inviteFrom:"from",invitations:"Invitations",accept:"accept",maybe:"maybe",decline:"decline",weekStart:"Week Starts on",shortAllDay:"Collapse Events that span Multiple Days","shift click to edit":"Shift-Click to Edit"},months:["January","February","March","April","May","June","July","August","September","October","November","December"],weekdays:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],notifyquestion:["Do you want to notify",["yes","no"]],dropquestion:["Do you want to move",["All occurences","This one occurence"]],deletequestion:["Do you want to delete ",["All occurences","Delete this one occurence"]],deleteCalQuestion:["Are you sure you want to delete ",["No","Delete Calendar"]],fieldNames:{summary:"summary",dtstart:"from",dtend:"to",duration:"duration",rrule:"repeat",rdate:"repeat on",transp:"busy",due:"due",completed:"completed",status:"status",resources:"resources",priority:"priority","percent-complete":"percent complete",location:"location",geo:"coordinates",description:"description",comment:"comment","class":"class",categories:"catagories",attach:"attachment",attendee:"attendee",contact:"contact",organizer:"organizer","related-to":"related to",url:"url",action:"action",repeat:"repeat",trigger:"trigger","last-modified":"last modified","request-status":"request status","x-calendarserver-private-comment":"private comment","x-calendarserver-access":"privacy"},valueNames:{TRANSPARENT:"transparent",OPAQUE:"opaque",TENTATIVE:"tentative",CONFIRMED:"confirmed",CANCELLED:"cancelled","NEEDS-ACTION":"needs-action",COMPLETED:"completed","IN-PROCESS":"in-process",DRAFT:"draft",FINAL:"final",CANCELLED:"cancelled",PUBLIC:"public",PRIVATE:"private",RESTRICTED:"restricted",CONFIDENTIAL:"confidential",AUDIO:"sound",DISPLAY:"message",NONE:"none","past due":"past due",upcoming:"upcoming"},durations:{"minutes before":"minutes before","hours before":"hours before","days before":"days before","weeks before":"weeks before","minutes after":"minutes after","hours after":"hours after","days after":"days after","weeks after":"weeks after","on date":"on date"},recurrenceUI:{YEAR:"year",MONTH:"month",MONTHDAY:"day of month",YEARDAY:"day of year",WEEKNO:"week number",WEEK:"week",DAI:"day",HOUR:"hour",MINUTE:"minute",SECOND:"second",day:"day",time:"time",times:"times",until:"until",every:"every",on:"on",position0:"sixth to last",position1:"fifth to last",position2:"forth to last",position3:"third to last",position4:"second to last",position5:"last",position6:"",position7:"first",position8:"second",position9:"third",position10:"forth",position11:"fifth",position12:"sixth"},privileges:{all:"all",bind:"bind",unbind:"unbind",unlock:"unlock",read:"read",acl:"acl","free-busy":"free-busy",privileges:"privileges",write:"write",content:"content",properties:"properties",acl:"acl","schedule-send":"schedule-send",invite:"invite",reply:"reply",freebusy:"freebusy","schedule-deliver":"schedule-deliver",invite:"invite",reply:"reply","query-freebusy":"query-freebusy"}},ui=defaults.ui,months=defaults.months,weekdays=defaults.weekdays,notifyquestion=defaults.notifyquestion,dropquestion=defaults.dropquestion,deletequestion=defaults.deletequestion,deleteCalQuestion=defaults.deleteCalQuestion,fieldNames=defaults.fieldNames,valueNames=defaults.valueNames,privileges=defaults.privileges,durations=defaults.durations,recurrenceUI=defaults.recurrenceUI;$(document).ready(function(){var e=$(".jqcaldav:eq(0)");jqcaldavPath=$("script[src*=jqcaldav]").attr("src").replace(/jqcaldav.js/,""),lang=String(navigator.language?navigator.language:navigator.userLanguage).toLowerCase(),$.ajax({url:jqcaldavPath+lang+".js",async:!1,dataType:"json",success:function(e){e.ui!=undefined?(ui=$.extend(!0,ui,e.ui),months=$.extend(!0,months,e.months),weekdays=$.extend(!0,weekdays,e.weekdays),notifyquestion=$.extend(!0,notifyquestion,e.notifyquestion),dropquestion=$.extend(!0,dropquestion,e.dropquestion),deletequestion=$.extend(!0,deletequestion,e.deletequestion),fieldNames=$.extend(!0,fieldNames,e.fieldNames),valueNames=$.extend(!0,valueNames,e.valueNames),durations=$.extend(!0,durations,e.durations),recurrenceUI=$.extend(!0,recurrenceUI,e.recurrenceUI),deleteCalQuestion=$.extend(!0,deleteCalQuestion,e.deleteCalQuestion),privileges=$.extend(!0,privileges,e.privileges)):(ui=defaults.ui,months=defaults.months,weekdays=defaults.weekdays,dropquestion=defaults.dropquestion,deletequestion=defaults.deletequestion,fieldNames=defaults.fieldNames,valueNames=defaults.valueNames,recurrenceUI=e.recurrenceUI)},error:function(){$.ajax({url:jqcaldavPath+lang.replace(/-.*/,"").toLowerCase()+".js",async:!1,dataType:"json",success:function(e){e.ui!=undefined?(ui=$.extend(!0,ui,e.ui),months=$.extend(!0,months,e.months),weekdays=$.extend(!0,weekdays,e.weekdays),dropquestion=$.extend(!0,dropquestion,e.dropquestion),deletequestion=$.extend(!0,deletequestion,e.deletequestion),fieldNames=$.extend(!0,fieldNames,e.fieldNames),valueNames=$.extend(!0,valueNames,e.valueNames),durations=$.extend(!0,durations,e.durations),recurrenceUI=$.extend(!0,recurrenceUI,e.recurrenceUI),deleteCalQuestion=$.extend(!0,deleteCalQuestion,e.deleteCalQuestion),privileges=$.extend(!0,privileges,e.privileges)):(ui=defaults.ui,months=defaults.months,weekdays=defaults.weekdays,dropquestion=defaults.dropquestion,deletequestion=defaults.deletequestion,fieldNames=defaults.fieldNames,valueNames=defaults.valueNames,recurrenceUI=e.recurrenceUI)},error:function(){ui=defaults.ui,months=defaults.months,weekdays=defaults.weekdays,dropquestion=defaults.dropquestion,deletequestion=defaults.deletequestion,fieldNames=defaults.fieldNames,valueNames=defaults.valueNames,recurrenceUI=defaults.recurrenceUI}})}}),$(".jqcaldav:eq(0)").data("debug")=="true"&&(debug=!0),$(".jqcaldav:eq(0)").data("wait")!="true"?($(e).append('<form id="cal_login" ><div style="max-width: 40%; min-width: 16em;margin: 30%; margin-top:1em; padding: 2em; -moz-border-radius: 1.5em; -webkit-border-radius: 1.5em; border-radius: 1.5em; -moz-box-shadow: 0px 0px 10px #888; -webkit-box-shadow: 0px 0px 10px #888; box-shadow: 0px 0px 10px #888; "><div id="cal_login_wrapper"><div style="text-align:center"><label for="name" style="width:50%;margin-left: -3em;display: block;float:left;text-align: right; padding-right: 1em;">'+ui.username+'</label><input id="name" size="20" style="float: left;" autofocus /></div><div style="clear: left;text-align:center;"><label for="pass" style="width:50%;margin-left: -3em;'+'display: block;float:left;text-align: right; padding-right: 1em;">'+ui.password+'</label><input id="pass" size="20" type="password" style="float: left;"/></div><div><input id="go" size="20" type="button" value="'+ui.go+'" style="float: left;" /></div><div>&nbsp;</div></div></div></form>'),$("#cal_login input:eq(0)").focus(),$("#cal_login").submit(function(e){return console.log("doinging it"),doit(e),!1}),$("#cal_login #go").click(function(e){return doit(e),!1}),$("#cal_login input").keypress(function(e){if(e.keyCode=="13")return doit(e),!1})):($(e).append('<form id="cal_login" ><input id="name" value="'+$(".jqcaldav:eq(0)").data("username")+'" /><input id="pass" value="'+$(".jqcaldav:eq(0)").data("password")+'" /></form>'),doit()),debug&&console.log(ui),loadTZ(),localTimezone=getTZ(),debug&&console.log("local timezone should be: "+localTimezone.name)}),combine=function(e,t){for(var n in t)e[n]||(e[n]=t[n]);return e};var extdepth=0,resize_delay=0,resize_time=50,eventcount=0,subStart=null,subEnd=null